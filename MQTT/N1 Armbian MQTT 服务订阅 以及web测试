#!/bin/bash

echo "=========================================="
echo "  å·´æ³•äº‘MQTTå®¢æˆ·ç«¯ - å•æ–‡ä»¶éƒ¨ç½²è„šæœ¬"
echo "  æ”¯æŒå¤šä¸»é¢˜è®¢é˜… + JSONæ ¼å¼ + Webç®¡ç†"
echo "=========================================="
echo ""

INSTALL_DIR="/root/mqtt"
LOG_DIR="$INSTALL_DIR/logs"

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    if ! command -v mosquitto_sub >/dev/null 2>&1; then
        echo "âŒ mosquitto_sub æœªå®‰è£…"
        echo "   è¯·å…ˆå®‰è£…: apt-get install mosquitto-clients"
        exit 1
    fi
    
    if ! command -v mpg123 >/dev/null 2>&1; then
        echo "âš ï¸  mpg123 æœªå®‰è£…ï¼ˆå¯é€‰ï¼Œç”¨äºéŸ³ä¹æ’­æ”¾ï¼‰"
        echo "   å®‰è£…å‘½ä»¤: apt-get install mpg123"
    fi
    
    echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
}

# åˆ›å»ºç›®å½•
create_directories() {
    echo ""
    echo "ğŸ“ åˆ›å»ºå®‰è£…ç›®å½•..."
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$LOG_DIR"
    echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ: $INSTALL_DIR"
}

# åˆ›å»ºé…ç½®æ–‡ä»¶
create_config() {
    echo ""
    echo "âš™ï¸  åˆ›å»ºé…ç½®æ–‡ä»¶..."
    
    cat > "$INSTALL_DIR/bemfa_config.conf" << 'EOF'
# å·´æ³•äº‘MQTTé…ç½®æ–‡ä»¶

# MQTTæœåŠ¡å™¨é…ç½®
PRIVATE_KEY="3eb42d69d8b226abe22024d648975f8a"
MQTT_HOST="bemfa.com"
MQTT_PORT="9501"

# ä¸»é¢˜åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ”¯æŒå¤šä¸ªä¸»é¢˜ï¼‰
# æ ¼å¼: TOPICS="ä¸»é¢˜1 ä¸»é¢˜2 ä¸»é¢˜3"
TOPICS="ppt001 ppt002 music001"

# æ—¥å¿—é…ç½®
MAX_LOG_LINES=100

# æ’­æ”¾å™¨é…ç½®
PLAYER_CMD="mpg123"
VOLUME=80
EOF

    echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ: $INSTALL_DIR/bemfa_config.conf"
}

# åˆ›å»ºMQTTè®¢é˜…è„šæœ¬
create_mqtt_script() {
    echo ""
    echo "ğŸ“ åˆ›å»ºMQTTè®¢é˜…è„šæœ¬..."
    
    cat > "$INSTALL_DIR/bemfa_mqtt.sh" << 'EOF'
#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/bemfa_config.conf"
LOG_DIR="$SCRIPT_DIR/logs"
PID_FILE="$LOG_DIR/bemfa_mqtt.pid"
LOG_FILE="$LOG_DIR/messages.log"
SUBSCRIBE_LOG="$LOG_DIR/subscribe.log"
PLAYER_SCRIPT="$SCRIPT_DIR/bemfa_player.sh"

# åŠ è½½é…ç½®
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦è¿è¡Œ
is_running() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# å¯åŠ¨æœåŠ¡
start() {
    if is_running; then
        echo "âœ“ æœåŠ¡å·²åœ¨è¿è¡Œ (PID: $(cat $PID_FILE))"
        return 0
    fi
    
    echo "ğŸš€ å¯åŠ¨å·´æ³•äº‘MQTTè®¢é˜…æœåŠ¡..."
    echo "   ä¸»é¢˜åˆ—è¡¨: $TOPICS"
    
    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    mkdir -p "$LOG_DIR"
    touch "$LOG_FILE"
    touch "$SUBSCRIBE_LOG"
    
    # ä¸ºæ¯ä¸ªä¸»é¢˜å¯åŠ¨è®¢é˜…è¿›ç¨‹
    for TOPIC in $TOPICS; do
        echo "   è®¢é˜…ä¸»é¢˜: $TOPIC"
        
        (
            while true; do
                mosquitto_sub -h "$MQTT_HOST" -p "$MQTT_PORT" \
                    -i "$PRIVATE_KEY" -t "$TOPIC" -v 2>&1 | \
                while IFS= read -r line; do
                    TIMESTAMP="[$(date '+%Y-%m-%d %H:%M:%S')]"
                    
                    # è®°å½•åˆ°æ€»æ—¥å¿—
                    echo "$TIMESTAMP $line" >> "$LOG_FILE"
                    tail -n "$MAX_LOG_LINES" "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"
                    
                    # è®°å½•åˆ°è®¢é˜…æ—¥å¿—
                    echo "$TIMESTAMP $line" >> "$SUBSCRIBE_LOG"
                    tail -n "$MAX_LOG_LINES" "$SUBSCRIBE_LOG" > "${SUBSCRIBE_LOG}.tmp" && mv "${SUBSCRIBE_LOG}.tmp" "$SUBSCRIBE_LOG"
                    
                    # å¤„ç†æ¶ˆæ¯
                    MSG=$(echo "$line" | cut -d' ' -f2-)
                    
                    # è°ƒç”¨æ’­æ”¾å™¨è„šæœ¬å¤„ç†
                    if [ -x "$PLAYER_SCRIPT" ]; then
                        echo "$MSG" | "$PLAYER_SCRIPT" "$TOPIC" >> "$LOG_DIR/player.log" 2>&1 &
                    fi
                done
                
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] è¿æ¥æ–­å¼€($TOPIC),5ç§’åé‡è¿..." >> "$LOG_FILE"
                sleep 5
            done
        ) &
    done
    
    # ä¿å­˜ä¸»è¿›ç¨‹PID
    echo $$ > "$PID_FILE"
    
    sleep 2
    
    if is_running; then
        echo "âœ… å¯åŠ¨æˆåŠŸ!"
        echo "   PIDæ–‡ä»¶: $PID_FILE"
        echo "   æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    else
        echo "âŒ å¯åŠ¨å¤±è´¥"
        rm -f "$PID_FILE"
        return 1
    fi
}

# åœæ­¢æœåŠ¡
stop() {
    if ! is_running; then
        echo "âœ— æœåŠ¡æœªè¿è¡Œ"
        rm -f "$PID_FILE"
        return 1
    fi
    
    echo "â¹ï¸  åœæ­¢å·´æ³•äº‘MQTTè®¢é˜…æœåŠ¡..."
    
    # æ€æ­»æ‰€æœ‰mosquitto_subè¿›ç¨‹
    pkill -f "mosquitto_sub.*$MQTT_HOST"
    
    # åˆ é™¤PIDæ–‡ä»¶
    rm -f "$PID_FILE"
    
    sleep 1
    
    if is_running; then
        echo "âŒ åœæ­¢å¤±è´¥ï¼Œå¼ºåˆ¶ç»“æŸ..."
        pkill -9 -f "mosquitto_sub.*$MQTT_HOST"
    else
        echo "âœ… å·²åœæ­¢"
    fi
}

# æŸ¥çœ‹çŠ¶æ€
status() {
    echo "=========================================="
    echo "  å·´æ³•äº‘MQTTæœåŠ¡çŠ¶æ€"
    echo "=========================================="
    
    if is_running; then
        echo "çŠ¶æ€: âœ… è¿è¡Œä¸­"
        echo "PID: $(cat $PID_FILE)"
    else
        echo "çŠ¶æ€: âŒ æœªè¿è¡Œ"
        rm -f "$PID_FILE"
    fi
    
    echo ""
    echo "é…ç½®ä¿¡æ¯:"
    echo "  æœåŠ¡å™¨: $MQTT_HOST:$MQTT_PORT"
    echo "  ä¸»é¢˜åˆ—è¡¨: $TOPICS"
    
    if [ -f "$LOG_FILE" ]; then
        MSG_COUNT=$(wc -l < "$LOG_FILE")
        echo "  æ¶ˆæ¯æ€»æ•°: $MSG_COUNT"
    fi
    
    if [ -f "$SUBSCRIBE_LOG" ]; then
        SUB_COUNT=$(wc -l < "$SUBSCRIBE_LOG")
        echo "  æ¥æ”¶æ¶ˆæ¯: $SUB_COUNT"
    fi
    
    echo ""
    echo "æ´»è·ƒè®¢é˜…:"
    pgrep -af "mosquitto_sub.*$MQTT_HOST" | while read line; do
        echo "  $line"
    done
}

# å‘é€æ¶ˆæ¯
send() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "ç”¨æ³•: $0 send <ä¸»é¢˜> <æ¶ˆæ¯å†…å®¹>"
        echo "ç¤ºä¾‹: $0 send ppt001 'Hello World'"
        return 1
    fi
    
    TOPIC="$1"
    MESSAGE="$2"
    
    echo "ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°ä¸»é¢˜: $TOPIC"
    echo "   å†…å®¹: $MESSAGE"
    
    mosquitto_pub -h "$MQTT_HOST" -p "$MQTT_PORT" \
        -i "$PRIVATE_KEY" -t "$TOPIC" -m "$MESSAGE"
    
    if [ $? -eq 0 ]; then
        echo "âœ… å‘é€æˆåŠŸ"
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [å‘é€] $TOPIC $MESSAGE" >> "$LOG_FILE"
    else
        echo "âŒ å‘é€å¤±è´¥"
        return 1
    fi
}

# æŸ¥çœ‹æ—¥å¿—
show_log() {
    if [ -f "$LOG_FILE" ]; then
        echo "=========================================="
        echo "  æ¶ˆæ¯æ—¥å¿— (æœ€æ–°50æ¡)"
        echo "=========================================="
        tail -n 50 "$LOG_FILE"
    else
        echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
    fi
}

# æ¸…ç©ºæ—¥å¿—
clear_log() {
    > "$LOG_FILE"
    > "$SUBSCRIBE_LOG"
    > "$LOG_DIR/player.log"
    echo "âœ… æ‰€æœ‰æ—¥å¿—å·²æ¸…ç©º"
}

# ä¸»ç¨‹åº
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start
        ;;
    status)
        status
        ;;
    send)
        send "$2" "$3"
        ;;
    log)
        show_log
        ;;
    clear)
        clear_log
        ;;
    *)
        echo "å·´æ³•äº‘MQTTå®¢æˆ·ç«¯ç®¡ç†è„šæœ¬"
        echo ""
        echo "ç”¨æ³•: $0 {start|stop|restart|status|send|log|clear}"
        echo ""
        echo "å‘½ä»¤:"
        echo "  start              å¯åŠ¨MQTTè®¢é˜…æœåŠ¡"
        echo "  stop               åœæ­¢MQTTè®¢é˜…æœåŠ¡"
        echo "  restart            é‡å¯MQTTè®¢é˜…æœåŠ¡"
        echo "  status             æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
        echo "  send <ä¸»é¢˜> <æ¶ˆæ¯>  å‘é€æ¶ˆæ¯"
        echo "  log                æŸ¥çœ‹æ¶ˆæ¯æ—¥å¿—"
        echo "  clear              æ¸…ç©ºæ‰€æœ‰æ—¥å¿—"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  $0 send ppt001 'PLAYLIST:http://music.mp3'"
        echo "  $0 send ppt001 'CMD:PAUSE'"
        exit 1
        ;;
esac
EOF

    chmod +x "$INSTALL_DIR/bemfa_mqtt.sh"
    echo "âœ… MQTTè„šæœ¬åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºæ’­æ”¾å™¨å¤„ç†è„šæœ¬
create_player_script() {
    echo ""
    echo "ğŸµ åˆ›å»ºæ’­æ”¾å™¨å¤„ç†è„šæœ¬..."
    
    cat > "$INSTALL_DIR/bemfa_player.sh" << 'EOF'
#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/bemfa_config.conf"
PLAYER_LOG="$SCRIPT_DIR/logs/player.log"
PLAYLIST_FILE="/tmp/bemfa_playlist.m3u"
PLAYER_PID_FILE="/tmp/bemfa_player.pid"

# åŠ è½½é…ç½®
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

TOPIC="$1"

# è¯»å–æ¶ˆæ¯å†…å®¹
read -r MESSAGE

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$TOPIC] $1" >> "$PLAYER_LOG"
}

# æ£€æŸ¥æ’­æ”¾å™¨æ˜¯å¦è¿è¡Œ
is_player_running() {
    if [ -f "$PLAYER_PID_FILE" ]; then
        PID=$(cat "$PLAYER_PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# åœæ­¢æ’­æ”¾å™¨
stop_player() {
    if [ -f "$PLAYER_PID_FILE" ]; then
        PID=$(cat "$PLAYER_PID_FILE")
        kill "$PID" 2>/dev/null
        rm -f "$PLAYER_PID_FILE"
    fi
    pkill -f "mpg123.*bemfa_playlist"
}

# è§£æJSONæ ¼å¼
parse_json() {
    local json="$1"
    
    # ç®€å•çš„JSONè§£æï¼ˆä½¿ç”¨grepå’Œsedï¼‰
    if echo "$json" | grep -q '"cmd"'; then
        CMD=$(echo "$json" | grep -o '"cmd":"[^"]*"' | cut -d'"' -f4)
        
        case "$CMD" in
            PLAYLIST)
                # æå–URLsæ•°ç»„
                URLS=$(echo "$json" | grep -o '"urls":\[.*\]' | sed 's/"urls":\[//;s/\]//;s/"//g' | tr ',' '\n')
                log "JSONæ ¼å¼æ’­æ”¾åˆ—è¡¨: $(echo $URLS | wc -w) é¦–"
                
                # åˆ›å»ºæ’­æ”¾åˆ—è¡¨
                > "$PLAYLIST_FILE"
                for url in $URLS; do
                    echo "$url" >> "$PLAYLIST_FILE"
                done
                
                # åœæ­¢å½“å‰æ’­æ”¾
                stop_player
                
                # å¼€å§‹æ’­æ”¾
                if command -v mpg123 >/dev/null 2>&1; then
                    mpg123 -@ "$PLAYLIST_FILE" >/dev/null 2>&1 &
                    echo $! > "$PLAYER_PID_FILE"
                    log "å¼€å§‹æ’­æ”¾ (PID: $!)"
                fi
                ;;
                
            CONTROL)
                ACTION=$(echo "$json" | grep -o '"action":"[^"]*"' | cut -d'"' -f4)
                handle_control "$ACTION"
                ;;
                
            CUSTOM)
                log "æ”¶åˆ°è‡ªå®šä¹‰JSONæŒ‡ä»¤"
                # è¿™é‡Œå¯ä»¥æ‰©å±•è‡ªå®šä¹‰æŒ‡ä»¤å¤„ç†
                ;;
        esac
        
        return 0
    fi
    
    return 1
}

# å¤„ç†æ§åˆ¶æŒ‡ä»¤
handle_control() {
    local cmd="$1"
    
    case "$cmd" in
        PAUSE)
            if is_player_running; then
                kill -STOP $(cat "$PLAYER_PID_FILE") 2>/dev/null
                log "æš‚åœæ’­æ”¾"
            else
                if [ -f "$PLAYER_PID_FILE" ]; then
                    kill -CONT $(cat "$PLAYER_PID_FILE") 2>/dev/null
                    log "ç»§ç»­æ’­æ”¾"
                fi
            fi
            ;;
            
        NEXT)
            if is_player_running; then
                kill -USR1 $(cat "$PLAYER_PID_FILE") 2>/dev/null
                log "ä¸‹ä¸€é¦–"
            fi
            ;;
            
        PREV)
            if is_player_running; then
                kill -USR2 $(cat "$PLAYER_PID_FILE") 2>/dev/null
                log "ä¸Šä¸€é¦–"
            fi
            ;;
            
        STOP)
            stop_player
            log "åœæ­¢æ’­æ”¾"
            ;;
            
        VOLUP)
            # éŸ³é‡æ§åˆ¶éœ€è¦amixeræ”¯æŒ
            if command -v amixer >/dev/null 2>&1; then
                amixer set Master 5%+ >/dev/null 2>&1
                log "éŸ³é‡+"
            fi
            ;;
            
        VOLDOWN)
            if command -v amixer >/dev/null 2>&1; then
                amixer set Master 5%- >/dev/null 2>&1
                log "éŸ³é‡-"
            fi
            ;;
    esac
}

# ä¸»å¤„ç†é€»è¾‘
log "æ”¶åˆ°æ¶ˆæ¯: $MESSAGE"

# å°è¯•è§£æJSON
if parse_json "$MESSAGE"; then
    exit 0
fi

# å¤„ç†æ—§æ ¼å¼: PLAYLIST:url1|||url2|||url3
if [[ "$MESSAGE" =~ ^PLAYLIST: ]]; then
    URLS=$(echo "$MESSAGE" | sed 's/PLAYLIST://' | tr '|||' '\n')
    log "æ—§æ ¼å¼æ’­æ”¾åˆ—è¡¨: $(echo $URLS | wc -w) é¦–"
    
    # åˆ›å»ºæ’­æ”¾åˆ—è¡¨
    > "$PLAYLIST_FILE"
    for url in $URLS; do
        echo "$url" >> "$PLAYLIST_FILE"
    done
    
    # åœæ­¢å½“å‰æ’­æ”¾
    stop_player
    
    # å¼€å§‹æ’­æ”¾
    if command -v mpg123 >/dev/null 2>&1; then
        mpg123 -@ "$PLAYLIST_FILE" >/dev/null 2>&1 &
        echo $! > "$PLAYER_PID_FILE"
        log "å¼€å§‹æ’­æ”¾ (PID: $!)"
    else
        log "é”™è¯¯: mpg123 æœªå®‰è£…"
    fi
    
    exit 0
fi

# å¤„ç†æ—§æ ¼å¼: CMD:ACTION
if [[ "$MESSAGE" =~ ^CMD: ]]; then
    CMD=$(echo "$MESSAGE" | sed 's/CMD://')
    log "æ—§æ ¼å¼æ§åˆ¶æŒ‡ä»¤: $CMD"
    handle_control "$CMD"
    exit 0
fi

# å…¶ä»–æ¶ˆæ¯
log "æœªè¯†åˆ«çš„æ¶ˆæ¯æ ¼å¼"
EOF

    chmod +x "$INSTALL_DIR/bemfa_player.sh"
    echo "âœ… æ’­æ”¾å™¨è„šæœ¬åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºWebç®¡ç†ç•Œé¢
create_web_interface() {
    echo ""
    echo "ğŸŒ åˆ›å»ºWebç®¡ç†ç•Œé¢..."
    
    cat > "$INSTALL_DIR/web.sh" << 'EOF'
#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/bemfa_config.conf"
MQTT_SCRIPT="$SCRIPT_DIR/bemfa_mqtt.sh"
LOG_FILE="$SCRIPT_DIR/logs/messages.log"
SUBSCRIBE_LOG="$SCRIPT_DIR/logs/subscribe.log"
WEB_PORT=8080
WEB_PID="/tmp/bemfa_web.pid"

# åŠ è½½é…ç½®
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# æ£€æŸ¥WebæœåŠ¡æ˜¯å¦è¿è¡Œ
is_web_running() {
    if [ -f "$WEB_PID" ]; then
        PID=$(cat "$WEB_PID")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# å¯åŠ¨WebæœåŠ¡
start_web() {
    if is_web_running; then
        echo "âœ“ WebæœåŠ¡å·²åœ¨è¿è¡Œ (ç«¯å£: $WEB_PORT)"
        return 0
    fi
    
    echo "ğŸŒ å¯åŠ¨Webç®¡ç†ç•Œé¢..."
    echo "   è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}'):$WEB_PORT"
    
    # ä½¿ç”¨busybox httpd
    if command -v busybox >/dev/null 2>&1; then
        # åˆ›å»ºä¸´æ—¶CGIè„šæœ¬
        mkdir -p /tmp/bemfa_web
        
        cat > /tmp/bemfa_web/index.cgi << 'WEBCGI'
#!/bin/bash

echo "Content-type: text/html; charset=utf-8"
echo ""

SCRIPT_DIR="/root/mqtt"
CONFIG_FILE="$SCRIPT_DIR/bemfa_config.conf"
MQTT_SCRIPT="$SCRIPT_DIR/bemfa_mqtt.sh"
LOG_FILE="$SCRIPT_DIR/logs/messages.log"
SUBSCRIBE_LOG="$SCRIPT_DIR/logs/subscribe.log"

# åŠ è½½é…ç½®
source "$CONFIG_FILE" 2>/dev/null

# å¤„ç†POSTè¯·æ±‚
if [ "$REQUEST_METHOD" = "POST" ]; then
    read -n $CONTENT_LENGTH POST_DATA
    ACTION=$(echo "$POST_DATA" | sed -n 's/.*action=\([^&]*\).*/\1/p')
    TOPIC=$(echo "$POST_DATA" | sed -n 's/.*topic=\([^&]*\).*/\1/p' | sed 's/+/ /g; s/%20/ /g')
    MESSAGE=$(echo "$POST_DATA" | sed -n 's/.*message=\([^&]*\).*/\1/p' | sed 's/+/ /g')
    MESSAGE=$(printf '%b' "${MESSAGE//%/\\x}")
    
    case "$ACTION" in
        start) $MQTT_SCRIPT start >/dev/null 2>&1 ;;
        stop) $MQTT_SCRIPT stop >/dev/null 2>&1 ;;
        restart) $MQTT_SCRIPT restart >/dev/null 2>&1 ;;
        send) [ -n "$MESSAGE" ] && [ -n "$TOPIC" ] && $MQTT_SCRIPT send "$TOPIC" "$MESSAGE" >/dev/null 2>&1 ;;
        clear) $MQTT_SCRIPT clear >/dev/null 2>&1 ;;
    esac
    
    echo "<script>window.location.href='/index.cgi';</script>"
    exit 0
fi

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
STATUS="æœªè¿è¡Œ"
STATUS_COLOR="#ef4444"
if $MQTT_SCRIPT status >/dev/null 2>&1; then
    STATUS="è¿è¡Œä¸­"
    STATUS_COLOR="#10b981"
fi

# è¯»å–æ—¥å¿—
SEND_MESSAGES="<div class='empty'>æš‚æ— å‘é€è®°å½•</div>"
if [ -f "$LOG_FILE" ]; then
    SEND_MESSAGES=$(grep "\[å‘é€\]" "$LOG_FILE" | tail -n 30 | tac | sed 's/</\&lt;/g;s/>/\&gt;/g' | while read line; do
        [ -n "$line" ] && echo "<div class='message'>$line</div>"
    done)
    [ -z "$SEND_MESSAGES" ] && SEND_MESSAGES="<div class='empty'>æš‚æ— å‘é€è®°å½•</div>"
fi

SUBSCRIBE_MESSAGES="<div class='empty'>æš‚æ— æ¥æ”¶æ¶ˆæ¯</div>"
if [ -f "$SUBSCRIBE_LOG" ]; then
    SUBSCRIBE_MESSAGES=$(tail -n 30 "$SUBSCRIBE_LOG" | tac | sed 's/</\&lt;/g;s/>/\&gt;/g' | while read line; do
        [ -n "$line" ] && echo "<div class='subscribe-message'>$line</div>"
    done)
    [ -z "$SUBSCRIBE_MESSAGES" ] && SUBSCRIBE_MESSAGES="<div class='empty'>æš‚æ— æ¥æ”¶æ¶ˆæ¯</div>"
fi

# ç”Ÿæˆä¸»é¢˜é€‰é¡¹
TOPIC_OPTIONS=""
for t in $TOPICS; do
    TOPIC_OPTIONS="$TOPIC_OPTIONS<option value='$t'>$t</option>"
done

cat << 'HTML'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·´æ³•äº‘MQTTç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 26px; }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .content { padding: 25px; }
        .info { background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .info strong { color: #667eea; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; transform: translateY(-2px); }
        .send-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .send-section h3 { margin-bottom: 15px; color: #333; }
        .send-form { display: flex; flex-direction: column; gap: 12px; }
        .form-row { display: flex; gap: 10px; align-items: center; }
        .form-row label { min-width: 80px; font-weight: 600; color: #555; }
        .send-form select, .send-form textarea { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .send-form select:focus, .send-form textarea:focus { outline: none; border-color: #667eea; }
        .send-form textarea { min-height: 80px; resize: vertical; }
        .quick-cmds { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .quick-btn { padding: 6px 12px; background: #e0e7ff; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .quick-btn:hover { background: #c7d2fe; }
        .messages-title { font-size: 18px; margin-bottom: 12px; color: #374151; font-weight: 600; }
        .messages-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .messages-box { background: #f8f9fa; padding: 15px; border-radius: 10px; }
        .messages { max-height: 400px; overflow-y: auto; }
        .message { padding: 10px; margin-bottom: 8px; background: white; border-left: 3px solid #667eea; border-radius: 6px; font-size: 12px; font-family: 'Courier New', monospace; word-wrap: break-word; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .subscribe-message { padding: 10px; margin-bottom: 8px; background: white; border-left: 3px solid #10b981; border-radius: 6px; font-size: 12px; font-family: 'Courier New', monospace; word-wrap: break-word; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .empty { text-align: center; padding: 60px 20px; color: #9ca3af; font-size: 14px; }
        @media (max-width: 768px) { 
            .controls { flex-direction: column; } 
            .btn { width: 100%; }
            .messages-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ å·´æ³•äº‘MQTTç®¡ç†ä¸­å¿ƒ</h1>
HTML

echo "            <div class=\"status\" style=\"background: $STATUS_COLOR;\">â— $STATUS</div>"

cat << 'HTML'
        </div>
        <div class="content">
HTML

echo "            <div class=\"info\"><strong>æœåŠ¡å™¨:</strong> $MQTT_HOST:$MQTT_PORT | <strong>ä¸»é¢˜åˆ—è¡¨:</strong> $TOPICS</div>"

cat << 'HTML'
            
            <div class="controls">
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="action" value="start">
                    <button type="submit" class="btn btn-primary">â–¶ï¸ å¯åŠ¨æœåŠ¡</button>
                </form>
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="action" value="stop">
                    <button type="submit" class="btn btn-danger">â¹ï¸ åœæ­¢æœåŠ¡</button>
                </form>
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="action" value="restart">
                    <button type="submit" class="btn btn-secondary">ğŸ”„ é‡å¯æœåŠ¡</button>
                </form>
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="action" value="clear">
                    <button type="submit" class="btn btn-secondary" onclick="return confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—?');">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                </form>
            </div>
            
            <div class="send-section">
                <h3>ğŸ“¤ å‘é€æ¶ˆæ¯</h3>
                <form method="POST" class="send-form">
                    <input type="hidden" name="action" value="send">
                    <div class="form-row">
                        <label>ç›®æ ‡ä¸»é¢˜:</label>
HTML

echo "                        <select name=\"topic\" required>$TOPIC_OPTIONS</select>"

cat << 'HTML'
                    </div>
                    <div class="form-row">
                        <label>æ¶ˆæ¯å†…å®¹:</label>
                        <textarea name="message" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">ğŸ“¡ å‘é€æ¶ˆæ¯</button>
                </form>
                
                <div class="quick-cmds">
                    <strong style="width: 100%; margin-bottom: 5px; display: block;">å¿«æ·æŒ‡ä»¤:</strong>
                    <button class="quick-btn" onclick="setMsg('CMD:PAUSE')">â¯ï¸ æš‚åœ</button>
                    <button class="quick-btn" onclick="setMsg('CMD:NEXT')">â­ï¸ ä¸‹ä¸€é¦–</button>
                    <button class="quick-btn" onclick="setMsg('CMD:PREV')">â®ï¸ ä¸Šä¸€é¦–</button>
                    <button class="quick-btn" onclick="setMsg('CMD:STOP')">â¹ï¸ åœæ­¢</button>
                    <button class="quick-btn" onclick="setMsg('CMD:VOLUP')">ğŸ”Š éŸ³é‡+</button>
                    <button class="quick-btn" onclick="setMsg('CMD:VOLDOWN')">ğŸ”‰ éŸ³é‡-</button>
                </div>
            </div>
            
            <div class="messages-container">
                <div class="messages-box">
                    <h3 class="messages-title">ğŸ“¤ å‘é€å†å² (æœ€æ–°30æ¡)</h3>
HTML

echo "                    <div class=\"messages\">$SEND_MESSAGES</div>"

cat << 'HTML'
                </div>
                <div class="messages-box">
                    <h3 class="messages-title">ğŸ“¥ æ¥æ”¶æ¶ˆæ¯ (æœ€æ–°30æ¡)</h3>
HTML

echo "                    <div class=\"messages\">$SUBSCRIBE_MESSAGES</div>"

cat << 'HTML'
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function setMsg(txt) {
            document.getElementById('msg-input').value = txt;
        }
        setTimeout(function(){ window.location.reload(); }, 10000);
    </script>
</body>
</html>
HTML
WEBCGI
        
        chmod +x /tmp/bemfa_web/index.cgi
        
        # å¯åŠ¨busybox httpd
        cd /tmp/bemfa_web
        busybox httpd -p $WEB_PORT -h /tmp/bemfa_web -c /tmp/bemfa_web &
        echo $! > "$WEB_PID"
        
        echo "âœ… WebæœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $(cat $WEB_PID))"
        echo "   è®¿é—®: http://$(hostname -I | awk '{print $1}'):$WEB_PORT/index.cgi"
    else
        echo "âŒ busybox æœªæ‰¾åˆ°ï¼Œæ— æ³•å¯åŠ¨WebæœåŠ¡"
        return 1
    fi
}

# åœæ­¢WebæœåŠ¡
stop_web() {
    if ! is_web_running; then
        echo "âœ— WebæœåŠ¡æœªè¿è¡Œ"
        rm -f "$WEB_PID"
        return 1
    fi
    
    echo "â¹ï¸  åœæ­¢WebæœåŠ¡..."
    kill $(cat "$WEB_PID") 2>/dev/null
    rm -f "$WEB_PID"
    pkill -f "busybox httpd.*$WEB_PORT"
    
    echo "âœ… WebæœåŠ¡å·²åœæ­¢"
}

# æŸ¥çœ‹WebçŠ¶æ€
status_web() {
    if is_web_running; then
        echo "âœ… WebæœåŠ¡è¿è¡Œä¸­"
        echo "   PID: $(cat $WEB_PID)"
        echo "   ç«¯å£: $WEB_PORT"
        echo "   è®¿é—®: http://$(hostname -I | awk '{print $1}'):$WEB_PORT/index.cgi"
    else
        echo "âŒ WebæœåŠ¡æœªè¿è¡Œ"
        rm -f "$WEB_PID"
    fi
}

# ä¸»ç¨‹åº
case "$1" in
    start)
        start_web
        ;;
    stop)
        stop_web
        ;;
    restart)
        stop_web
        sleep 1
        start_web
        ;;
    status)
        status_web
        ;;
    *)
        echo "Webç®¡ç†ç•Œé¢æ§åˆ¶è„šæœ¬"
        echo ""
        echo "ç”¨æ³•: $0 {start|stop|restart|status}"
        echo ""
        echo "å‘½ä»¤:"
        echo "  start     å¯åŠ¨WebæœåŠ¡"
        echo "  stop      åœæ­¢WebæœåŠ¡"
        echo "  restart   é‡å¯WebæœåŠ¡"
        echo "  status    æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
        exit 1
        ;;
esac
EOF

    chmod +x "$INSTALL_DIR/web.sh"
    echo "âœ… Webç®¡ç†ç•Œé¢åˆ›å»ºå®Œæˆ"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo ""
    echo "=========================================="
    echo "  âœ… å®‰è£…å®Œæˆ!"
    echo "=========================================="
    echo ""
    echo "ğŸ“ å®‰è£…ç›®å½•: $INSTALL_DIR"
    echo ""
    echo "ğŸ”§ é…ç½®æ–‡ä»¶:"
    echo "   $INSTALL_DIR/bemfa_config.conf"
    echo ""
    echo "ğŸ“ ç¼–è¾‘é…ç½®:"
    echo "   nano $INSTALL_DIR/bemfa_config.conf"
    echo ""
    echo "ğŸš€ å¯åŠ¨æœåŠ¡:"
    echo "   $INSTALL_DIR/bemfa_mqtt.sh start"
    echo ""
    echo "ğŸŒ å¯åŠ¨Webç•Œé¢:"
    echo "   $INSTALL_DIR/web.sh start"
    echo "   è®¿é—®: http://$(hostname -I | awk '{print $1}'):8080/index.cgi"
    echo ""
    echo "ğŸ“Š æŸ¥çœ‹çŠ¶æ€:"
    echo "   $INSTALL_DIR/bemfa_mqtt.sh status"
    echo ""
    echo "ğŸ“¤ å‘é€æ¶ˆæ¯:"
    echo "   $INSTALL_DIR/bemfa_mqtt.sh send <ä¸»é¢˜> <æ¶ˆæ¯>"
    echo ""
    echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—:"
    echo "   $INSTALL_DIR/bemfa_mqtt.sh log"
    echo ""
    echo "=========================================="
    echo ""
    echo "ğŸ’¡ æç¤º:"
    echo "   1. ç¼–è¾‘é…ç½®æ–‡ä»¶æ·»åŠ æ›´å¤šä¸»é¢˜"
    echo "   2. æ”¯æŒJSONæ ¼å¼å’Œæ—§æ ¼å¼æ¶ˆæ¯"
    echo "   3. Webç•Œé¢æ¯10ç§’è‡ªåŠ¨åˆ·æ–°"
    echo ""
}

# ä¸»å®‰è£…æµç¨‹
main() {
    check_dependencies
    create_directories
    create_config
    create_mqtt_script
    create_player_script
    create_web_interface
    show_usage
}

main
