#!/bin/bash
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export HOME=/root
LAST_DEVICE_FILE="/etc/last_bt_device"

echo "--- 流程开始：重置音频与蓝牙环境 ---"
pkill -9 pulseaudio
rm -rf /var/run/pulse /root/.config/pulse
sleep 2
pulseaudio --system -D --disallow-exit
bluetoothctl power on >/dev/null 2>&1
sleep 2

if [ -f "$LAST_DEVICE_FILE" ]; then
    TARGET_MAC=$(cat "$LAST_DEVICE_FILE")
    echo "尝试连接历史设备: $TARGET_MAC"
    bluetoothctl trust "$TARGET_MAC" >/dev/null 2>&1
    bluetoothctl connect "$TARGET_MAC" >/dev/null 2>&1
    sleep 5
fi

SINK=$(pactl list sinks short | grep bluez | awk '{print $2}')
if [[ -n "$SINK" ]]; then
    pactl set-default-sink "$SINK"
    echo "$TARGET_MAC" > "$LAST_DEVICE_FILE"
    echo "✓ 连接成功: $SINK"
    # 增加这一行进行音频测试
    speaker-test -t wav -c 2 -l 1 >/dev/null 2>&1
    exit 0
else
    echo "✗ 连接失败，触发重试..."
    exit 1
fi
