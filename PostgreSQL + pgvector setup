#!/bin/bash

# PostgreSQL + pgvector 一键安装脚本
# 支持 ARM 和 AMD64 架构

set -e

echo "=================================="
echo "PostgreSQL + pgvector 一键安装"
echo "=================================="
echo ""

# 检测架构
ARCH=$(uname -m)
echo "✓ 检测到系统架构: $ARCH"

# 转换架构名称
case $ARCH in
    x86_64)
        DOCKER_ARCH="amd64"
        ;;
    aarch64|arm64)
        DOCKER_ARCH="arm64"
        ;;
    armv7l)
        DOCKER_ARCH="arm/v7"
        ;;
    *)
        echo "❌ 不支持的架构: $ARCH"
        exit 1
        ;;
esac

echo "✓ Docker 架构: $DOCKER_ARCH"
echo ""

# 检查 Docker 是否安装
if ! command -v docker &> /dev/null; then
    echo "❌ Docker 未安装，请先安装 Docker"
    echo "   安装方法: https://docs.docker.com/get-docker/"
    exit 1
fi

echo "✓ Docker 已安装"
echo ""

# 配置参数
CONTAINER_NAME="postgres-vector"
POSTGRES_PASSWORD="mypassword"
POSTGRES_DB="vectordb"
POSTGRES_USER="postgres"
PORT="5432"

echo "📋 安装配置:"
echo "   容器名称: $CONTAINER_NAME"
echo "   数据库名: $POSTGRES_DB"
echo "   用户名: $POSTGRES_USER"
echo "   密码: $POSTGRES_PASSWORD"
echo "   端口: $PORT"
echo ""

# 检查容器是否已存在
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "⚠️  容器 $CONTAINER_NAME 已存在"
    read -p "是否删除并重新安装? (y/N): " confirm
    if [[ $confirm == [yY] ]]; then
        echo "🗑️  删除旧容器..."
        docker rm -f $CONTAINER_NAME
    else
        echo "❌ 安装已取消"
        exit 0
    fi
fi

# 检查端口是否被占用
if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    echo "❌ 端口 $PORT 已被占用，请先释放该端口或修改脚本中的 PORT 变量"
    exit 1
fi

echo "🚀 开始安装..."
echo ""

# 拉取并运行容器
docker run -d \
  --name $CONTAINER_NAME \
  --restart unless-stopped \
  -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
  -e POSTGRES_DB=$POSTGRES_DB \
  -e POSTGRES_USER=$POSTGRES_USER \
  -p $PORT:5432 \
  -v pgvector-data:/var/lib/postgresql/data \
  ankane/pgvector

echo "⏳ 等待数据库启动 (15秒)..."
sleep 15

# 激活 pgvector 扩展
echo "🔧 激活 pgvector 扩展..."
docker exec $CONTAINER_NAME psql -U $POSTGRES_USER -d $POSTGRES_DB -c "CREATE EXTENSION IF NOT EXISTS vector;"

echo ""
echo "=================================="
echo "✅ 安装完成！"
echo "=================================="
echo ""
echo "📊 连接信息:"
echo "   主机: localhost"
echo "   端口: $PORT"
echo "   数据库: $POSTGRES_DB"
echo "   用户名: $POSTGRES_USER"
echo "   密码: $POSTGRES_PASSWORD"
echo ""
echo "🔍 验证安装:"
echo "   docker exec -it $CONTAINER_NAME psql -U $POSTGRES_USER -d $POSTGRES_DB -c '\\dx'"
echo ""
echo "📝 常用命令:"
echo "   查看容器状态: docker ps | grep $CONTAINER_NAME"
echo "   查看日志: docker logs $CONTAINER_NAME"
echo "   停止容器: docker stop $CONTAINER_NAME"
echo "   启动容器: docker start $CONTAINER_NAME"
echo "   删除容器: docker rm -f $CONTAINER_NAME"
echo "   进入数据库: docker exec -it $CONTAINER_NAME psql -U $POSTGRES_USER -d $POSTGRES_DB"
echo ""
echo "🔗 n8n 连接字符串:"
echo "   postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@localhost:$PORT/$POSTGRES_DB"
echo ""
