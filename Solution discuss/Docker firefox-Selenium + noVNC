#!/bin/bash

################################################################################
# Selenium Firefox ä¸€é”®éƒ¨ç½²ã€é…ç½®å’Œæµ‹è¯•è„šæœ¬
# 
# åŠŸèƒ½:
# 1. å®‰è£… Docker å®¹å™¨(Firefox Selenium)
# 2. å®‰è£… Python å’Œ Selenium åº“
# 3. é…ç½®è‡ªåŠ¨å¯åŠ¨æœåŠ¡
# 4. å…¨é“¾æ¡æµ‹è¯•(å®¹å™¨â†’Seleniumâ†’noVNCâ†’å¤–ç½‘è®¿é—®)
# 5. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
#
# ä½¿ç”¨æ–¹æ³•:
#   curl -O https://your-server/selenium_installer.sh
#   chmod +x selenium_installer.sh
#   ./selenium_installer.sh
#
# æˆ–ç›´æ¥è¿è¡Œ: bash selenium_installer.sh
################################################################################

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é…ç½®å˜é‡
CONTAINER_NAME="firefox-selenium"
IMAGE_NAME="seleniarm/standalone-firefox"
DATA_DIR="$HOME/firefox-data"
SCRIPT_DIR="$HOME"
SERVICE_NAME="selenium-browser"
SELENIUM_PORT=4444
NOVNC_PORT=7900

# è·å–å…¬ç½‘IP
PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "æœªçŸ¥")

################################################################################
# å·¥å…·å‡½æ•°
################################################################################

print_header() {
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}\n"
}

print_step() {
    echo -e "\n${PURPLE}[æ­¥éª¤ $1]${NC} ${CYAN}$2${NC}"
    echo "----------------------------------------"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${NC}"
}

check_command() {
    if command -v $1 &> /dev/null; then
        print_success "$1 å·²å®‰è£…"
        return 0
    else
        print_warning "$1 æœªå®‰è£…"
        return 1
    fi
}

press_enter() {
    echo -e "\n${YELLOW}æŒ‰ Enter ç»§ç»­...${NC}"
    read
}

################################################################################
# ä¸»èœå•
################################################################################

show_menu() {
    clear
    print_header "ğŸ¦Š Selenium Firefox è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·"
    
    echo "å½“å‰æœåŠ¡å™¨ä¿¡æ¯:"
    echo "  ğŸ“ å…¬ç½‘IP: ${PUBLIC_IP}"
    echo "  ğŸ–¥ï¸  æ¶æ„: $(uname -m)"
    echo "  ğŸ§ ç³»ç»Ÿ: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
    echo ""
    
    echo "è¯·é€‰æ‹©æ“ä½œ:"
    echo "  ${GREEN}1${NC}) ğŸš€ å®Œæ•´å®‰è£…(æ¨è) - ä¸€é”®å®Œæˆæ‰€æœ‰é…ç½®"
    echo "  ${GREEN}2${NC}) ğŸ“¦ ä»…å®‰è£… Docker å®¹å™¨"
    echo "  ${GREEN}3${NC}) ğŸ ä»…å®‰è£… Python + Selenium"
    echo "  ${GREEN}4${NC}) âš™ï¸  ä»…é…ç½®è‡ªåŠ¨å¯åŠ¨æœåŠ¡"
    echo "  ${GREEN}5${NC}) ğŸ§ª å…¨é“¾æ¡æµ‹è¯•"
    echo "  ${GREEN}6${NC}) ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  ${GREEN}7${NC}) ğŸ”„ é‡å¯æœåŠ¡"
    echo "  ${GREEN}8${NC}) ğŸ—‘ï¸  å¸è½½æ‰€æœ‰ç»„ä»¶"
    echo "  ${GREEN}9${NC}) ğŸ› ï¸  æ•…éšœè¯Šæ–­å·¥å…·"
    echo "  ${GREEN}0${NC}) ğŸšª é€€å‡º"
    echo ""
    echo -n "è¯·è¾“å…¥é€‰é¡¹ [0-9]: "
}

################################################################################
# å®‰è£… Docker å®¹å™¨
################################################################################

install_docker_container() {
    print_step "1" "æ£€æŸ¥ Docker"
    
    if ! check_command docker; then
        print_error "Docker æœªå®‰è£…,è¯·å…ˆå®‰è£… Docker"
        echo "è¿è¡Œ: curl -fsSL https://get.docker.com | sh"
        return 1
    fi
    
    print_step "2" "æ£€æŸ¥æ˜¯å¦æœ‰æ—§å®¹å™¨"
    
    if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        print_warning "å‘ç°å·²å­˜åœ¨çš„å®¹å™¨: ${CONTAINER_NAME}"
        echo -n "æ˜¯å¦åˆ é™¤å¹¶é‡æ–°åˆ›å»º? [y/N]: "
        read answer
        if [[ "$answer" =~ ^[Yy]$ ]]; then
            docker stop ${CONTAINER_NAME} 2>/dev/null || true
            docker rm ${CONTAINER_NAME} 2>/dev/null || true
            print_success "æ—§å®¹å™¨å·²åˆ é™¤"
        else
            print_info "ä¿ç•™ç°æœ‰å®¹å™¨,è·³è¿‡åˆ›å»º"
            return 0
        fi
    fi
    
    print_step "3" "æ¸…ç†æ—§çš„æ•°æ®ç›®å½•(é¿å…æƒé™é—®é¢˜)"
    if [ -d "${DATA_DIR}" ]; then
        print_warning "åˆ é™¤æ—§çš„æ•°æ®ç›®å½•ä»¥é¿å…æƒé™é—®é¢˜"
        rm -rf ${DATA_DIR}
    fi
    print_info "ä¸ä½¿ç”¨æ•°æ®å·æŒ‚è½½(é¿å… Profile é”™è¯¯)"
    
    print_step "4" "æ‹‰å– Firefox Selenium é•œåƒ"
    docker pull ${IMAGE_NAME}
    
    print_step "5" "åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨(æ— æ•°æ®å·æŒ‚è½½)"
    
    docker run -d \
      --name ${CONTAINER_NAME} \
      --restart=unless-stopped \
      -p ${SELENIUM_PORT}:4444 \
      -p ${NOVNC_PORT}:7900 \
      -e SE_VNC_NO_PASSWORD=1 \
      -e SE_SCREEN_WIDTH=1920 \
      -e SE_SCREEN_HEIGHT=1080 \
      --shm-size=2g \
      ${IMAGE_NAME}
    
    print_success "å®¹å™¨å·²åˆ›å»º: ${CONTAINER_NAME}"
    print_info "æ³¨æ„: æœªæŒ‚è½½æ•°æ®å·,é‡å¯å®¹å™¨åç™»å½•çŠ¶æ€ä¼šä¸¢å¤±"
    
    print_step "6" "ç­‰å¾…å®¹å™¨å……åˆ†å¯åŠ¨(60ç§’)"
    echo -n "ç­‰å¾…ä¸­"
    for i in {1..60}; do
        echo -n "."
        sleep 1
    done
    echo ""
    
    print_step "7" "éªŒè¯å®¹å™¨çŠ¶æ€"
    
    if docker ps | grep -q ${CONTAINER_NAME}; then
        print_success "å®¹å™¨è¿è¡Œæ­£å¸¸"
        docker ps | grep ${CONTAINER_NAME}
    else
        print_error "å®¹å™¨å¯åŠ¨å¤±è´¥"
        echo "æŸ¥çœ‹æ—¥å¿—:"
        docker logs ${CONTAINER_NAME} --tail 20
        return 1
    fi
    
    print_step "8" "æ£€æŸ¥ç«¯å£"
    
    if curl -s http://localhost:${NOVNC_PORT}/ > /dev/null; then
        print_success "noVNC ç«¯å£ ${NOVNC_PORT} å¯è®¿é—®"
    else
        print_error "noVNC ç«¯å£ä¸å¯è®¿é—®"
    fi
    
    if curl -s http://localhost:${SELENIUM_PORT}/status > /dev/null; then
        print_success "Selenium ç«¯å£ ${SELENIUM_PORT} å¯è®¿é—®"
    else
        print_error "Selenium ç«¯å£ä¸å¯è®¿é—®"
    fi
    
    print_success "Docker å®¹å™¨å®‰è£…å®Œæˆ!"
    print_warning "æé†’: ç™»å½•ä¿¡æ¯ä¸ä¼šæŒä¹…åŒ–,é‡å¯å®¹å™¨éœ€é‡æ–°ç™»å½•"
}

################################################################################
# å®‰è£… Python å’Œ Selenium
################################################################################

install_python_selenium() {
    print_step "1" "æ£€æŸ¥ Python"
    
    if ! check_command python3; then
        print_error "Python3 æœªå®‰è£…"
        echo "æ­£åœ¨å®‰è£…..."
        sudo apt update
        sudo apt install python3 python3-pip -y
    fi
    
    PYTHON_VERSION=$(python3 --version)
    print_success "Python ç‰ˆæœ¬: ${PYTHON_VERSION}"
    
    print_step "2" "å®‰è£… Selenium"
    
    echo "å°è¯•å®‰è£… selenium..."
    
    # æ–¹æ³•1: å°è¯•ç³»ç»ŸåŒ…
    if sudo apt install python3-selenium -y 2>/dev/null; then
        print_success "é€šè¿‡ apt å®‰è£… selenium"
    else
        # æ–¹æ³•2: pip å¼ºåˆ¶å®‰è£…
        print_info "é€šè¿‡ pip å®‰è£… selenium"
        if pip3 install selenium --break-system-packages 2>/dev/null; then
            print_success "selenium å®‰è£…æˆåŠŸ"
        elif pip3 install selenium --user 2>/dev/null; then
            print_success "selenium å®‰è£…æˆåŠŸ(ç”¨æˆ·ç›®å½•)"
        else
            # æ–¹æ³•3: è™šæ‹Ÿç¯å¢ƒ
            print_info "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå®‰è£…"
            sudo apt install python3-venv python3-full -y
            python3 -m venv ${SCRIPT_DIR}/selenium-env
            ${SCRIPT_DIR}/selenium-env/bin/pip install selenium
            print_success "selenium å®‰è£…åœ¨è™šæ‹Ÿç¯å¢ƒ: ${SCRIPT_DIR}/selenium-env"
        fi
    fi
    
    print_step "3" "éªŒè¯ Selenium"
    
    if python3 -c "import selenium; print('ç‰ˆæœ¬:', selenium.__version__)" 2>/dev/null; then
        print_success "Selenium å¯ç”¨"
        python3 -c "import selenium; print('ç‰ˆæœ¬:', selenium.__version__)"
    elif [ -f "${SCRIPT_DIR}/selenium-env/bin/python" ]; then
        print_success "Selenium å¯ç”¨(è™šæ‹Ÿç¯å¢ƒ)"
        ${SCRIPT_DIR}/selenium-env/bin/python -c "import selenium; print('ç‰ˆæœ¬:', selenium.__version__)"
    else
        print_error "Selenium å®‰è£…å¤±è´¥"
        return 1
    fi
    
    print_success "Python + Selenium å®‰è£…å®Œæˆ!"
}

################################################################################
# åˆ›å»ºè‡ªåŠ¨å¯åŠ¨è„šæœ¬
################################################################################

create_startup_script() {
    print_step "1" "åˆ›å»ºæµè§ˆå™¨ä¿æŒè¿è¡Œè„šæœ¬(å¸¦å¥åº·æ£€æŸ¥)"
    
    # æ£€æµ‹ Python è·¯å¾„
    if [ -f "${SCRIPT_DIR}/selenium-env/bin/python" ]; then
        PYTHON_CMD="${SCRIPT_DIR}/selenium-env/bin/python"
    else
        PYTHON_CMD="/usr/bin/python3"
    fi
    
    cat > ${SCRIPT_DIR}/keep_browser_alive.py << 'SCRIPT_EOF'
from selenium import webdriver
from selenium.common.exceptions import WebDriverException
import time
import sys
import urllib.request
import json

print("=" * 60)
print("ğŸ¦Š Selenium Firefox è‡ªåŠ¨å¯åŠ¨æœåŠ¡")
print("=" * 60)

def wait_for_selenium_ready(max_wait=90):
    """ç­‰å¾… Selenium Grid çœŸæ­£å°±ç»ª"""
    print("\nç­‰å¾… Selenium Grid å°±ç»ª...")
    for i in range(max_wait):
        try:
            req = urllib.request.Request('http://localhost:4444/status')
            with urllib.request.urlopen(req, timeout=2) as response:
                data = json.loads(response.read())
                if data.get('value', {}).get('ready'):
                    print(f"âœ“ Selenium Grid å°±ç»ª(ç­‰å¾…äº† {i+1} ç§’)")
                    # é¢å¤–ç­‰å¾…ç¡®ä¿ Firefox å®Œå…¨å‡†å¤‡
                    print("é¢å¤–ç­‰å¾… 20 ç§’ç¡®ä¿ Firefox å®Œå…¨å‡†å¤‡...")
                    time.sleep(20)
                    return True
        except Exception as e:
            pass
        
        time.sleep(1)
        if i > 0 and i % 10 == 0:
            print(f"  ç­‰å¾…ä¸­... ({i}/{max_wait}ç§’)")
    
    print(f"âŒ ç­‰å¾…è¶…æ—¶({max_wait}ç§’)")
    return False

# ç­‰å¾… Selenium å°±ç»ª
if not wait_for_selenium_ready():
    print("âŒ Selenium Grid å¯åŠ¨è¶…æ—¶,è¯·æ£€æŸ¥å®¹å™¨çŠ¶æ€")
    sys.exit(1)

max_retries = 5
retry_count = 0
driver = None

while retry_count < max_retries:
    try:
        print(f"\n[å°è¯• {retry_count + 1}/{max_retries}] åˆ›å»º Firefox session...")
        
        options = webdriver.FirefoxOptions()
        # ä½¿ç”¨å®¹å™¨å†…çš„ä¸´æ—¶ç›®å½•,é¿å…æƒé™é—®é¢˜
        options.set_preference('browser.cache.disk.parent_directory', '/tmp/firefox-cache')
        
        driver = webdriver.Remote(
            command_executor='http://localhost:4444',
            options=options
        )
        
        driver.set_page_load_timeout(30)
        
        print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] âœ… Firefox å·²å¯åŠ¨!")
        driver.get('https://www.google.com')
        
        print(f"ğŸ“º noVNC è®¿é—®åœ°å€: http://localhost:7900/")
        print("=" * 60)
        print("ğŸ”„ æµè§ˆå™¨ä¿æŒè¿è¡Œä¸­...")
        print("=" * 60)
        
        # æˆåŠŸå¯åŠ¨,é‡ç½®é‡è¯•è®¡æ•°
        retry_count = 0
        
        # ä¿æŒè¿è¡Œ
        while True:
            try:
                driver.current_url
                time.sleep(300)  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            except WebDriverException as e:
                print(f"\n[{time.strftime('%Y-%m-%d %H:%M:%S')}] âš ï¸ è¿æ¥æ–­å¼€")
                raise
                
    except KeyboardInterrupt:
        print(f"\n[{time.strftime('%Y-%m-%d %H:%M:%S')}] æ”¶åˆ°åœæ­¢ä¿¡å·")
        if driver:
            try:
                driver.quit()
            except:
                pass
        print("âœ… æœåŠ¡å·²åœæ­¢")
        sys.exit(0)
        
    except Exception as e:
        retry_count += 1
        error_str = str(e)
        print(f"\n[{time.strftime('%Y-%m-%d %H:%M:%S')}] âŒ é”™è¯¯: {error_str[:150]}")
        
        if driver:
            try:
                driver.quit()
            except:
                pass
        
        if retry_count < max_retries:
            wait_time = min(retry_count * 10, 30)
            print(f"ç­‰å¾… {wait_time} ç§’åé‡è¯•...")
            time.sleep(wait_time)
        else:
            print(f"\nâŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°({max_retries}),æœåŠ¡é€€å‡º")
            print("å»ºè®®æ£€æŸ¥:")
            print("  1. docker logs firefox-selenium")
            print("  2. curl http://localhost:4444/status")
            sys.exit(1)
SCRIPT_EOF
    
    chmod +x ${SCRIPT_DIR}/keep_browser_alive.py
    print_success "è„šæœ¬å·²åˆ›å»º: ${SCRIPT_DIR}/keep_browser_alive.py"
    print_info "è„šæœ¬ç‰¹ç‚¹: å¥åº·æ£€æŸ¥ + æ™ºèƒ½é‡è¯• + é¿å… Profile é”™è¯¯"
    
    print_step "2" "åˆ›å»º systemd æœåŠ¡"
    
    sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null << SERVICE_EOF
[Unit]
Description=Selenium Firefox Browser Auto-Start Service
Documentation=https://www.selenium.dev/
After=docker.service ${CONTAINER_NAME}.service network-online.target
Requires=docker.service
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=${SCRIPT_DIR}
ExecStartPre=/bin/sleep 30
ExecStart=${PYTHON_CMD} ${SCRIPT_DIR}/keep_browser_alive.py
Restart=always
RestartSec=20
StandardOutput=journal
StandardError=journal
KillMode=mixed
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
SERVICE_EOF
    
    print_success "systemd æœåŠ¡å·²åˆ›å»º"
    
    print_step "3" "å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡"
    
    sudo systemctl daemon-reload
    sudo systemctl enable ${SERVICE_NAME}
    sudo systemctl start ${SERVICE_NAME}
    
    sleep 5
    
    if sudo systemctl is-active --quiet ${SERVICE_NAME}; then
        print_success "æœåŠ¡å·²å¯åŠ¨"
    else
        print_error "æœåŠ¡å¯åŠ¨å¤±è´¥"
        sudo systemctl status ${SERVICE_NAME} --no-pager
        return 1
    fi
    
    print_success "è‡ªåŠ¨å¯åŠ¨é…ç½®å®Œæˆ!"
    print_info "æŸ¥çœ‹å®æ—¶æ—¥å¿—: sudo journalctl -u ${SERVICE_NAME} -f"
    print_warning "é¦–æ¬¡å¯åŠ¨éœ€è¦ç­‰å¾…çº¦2åˆ†é’Ÿ,è¯·è€å¿ƒç­‰å¾…"
}

################################################################################
# å…¨é“¾æ¡æµ‹è¯•
################################################################################

run_full_test() {
    print_header "ğŸ§ª å¼€å§‹å…¨é“¾æ¡æµ‹è¯•"
    
    local test_passed=0
    local test_failed=0
    
    # æµ‹è¯•1: Docker å®¹å™¨
    print_step "1/8" "æµ‹è¯• Docker å®¹å™¨"
    if docker ps | grep -q ${CONTAINER_NAME}; then
        print_success "å®¹å™¨è¿è¡Œæ­£å¸¸"
        ((test_passed++))
    else
        print_error "å®¹å™¨æœªè¿è¡Œ"
        ((test_failed++))
    fi
    
    # æµ‹è¯•2: å®¹å™¨å†…è¿›ç¨‹
    print_step "2/8" "æµ‹è¯•å®¹å™¨å†…è¿›ç¨‹"
    if docker exec ${CONTAINER_NAME} ps aux 2>/dev/null | grep -q "[f]irefox"; then
        print_info "Firefox è¿›ç¨‹å¯èƒ½åœ¨è¿è¡Œ(æˆ–ç­‰å¾…å¯åŠ¨)"
        ((test_passed++))
    else
        print_warning "Firefox è¿›ç¨‹æœªæ£€æµ‹åˆ°(å¯èƒ½è¿˜æœªå¯åŠ¨)"
    fi
    
    # æµ‹è¯•3: VNC ç«¯å£
    print_step "3/8" "æµ‹è¯• VNC ç«¯å£(5900)"
    if docker exec ${CONTAINER_NAME} curl -s --connect-timeout 3 telnet://localhost:5900 >/dev/null 2>&1; then
        print_success "VNC ç«¯å£å¯è¿æ¥"
        ((test_passed++))
    else
        print_error "VNC ç«¯å£æ— æ³•è¿æ¥"
        ((test_failed++))
    fi
    
    # æµ‹è¯•4: noVNC HTTP
    print_step "4/8" "æµ‹è¯• noVNC HTTP(${NOVNC_PORT})"
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${NOVNC_PORT}/ 2>/dev/null || echo "000")
    if [ "$HTTP_CODE" = "200" ]; then
        print_success "noVNC HTTP è¿”å› 200 OK"
        ((test_passed++))
    else
        print_error "noVNC HTTP è¿”å› ${HTTP_CODE}"
        ((test_failed++))
    fi
    
    # æµ‹è¯•5: Selenium API
    print_step "5/8" "æµ‹è¯• Selenium API(${SELENIUM_PORT})"
    if curl -s http://localhost:${SELENIUM_PORT}/status | grep -q '"ready":true'; then
        print_success "Selenium Grid å°±ç»ª"
        ((test_passed++))
    else
        print_warning "Selenium Grid å¯èƒ½æ­£åœ¨åˆå§‹åŒ–"
    fi
    
    # æµ‹è¯•6: Python Selenium è¿æ¥
    print_step "6/8" "æµ‹è¯• Python Selenium è¿æ¥"
    
    TEST_SCRIPT=$(cat << 'TEST_EOF'
from selenium import webdriver
import sys

try:
    options = webdriver.FirefoxOptions()
    driver = webdriver.Remote(
        command_executor='http://localhost:4444',
        options=options,
    )
    driver.set_page_load_timeout(10)
    print("SUCCESS")
    driver.quit()
    sys.exit(0)
except Exception as e:
    print(f"FAILED: {e}")
    sys.exit(1)
TEST_EOF
)
    
    if echo "$TEST_SCRIPT" | python3 2>/dev/null | grep -q "SUCCESS"; then
        print_success "Python å¯ä»¥è¿æ¥ Selenium"
        ((test_passed++))
    else
        print_error "Python æ— æ³•è¿æ¥ Selenium"
        ((test_failed++))
    fi
    
    # æµ‹è¯•7: è‡ªåŠ¨å¯åŠ¨æœåŠ¡
    print_step "7/8" "æµ‹è¯•è‡ªåŠ¨å¯åŠ¨æœåŠ¡"
    if sudo systemctl is-active --quiet ${SERVICE_NAME}; then
        print_success "è‡ªåŠ¨å¯åŠ¨æœåŠ¡è¿è¡Œä¸­"
        ((test_passed++))
    else
        print_warning "è‡ªåŠ¨å¯åŠ¨æœåŠ¡æœªè¿è¡Œ"
    fi
    
    # æµ‹è¯•8: å¤–ç½‘è®¿é—®
    print_step "8/8" "æµ‹è¯•å¤–ç½‘è®¿é—®"
    print_info "è¯·åœ¨æµè§ˆå™¨è®¿é—®: http://${PUBLIC_IP}:${NOVNC_PORT}/"
    echo -n "èƒ½å¦è®¿é—®? [y/N]: "
    read answer
    if [[ "$answer" =~ ^[Yy]$ ]]; then
        print_success "å¤–ç½‘è®¿é—®æ­£å¸¸"
        ((test_passed++))
    else
        print_error "å¤–ç½‘æ— æ³•è®¿é—®"
        print_info "æ£€æŸ¥é˜²ç«å¢™è§„åˆ™:"
        sudo iptables -L INPUT -n | grep -E "${NOVNC_PORT}|${SELENIUM_PORT}" || echo "  æœªæ‰¾åˆ°ç›¸å…³è§„åˆ™"
        ((test_failed++))
    fi
    
    # æµ‹è¯•æ€»ç»“
    print_header "ğŸ“Š æµ‹è¯•æŠ¥å‘Š"
    echo "  âœ… é€šè¿‡: ${test_passed}"
    echo "  âŒ å¤±è´¥: ${test_failed}"
    echo ""
    
    if [ $test_failed -eq 0 ]; then
        print_success "æ‰€æœ‰æµ‹è¯•é€šè¿‡! ğŸ‰"
        echo ""
        echo "ğŸ“º è®¿é—®åœ°å€:"
        echo "   noVNC:    http://${PUBLIC_IP}:${NOVNC_PORT}/"
        echo "   Selenium: http://${PUBLIC_IP}:${SELENIUM_PORT}/"
        return 0
    else
        print_error "éƒ¨åˆ†æµ‹è¯•å¤±è´¥,è¯·æ£€æŸ¥æ—¥å¿—"
        echo ""
        echo "æŸ¥çœ‹æœåŠ¡æ—¥å¿—:"
        echo "   docker logs ${CONTAINER_NAME} --tail 50"
        echo "   sudo journalctl -u ${SERVICE_NAME} -n 50"
        return 1
    fi
}

################################################################################
# æŸ¥çœ‹çŠ¶æ€
################################################################################

show_status() {
    print_header "ğŸ“Š æœåŠ¡çŠ¶æ€"
    
    echo "ğŸ³ Docker å®¹å™¨:"
    if docker ps | grep -q ${CONTAINER_NAME}; then
        docker ps | grep ${CONTAINER_NAME}
    else
        print_error "å®¹å™¨æœªè¿è¡Œ"
    fi
    
    echo ""
    echo "âš™ï¸  ç³»ç»ŸæœåŠ¡:"
    sudo systemctl status ${SERVICE_NAME} --no-pager | head -15
    
    echo ""
    echo "ğŸŒ ç½‘ç»œç«¯å£:"
    echo "  noVNC:    http://${PUBLIC_IP}:${NOVNC_PORT}/"
    echo "  Selenium: http://${PUBLIC_IP}:${SELENIUM_PORT}/"
    
    echo ""
    echo "ğŸ“ æœ€è¿‘æ—¥å¿—:"
    sudo journalctl -u ${SERVICE_NAME} -n 10 --no-pager
}

################################################################################
# é‡å¯æœåŠ¡
################################################################################

restart_service() {
    print_header "ğŸ”„ é‡å¯æœåŠ¡"
    
    print_step "1" "é‡å¯ Docker å®¹å™¨"
    docker restart ${CONTAINER_NAME}
    sleep 10
    
    print_step "2" "é‡å¯è‡ªåŠ¨å¯åŠ¨æœåŠ¡"
    sudo systemctl restart ${SERVICE_NAME}
    sleep 5
    
    print_step "3" "æ£€æŸ¥çŠ¶æ€"
    if docker ps | grep -q ${CONTAINER_NAME} && sudo systemctl is-active --quiet ${SERVICE_NAME}; then
        print_success "æœåŠ¡é‡å¯æˆåŠŸ"
    else
        print_error "æœåŠ¡é‡å¯å¯èƒ½å¤±è´¥"
    fi
}

################################################################################
# å¸è½½
################################################################################

uninstall_all() {
    print_header "ğŸ—‘ï¸  å¸è½½æ‰€æœ‰ç»„ä»¶"
    
    print_warning "è¿™å°†åˆ é™¤:"
    echo "  - Docker å®¹å™¨: ${CONTAINER_NAME}"
    echo "  - ç³»ç»ŸæœåŠ¡: ${SERVICE_NAME}"
    echo "  - è„šæœ¬æ–‡ä»¶: ${SCRIPT_DIR}/keep_browser_alive.py"
    echo "  - æ•°æ®ç›®å½•: ${DATA_DIR}"
    echo ""
    echo -n "ç¡®è®¤å¸è½½? [y/N]: "
    read answer
    
    if [[ ! "$answer" =~ ^[Yy]$ ]]; then
        print_info "å–æ¶ˆå¸è½½"
        return 0
    fi
    
    print_step "1" "åœæ­¢å¹¶åˆ é™¤æœåŠ¡"
    sudo systemctl stop ${SERVICE_NAME} 2>/dev/null || true
    sudo systemctl disable ${SERVICE_NAME} 2>/dev/null || true
    sudo rm -f /etc/systemd/system/${SERVICE_NAME}.service
    sudo systemctl daemon-reload
    
    print_step "2" "åœæ­¢å¹¶åˆ é™¤å®¹å™¨"
    docker stop ${CONTAINER_NAME} 2>/dev/null || true
    docker rm ${CONTAINER_NAME} 2>/dev/null || true
    
    print_step "3" "åˆ é™¤è„šæœ¬"
    rm -f ${SCRIPT_DIR}/keep_browser_alive.py
    
    print_step "4" "åˆ é™¤æ•°æ®ç›®å½•"
    echo -n "æ˜¯å¦åˆ é™¤æ•°æ®ç›®å½• ${DATA_DIR}? [y/N]: "
    read answer
    if [[ "$answer" =~ ^[Yy]$ ]]; then
        rm -rf ${DATA_DIR}
        print_success "æ•°æ®ç›®å½•å·²åˆ é™¤"
    fi
    
    print_success "å¸è½½å®Œæˆ"
}

################################################################################
# æ•…éšœè¯Šæ–­
################################################################################

run_diagnostic() {
    print_header "ğŸ› ï¸  æ•…éšœè¯Šæ–­å·¥å…·"
    
    # ä¿å­˜åˆ°æ–‡ä»¶
    DIAG_FILE="/tmp/selenium_diagnostic_$(date +%Y%m%d_%H%M%S).log"
    
    {
        echo "========================================="
        echo "Selenium Firefox è¯Šæ–­æŠ¥å‘Š"
        echo "æ—¶é—´: $(date)"
        echo "========================================="
        echo ""
        
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        cat /etc/os-release
        echo ""
        
        echo "=== Docker ç‰ˆæœ¬ ==="
        docker --version
        echo ""
        
        echo "=== å®¹å™¨çŠ¶æ€ ==="
        docker ps -a | grep ${CONTAINER_NAME}
        echo ""
        
        echo "=== å®¹å™¨æ—¥å¿—(æœ€è¿‘50è¡Œ) ==="
        docker logs ${CONTAINER_NAME} --tail 50 2>&1
        echo ""
        
        echo "=== æœåŠ¡çŠ¶æ€ ==="
        sudo systemctl status ${SERVICE_NAME} --no-pager
        echo ""
        
        echo "=== æœåŠ¡æ—¥å¿—(æœ€è¿‘50è¡Œ) ==="
        sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager
        echo ""
        
        echo "=== ç«¯å£ç›‘å¬ ==="
        sudo netstat -tlnp | grep -E "${NOVNC_PORT}|${SELENIUM_PORT}"
        echo ""
        
        echo "=== é˜²ç«å¢™è§„åˆ™ ==="
        sudo iptables -L INPUT -n | grep -E "${NOVNC_PORT}|${SELENIUM_PORT}"
        echo ""
        
        echo "=== Python ç¯å¢ƒ ==="
        python3 --version
        python3 -c "import selenium; print('Selenium:', selenium.__version__)" 2>&1
        echo ""
        
    } | tee ${DIAG_FILE}
    
    print_success "è¯Šæ–­æŠ¥å‘Šå·²ä¿å­˜: ${DIAG_FILE}"
    echo ""
    echo "è¯·å°†æ­¤æ–‡ä»¶å‘é€ç»™æŠ€æœ¯æ”¯æŒ"
}

################################################################################
# å®Œæ•´å®‰è£…
################################################################################

full_install() {
    print_header "ğŸš€ å¼€å§‹å®Œæ•´å®‰è£…"
    
    echo "å°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:"
    echo "  1. å®‰è£… Docker å®¹å™¨"
    echo "  2. å®‰è£… Python + Selenium"
    echo "  3. é…ç½®è‡ªåŠ¨å¯åŠ¨æœåŠ¡"
    echo "  4. è¿è¡Œå…¨é“¾æ¡æµ‹è¯•"
    echo ""
    press_enter
    
    # æ­¥éª¤1
    install_docker_container
    if [ $? -ne 0 ]; then
        print_error "Docker å®¹å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    press_enter
    
    # æ­¥éª¤2
    install_python_selenium
    if [ $? -ne 0 ]; then
        print_error "Python + Selenium å®‰è£…å¤±è´¥"
        return 1
    fi
    press_enter
    
    # æ­¥éª¤3
    create_startup_script
    if [ $? -ne 0 ]; then
        print_error "è‡ªåŠ¨å¯åŠ¨é…ç½®å¤±è´¥"
        return 1
    fi
    press_enter
    
    # æ­¥éª¤4
    print_info "ç­‰å¾… 30 ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨..."
    sleep 30
    
    run_full_test
    
    if [ $? -eq 0 ]; then
        print_header "ğŸ‰ å®‰è£…æˆåŠŸ!"
        echo ""
        echo "ğŸ“º è®¿é—®åœ°å€:"
        echo "   noVNC:    http://${PUBLIC_IP}:${NOVNC_PORT}/"
        echo "   Selenium: http://${PUBLIC_IP}:${SELENIUM_PORT}/"
        echo ""
        echo "ğŸ“ å¸¸ç”¨å‘½ä»¤:"
        echo "   æŸ¥çœ‹çŠ¶æ€: sudo systemctl status ${SERVICE_NAME}"
        echo "   æŸ¥çœ‹æ—¥å¿—: sudo journalctl -u ${SERVICE_NAME} -f"
        echo "   é‡å¯æœåŠ¡: sudo systemctl restart ${SERVICE_NAME}"
        echo ""
    else
        print_error "å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜,è¯·æŸ¥çœ‹æ—¥å¿—"
    fi
}

################################################################################
# ä¸»ç¨‹åº
################################################################################

main() {
    # æ£€æŸ¥æ˜¯å¦ä¸º root æˆ–æœ‰ sudo æƒé™
    if [ "$EUID" -ne 0 ]; then
        if ! sudo -n true 2>/dev/null; then
            print_error "æ­¤è„šæœ¬éœ€è¦ sudo æƒé™"
            exit 1
        fi
    fi
    
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                full_install
                press_enter
                ;;
            2)
                install_docker_container
                press_enter
                ;;
            3)
                install_python_selenium
                press_enter
                ;;
            4)
                create_startup_script
                press_enter
                ;;
            5)
                run_full_test
                press_enter
                ;;
            6)
                show_status
                press_enter
                ;;
            7)
                restart_service
                press_enter
                ;;
            8)
                uninstall_all
                press_enter
                ;;
            9)
                run_diagnostic
                press_enter
                ;;
            0)
                print_info "é€€å‡ºç¨‹åº"
                exit 0
                ;;
            *)
                print_error "æ— æ•ˆé€‰é¡¹,è¯·é‡æ–°é€‰æ‹©"
                sleep 2
                ;;
        esac
    done
}

# è¿è¡Œä¸»ç¨‹åº
main
