除了你已经掌握的基础接力，n8n 的 Code 节点中还有几种常见的复杂数据转换场景，这些通常是单纯靠 UI 连线很难完成的：
在 n8n 中，Code 节点只要返回一个 Array（数组），它就自动具备了“拆分”功能。1. 它是如何自动拆分的？在 “5. 解析AI输出” 节点中，
我们用了如下代码：JavaScriptreturn items.map((item, index) => { 
  return { json: { ...item } }; 
});
items.map 会生成一个列表（比如包含 3 个商品的列表）。当这个列表从 Code 节点的 return 出来时，n8n 引擎会检测到：“哦，这里有 3 份数据，不是 1 份。
”于是，它会自动启动循环模式，让后面的节点（存图、入库）像排队一样，一个接一个地处理这 3 份数据。2. 你现在的逻辑变化过去：节点 5 输出 1 个 JSON $\rightarrow$
节点 6 运行 1 次 $\rightarrow$ 节点 9 运行 1 次。现在：节点 5 输出 数组 [A, B, C] $\rightarrow$ 节点 6 运行 3 次 $\rightarrow$ 节点 9 运行 3 次
。3. 注意事项虽然不需要 Split 节点，但你必须确保 “5. 解析AI输出” 节点的最后一行是按我给你的 items.map 这种格式写的。为什么？如果你直接 return { json: { items: [...] } }，
它依然被视为 1 个 包含数组的对象，不会触发自动拆分。只有 return [ {json:{...}}, {json:{...}} ]（即数组在最外层）才会触发自动拆分。

1. 数组扁平化 (Exploding)
场景： AI 一次性识别了图片里的 5 件商品，返回了一个列表，但你需要把它们拆分成 5 条数据分别入库。

JavaScript

const items = $json.ai_list; // 假设这是一个数组
return items.map(item => {
  return { json: { ...item, photo: $json.photo } }; 
});
效果： 节点输出会从 1 个变为多个，n8n 会自动为每个 item 触发一次后面的“入库”节点。

2. 条件路径拦截 (Filtering)
场景： 在代码里判断识别结果，如果不符合要求（比如 AI 置信度太低），直接“掐断”流程，不让它传给下一个节点。

JavaScript

if ($json.confidence < 0.8) {
  return []; // 返回空数组，后面的节点就不会执行了
}
return $input.item;
3. 数据重组与分组 (Grouping/Aggregation)
场景： 把多条独立的数据，根据“分类”合并成一个大的报告发送。

JavaScript

// 这种通常配合多个输入项使用
const allData = $input.all(); 
const summary = allData.reduce((acc, item) => {
  const cat = item.json.Category;
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {});
return { json: summary };
4. 二进制与 Base64 互相转换
场景： 有些 API 不接受文件上传，只接受 Base64 字符串。

JavaScript

// 获取二进制文件
const binaryData = $input.item.binary.data;
// 转为 Base64 字符串塞进 JSON
return {
  json: {
    ...$json,
    base64_file: binaryData.data
  }
};
5. 动态 Key 名转换
场景： 你的数据库列名是动态的（比如根据日期变动），或者 AI 返回的 Key 名不规范（带空格或特殊字符）。

JavaScript

const rawData = $json;
const cleanData = {};
for (let key in rawData) {
  // 把所有 Key 转为小写并去掉空格
  const newKey = key.toLowerCase().replace(/\s+/g, '_');
  cleanData[newKey] = rawData[key];
}
return { json: cleanData };
总结：Code 节点的“权杖”
在 n8n 里，如果你发现：

需要循环处理数据。

需要合并多个不同来源的节点。

需要改变输出项的数量（1 变多 或 多变 1）。

这时候 return 一个经过 JavaScript 逻辑处理过的对象，就是最强大的武器。

下一步： 你的入库节点目前运行稳定吗？如果需要处理“一张图识别出多个物体”的拆分入库，我可以帮你写那个转换逻辑。
