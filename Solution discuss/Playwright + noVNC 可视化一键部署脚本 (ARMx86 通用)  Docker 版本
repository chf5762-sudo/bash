#!/bin/bash

# =================================================================
#  Playwright + noVNC å…¨èƒ½ç®¡ç†è„šæœ¬ (å¤šè´¦æˆ·/æŒä¹…åŒ–/è„šæœ¬æ³¨å…¥)
# =================================================================

BASE_DIR="$HOME/playwright-pro"
PROFILE_DIR="$BASE_DIR/profiles"
SCRIPT_DIR="$BASE_DIR/scripts"
LOG_DIR="$BASE_DIR/logs"
LAUNCHER_FILE="$BASE_DIR/launcher.js"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# =================================================================
#  1. ç¯å¢ƒå®‰è£…ä¸é‡ç½®
# =================================================================
install_environment() {
    echo -e "${YELLOW}æ­£åœ¨æ£€æŸ¥ç¯å¢ƒ...${NC}"
    
    if [ -d "$BASE_DIR" ]; then
        read -p "âš ï¸  æ£€æµ‹åˆ°æ—§ç›®å½•ï¼Œæ˜¯å¦å…ˆæ‰§è¡Œæ¸…ç†å¹¶é‡è£…? [y/N]: " confirm
        if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
            echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§å®¹å™¨..."
            cd "$BASE_DIR"
            docker-compose down 2>/dev/null
            cd ~
            rm -rf "$BASE_DIR"
        else
            echo "å·²å–æ¶ˆå®‰è£…ã€‚"
            return
        fi
    fi

    echo -e "${GREEN}ğŸ“‚ åˆ›å»ºç›®å½•ç»“æ„...${NC}"
    mkdir -p "$BASE_DIR" && cd "$BASE_DIR"
    mkdir -p "$PROFILE_DIR" "$SCRIPT_DIR" "$LOG_DIR"

    # --- 1.1 Dockerfile ---
    cat << 'EOF' > Dockerfile
FROM node:20-bullseye
RUN apt-get update && apt-get install -y \
    xvfb x11vnc net-tools python3 git \
    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
    libxkbcommon0 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libpangocairo-1.0-0 \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY package.json .
RUN npm install
RUN npx playwright install --with-deps chromium
RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC \
    && git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
# å®‰å…¨ä¼ªè£…ï¼šè®¿é—®æ ¹è·¯å¾„æ˜¾ç¤º403
RUN echo '<html><head><title>403 Forbidden</title></head><body><h1>403 Forbidden</h1><p>Access Denied.</p></body></html>' > /opt/noVNC/index.html
COPY . .
RUN chmod +x entrypoint.sh
ENTRYPOINT ["/bin/bash", "/app/entrypoint.sh"]
EOF

    # --- 1.2 package.json ---
    cat << 'EOF' > package.json
{
  "name": "playwright-novnc",
  "version": "1.0.0",
  "dependencies": {
    "playwright": "latest"
  }
}
EOF

    # --- 1.3 entrypoint.sh (å¼•å¯¼è„šæœ¬) ---
    cat << 'EOF' > entrypoint.sh
#!/bin/bash
check_service() {
    local service=$1
    local cmd=$2
    echo "â³ ç­‰å¾… $service..."
    for i in {1..30}; do
        if eval "$cmd"; then echo "âœ… $service å°±ç»ª"; return 0; fi
        sleep 0.5
    done
    exit 1
}

echo "ğŸš€ å¯åŠ¨è™šæ‹Ÿæ˜¾å¡ Xvfb..."
Xvfb :99 -screen 0 1280x1024x24 &
check_service "Xvfb" "xdpyinfo -display :99 >/dev/null 2>&1"

echo "ğŸš€ å¯åŠ¨è¿œç¨‹æ¡Œé¢ x11vnc..."
x11vnc -display :99 -nopw -forever -shared -rfbport 5900 -bg
check_service "x11vnc" "netstat -tuln | grep -q ':5900 '"

echo "ğŸš€ å¯åŠ¨ç½‘é¡µä»£ç† noVNC..."
/opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
check_service "noVNC" "netstat -tuln | grep -q ':6080 '"

echo "========================================"
echo "ğŸ‰ ç¯å¢ƒå¯åŠ¨å®Œæ¯•ï¼Œç­‰å¾… run å‘½ä»¤..."
echo "========================================"
tail -f /dev/null
EOF

    # --- 1.4 docker-compose.yml ---
    cat << 'EOF' > docker-compose.yml
services:
  playwright-pro:
    build: .
    container_name: playwright_pro
    restart: always
    ports:
      - "6080:6080"
    environment:
      - DISPLAY=:99
      - TZ=Asia/Shanghai
    shm_size: '2gb'
    volumes:
      - ./:/app
      - /app/node_modules
EOF

    # --- 1.5 æ ¸å¿ƒå¯åŠ¨å™¨ launcher.js (Nodeç«¯) ---
    cat << 'JS' > launcher.js
const { chromium } = require('playwright');
const path = require('path');
const fs = require('fs');

const accountName = process.argv[2];
if (!accountName) { console.error('Need account name'); process.exit(1); }

const userDataDir = path.join(__dirname, 'profiles', accountName);
const scriptFile = path.join(__dirname, 'scripts', accountName + '.js');

(async () => {
    console.log(`\nğŸš€ [${accountName}] å¯åŠ¨ä¸­...`);
    try {
        const context = await chromium.launchPersistentContext(userDataDir, {
            headless: false,
            viewport: { width: 1200, height: 800 },
            args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-blink-features=AutomationControlled', '--ignore-certificate-errors']
        });

        const page = context.pages().length > 0 ? context.pages()[0] : await context.newPage();

        // --- æ ¸å¿ƒï¼šçƒ­æ›´æ–°æ³¨å…¥é€»è¾‘ ---
        const injectLogic = async () => {
             if (fs.existsSync(scriptFile)) {
                try {
                    const jsContent = fs.readFileSync(scriptFile, 'utf8');
                    console.log(`ğŸ’‰ æ³¨å…¥è„šæœ¬: scripts/${accountName}.js`);
                    await page.evaluate(jsContent);
                } catch (err) { console.error(`âš ï¸ æ³¨å…¥å¤±è´¥:`, err.message); }
            }
        };

        // 1. é¡µé¢åŠ è½½å®Œæˆæ—¶æ³¨å…¥
        page.on('domcontentloaded', injectLogic);
        
        // 2. åˆæ¬¡è¿è¡Œæ£€æµ‹
        if (!fs.existsSync(scriptFile)) console.log(`âš ï¸ æœªæ‰¾åˆ°è„šæœ¬: ${scriptFile}`);

        console.log('ğŸŒ æ‰“å¼€ Google...');
        await page.goto('https://accounts.google.com', { timeout: 60000 });
        
        // ä¿æŒè¿è¡Œ
        await new Promise(() => {});

    } catch (e) { console.error(`âŒ Error:`, e); }
})();
JS

    chmod +x entrypoint.sh
    
    echo -e "${YELLOW}âš™ï¸  å¼€å§‹æ„å»º Docker é•œåƒ (é¦–æ¬¡éœ€è¦å‡ åˆ†é’Ÿ)...${NC}"
    docker-compose up --build -d
    
    echo ""
    echo -e "${GREEN}âœ… éƒ¨ç½²å®Œæˆï¼${NC}"
    echo "æŒ‰å›è½¦é”®è¿”å›èœå•..."
    read
}

# =================================================================
#  2. å¯åŠ¨/æ–°å»º è´¦å·
# =================================================================
run_account() {
    check_install || return

    echo "========================================"
    echo "  ğŸš€ å¯åŠ¨/æ–°å»º è´¦å·"
    echo "========================================"
    echo "ç°æœ‰è´¦å·:"
    ls "$PROFILE_DIR" 2>/dev/null | xargs -n 1 echo "   ğŸ‘¤ " || echo "   (æ— )"
    echo "----------------------------------------"
    read -p "ğŸ‘‰ è¯·è¾“å…¥è´¦å·åç§° (å¦‚ user1): " ACCOUNT

    if [ -z "$ACCOUNT" ]; then echo -e "${RED}åç§°ä¸èƒ½ä¸ºç©º${NC}"; return; fi

    # 1. è‡ªåŠ¨ç”Ÿæˆè„šæœ¬æ¨¡æ¿
    SCRIPT_PATH="$SCRIPT_DIR/${ACCOUNT}.js"
    if [ ! -f "$SCRIPT_PATH" ]; then
        echo -e "${GREEN}ğŸ“„ æ–°å»ºæ³¨å…¥è„šæœ¬: $SCRIPT_PATH${NC}"
        cat << TEMPLATE > "$SCRIPT_PATH"
// [${ACCOUNT}] ä¸“å±è„šæœ¬
// ä¿®æ”¹æ­¤æ–‡ä»¶ä¿å­˜åï¼Œåœ¨ VNC æµè§ˆå™¨ç‚¹å‡»ã€åˆ·æ–°ã€‘å³å¯ç”Ÿæ•ˆ
console.log("%c ğŸš€ ${ACCOUNT} è„šæœ¬æ³¨å…¥æˆåŠŸ!", "color:green; font-size:16px");
document.body.style.border = "5px solid green";
TEMPLATE
    fi

    # 2. æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ
    if docker-compose exec -T playwright-pro pgrep -f "launcher.js $ACCOUNT" >/dev/null; then
        echo -e "${YELLOW}âš ï¸  è¯¥è´¦å·å·²ç»åœ¨è¿è¡Œä¸­ï¼${NC}"
        read -p "æ˜¯å¦é‡å¯? (y/n): " restart
        if [[ "$restart" == "y" ]]; then
            docker-compose exec -T playwright-pro pkill -f "launcher.js $ACCOUNT"
            sleep 1
        else
            return
        fi
    fi

    # 3. å‘é€å¯åŠ¨æŒ‡ä»¤
    echo "ğŸš€ æ­£åœ¨åå°å¯åŠ¨..."
    docker-compose exec -d playwright-pro bash -c "nohup node launcher.js $ACCOUNT > logs/${ACCOUNT}.log 2>&1 &"
    
    sleep 2
    echo -e "${GREEN}âœ… å¯åŠ¨æˆåŠŸï¼${NC}"
    echo "----------------------------------------"
    echo "ğŸ“º VNC åœ°å€: http://$(curl -s ifconfig.me):6080/vnc.html"
    echo "ğŸ“ ä¿®æ”¹è„šæœ¬: vim $BASE_DIR/scripts/${ACCOUNT}.js"
    echo "ğŸ“œ æŸ¥çœ‹æ—¥å¿—: tail -f $BASE_DIR/logs/${ACCOUNT}.log"
    echo "----------------------------------------"
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# =================================================================
#  3. åˆ é™¤/æ¸…ç† è´¦å·
# =================================================================
delete_account() {
    check_install || return

    echo "========================================"
    echo "  ğŸ—‘ï¸  åˆ é™¤è´¦å· (æ…ç”¨)"
    echo "========================================"
    ls "$PROFILE_DIR" 2>/dev/null | xargs -n 1 echo "   ğŸ“‚ " || echo "   (æ— )"
    echo "----------------------------------------"
    read -p "ğŸ‘‰ è¾“å…¥è¦åˆ é™¤çš„è´¦å·å: " ACCOUNT

    if [ -z "$ACCOUNT" ] || [ ! -d "$PROFILE_DIR/$ACCOUNT" ]; then
        echo -e "${RED}æ‰¾ä¸åˆ°è¯¥è´¦å·${NC}"; return
    fi

    echo -e "${RED}âš ï¸  è­¦å‘Šï¼šå°†æ°¸ä¹…åˆ é™¤ [$ACCOUNT] çš„æ‰€æœ‰æ•°æ®(Cookie/è„šæœ¬/æ—¥å¿—)${NC}"
    read -p "ğŸ”´ ç¡®è®¤åˆ é™¤? (è¾“å…¥ y ç¡®è®¤): " confirm
    if [[ "$confirm" != "y" ]]; then echo "å–æ¶ˆ"; return; fi

    # 1. æ€è¿›ç¨‹
    docker-compose exec -T playwright-pro pkill -f "launcher.js $ACCOUNT" 2>/dev/null

    # 2. åˆ æ–‡ä»¶
    rm -rf "$PROFILE_DIR/$ACCOUNT"
    rm -f "$SCRIPT_DIR/${ACCOUNT}.js"
    rm -f "$LOG_DIR/${ACCOUNT}.log"

    echo -e "${GREEN}âœ… è´¦å· [$ACCOUNT] å·²å½»åº•æ¸…é™¤${NC}"
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# =================================================================
#  è¾…åŠ©å‡½æ•°
# =================================================================
check_install() {
    if [ ! -d "$BASE_DIR" ]; then
        echo -e "${RED}âŒ æœªæ£€æµ‹åˆ°å®‰è£…ç›®å½•ï¼Œè¯·å…ˆæ‰§è¡Œ [1] å®‰è£…éƒ¨ç½²${NC}"
        read -p "æŒ‰å›è½¦é”®è¿”å›..."
        return 1
    fi
    cd "$BASE_DIR"
}

view_logs() {
    check_install || return
    echo "ç°æœ‰æ—¥å¿—:"
    ls "$LOG_DIR" 2>/dev/null
    read -p "è¾“å…¥è´¦å·åæŸ¥çœ‹æ—¥å¿—: " acc
    if [ -f "$LOG_DIR/${acc}.log" ]; then
        tail -f "$LOG_DIR/${acc}.log"
    else
        echo "æ— æ—¥å¿—æ–‡ä»¶"
    fi
}

show_status() {
    check_install || return
    echo "========================================"
    echo "  è¿è¡ŒçŠ¶æ€ç›‘æ§"
    echo "========================================"
    echo "æ­£åœ¨è¿è¡Œçš„æµè§ˆå™¨å®ä¾‹:"
    docker-compose exec -T playwright-pro ps -ef | grep "launcher.js" | grep -v grep | awk '{print "   ğŸŸ¢ " $9 " (PID: " $2 ")"}' | sed 's/.*\///'
    echo "----------------------------------------"
    read -p "æŒ‰å›è½¦é”®è¿”å›..."
}

# =================================================================
#  ä¸»èœå•
# =================================================================
while true; do
    clear
    echo "========================================"
    echo "  Playwright + noVNC ç®¡ç†ç³»ç»Ÿ"
    echo "========================================"
    echo "1. ğŸ› ï¸  ä¸€é”®å®‰è£…éƒ¨ç½² (ç¯å¢ƒé‡ç½®)"
    echo "2. ğŸš€ å¯åŠ¨/æ–°å»º è´¦å· (è‡ªåŠ¨åˆ›å»ºè„šæœ¬)"
    echo "3. ğŸ—‘ï¸  åˆ é™¤è´¦å· (æ¸…ç†æ‰€æœ‰æ•°æ®)"
    echo "4. ğŸ“œ æŸ¥çœ‹æ—¥å¿—"
    echo "5. ğŸ“Š æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo "0. ğŸšª é€€å‡º"
    echo "========================================"
    read -p "è¯·é€‰æ‹© [0-5]: " choice

    case $choice in
        1) install_environment ;;
        2) run_account ;;
        3) delete_account ;;
        4) view_logs ;;
        5) show_status ;;
        0) exit 0 ;;
        *) echo "æ— æ•ˆé€‰æ‹©" ;;
    esac
done
