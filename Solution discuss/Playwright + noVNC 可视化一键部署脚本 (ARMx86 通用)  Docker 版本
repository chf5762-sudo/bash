# ==========================================
# Playwright + noVNC å¯è§†åŒ–ä¸€é”®éƒ¨ç½²è„šæœ¬ (ARM/x86 é€šç”¨)
# ==========================================

# 1. å‡†å¤‡å·¥ä½œç›®å½•
cd ~
mkdir -p ~/playwright && cd ~/playwright

# 2. ç¼–å†™ Dockerfile (é›†æˆæ‰€æœ‰æµè§ˆå™¨åº•å±‚ä¾èµ–)
cat << 'EOF' > Dockerfile
FROM node:20-bullseye

# å®‰è£… X11 è™šæ‹Ÿæ˜¾ç¤ºã€VNC æœåŠ¡åŠæµè§ˆå™¨è¿è¡Œå¿…å¤‡çš„ 10 å¤šä¸ªåº•å±‚åº“
RUN apt-get update && apt-get install -y \
    xvfb x11vnc net-tools python3 git \
    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
    libxkbcommon0 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libpangocairo-1.0-0 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# å®‰è£… Playwright å¹¶ä¸‹è½½ Chromium å†…æ ¸ (ARM å…¼å®¹ç‰ˆ)
RUN npm install playwright
RUN npx playwright install --with-deps chromium

# å®‰è£… noVNC ç½‘é¡µå®¢æˆ·ç«¯
RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC \
    && git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify \
    && ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

COPY . .
RUN chmod +x entrypoint.sh

ENTRYPOINT ["/bin/bash", "/app/entrypoint.sh"]
EOF

# 3. ç¼–å†™ å¯åŠ¨å…¥å£è„šæœ¬
cat << 'EOF' > entrypoint.sh
#!/bin/bash
# å¯åŠ¨è™šæ‹Ÿå±å¹• (1280x1024 24ä½è‰²)
Xvfb :99 -screen 0 1280x1024x24 &
sleep 2

# å¯åŠ¨ VNC æœåŠ¡ (æ— å¯†ç æ¨¡å¼)
x11vnc -display :99 -nopw -forever -shared -bg

# å¯åŠ¨ noVNC ç½‘é¡µä»£ç† (ç›‘å¬ 6080 ç«¯å£)
/opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

echo "--- ğŸ–¥ï¸  GUI ç¯å¢ƒå·²å°±ç»ªï¼Œæ­£åœ¨å¯åŠ¨ Playwright ---"
# è¿è¡Œä¸šåŠ¡è„šæœ¬
node test.js
wait
EOF

# 4. ç¼–å†™ Docker Compose é…ç½®
cat << 'EOF' > docker-compose.yml
services:
  playwright-app:
    build: .
    ports:
      - "6080:6080"
    environment:
      - DISPLAY=:99
    shm_size: '2gb' # å¢åŠ å…±äº«å†…å­˜ï¼Œé˜²æ­¢æµè§ˆå™¨å´©æºƒ
EOF

# 5. ç¼–å†™ ç¤ºä¾‹æµ‹è¯•è„šæœ¬ (å¸¦åçˆ¬å’Œæ²™ç›’å‚æ•°)
cat << 'EOF' > test.js
const { chromium } = require('playwright');
(async () => {
  console.log('ğŸš€ æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...');
  try {
    const browser = await chromium.launch({ 
      headless: false, // å¿…é¡»ä¸º false æ‰èƒ½åœ¨ VNC çœ‹åˆ°ç”»é¢
      args: [
        '--no-sandbox', 
        '--disable-setuid-sandbox', 
        '--disable-dev-shm-usage'
      ] 
    });
    const page = await browser.newPage();
    await page.setViewportSize({ width: 1280, height: 800 });
    
    console.log('ğŸŒ æ­£åœ¨æ‰“å¼€é¡µé¢...');
    await page.goto('https://www.google.com');
    
    const title = await page.title();
    console.log('âœ… æˆåŠŸï¼å½“å‰é¡µé¢æ ‡é¢˜:', title);
    console.log('ğŸ“º è¯·è®¿é—® http://YOUR_IP:6080 æŸ¥çœ‹å®æ—¶ç”»é¢');
    
    // ä¿æŒè¿›ç¨‹ä¸é€€å‡ºï¼Œæ–¹ä¾¿è§‚å¯Ÿ
    await new Promise(() => {}); 
  } catch (e) {
    console.error('âŒ è¿è¡Œå¤±è´¥:', e);
  }
})();
EOF

# 6. ç»™æƒé™å¹¶å¯åŠ¨
chmod +x entrypoint.sh
docker-compose up --build -d

echo "=========================================="
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "è¯·è®¿é—®: http://$(curl -s ifconfig.me):6080"
echo "ä½¿ç”¨ 'docker-compose logs -f' æŸ¥çœ‹å®æ—¶æ—¥å¿—"
echo "=========================================="
