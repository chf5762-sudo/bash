# 1. åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡
sudo systemctl stop selenium-browser 2>/dev/null
docker stop firefox-selenium
docker rm firefox-selenium

# 2. åˆ é™¤æœ‰é—®é¢˜çš„æ•°æ®ç›®å½•
rm -rf ~/firefox-data

# 3. é‡æ–°åˆ›å»ºå®¹å™¨(ä¸æŒ‚è½½æ•°æ®å·)
docker run -d \
  --name firefox-selenium \
  --restart=unless-stopped \
  -p 4444:4444 \
  -p 7900:7900 \
  -e SE_VNC_NO_PASSWORD=1 \
  -e SE_SCREEN_WIDTH=1920 \
  -e SE_SCREEN_HEIGHT=1080 \
  --shm-size=2g \
  seleniarm/standalone-firefox

# 4. ç­‰å¾…å……åˆ†å¯åŠ¨
echo "ç­‰å¾… Firefox å®Œå…¨å¯åŠ¨(60ç§’)..."
for i in {1..60}; do
    echo -n "."
    sleep 1
done
echo ""

# 5. éªŒè¯å°±ç»ª
curl http://localhost:4444/status | grep "ready"

# 6. åˆ›å»ºæ”¹è¿›çš„å¯åŠ¨è„šæœ¬(å¸¦å¥åº·æ£€æŸ¥)
cat > /root/keep_browser_alive.py << 'EOF'
from selenium import webdriver
from selenium.common.exceptions import WebDriverException
import time
import sys
import requests

print("=" * 60)
print("ðŸ¦Š Selenium Firefox è‡ªåŠ¨å¯åŠ¨æœåŠ¡")
print("=" * 60)

def wait_for_selenium_ready(max_wait=60):
    """ç­‰å¾… Selenium Grid çœŸæ­£å°±ç»ª"""
    print("\nç­‰å¾… Selenium Grid å°±ç»ª...")
    for i in range(max_wait):
        try:
            resp = requests.get('http://localhost:4444/status', timeout=2)
            data = resp.json()
            if data.get('value', {}).get('ready'):
                print(f"âœ“ Selenium Grid å°±ç»ª(ç­‰å¾…äº† {i+1} ç§’)")
                # é¢å¤–ç­‰å¾… Firefox å®Œå…¨å‡†å¤‡
                print("é¢å¤–ç­‰å¾… 15 ç§’ç¡®ä¿ Firefox å®Œå…¨å‡†å¤‡...")
                time.sleep(15)
                return True
        except:
            pass
        time.sleep(1)
        if i % 10 == 0:
            print(f"  ç­‰å¾…ä¸­... ({i}/{max_wait})")
    return False

# ç­‰å¾… Selenium å°±ç»ª
if not wait_for_selenium_ready():
    print("âŒ Selenium Grid å¯åŠ¨è¶…æ—¶")
    sys.exit(1)

max_retries = 5
retry_count = 0

while retry_count < max_retries:
    try:
        print(f"\n[å°è¯• {retry_count + 1}/{max_retries}] åˆ›å»º Firefox session...")
        
        options = webdriver.FirefoxOptions()
        # ä½¿ç”¨å®¹å™¨å†…çš„ä¸´æ—¶é…ç½®,é¿å…æƒé™é—®é¢˜
        options.set_preference('browser.cache.disk.parent_directory', '/tmp/firefox-cache')
        
        driver = webdriver.Remote(
            command_executor='http://localhost:4444',
            options=options
        )
        
        driver.set_page_load_timeout(30)
        
        print("âœ… Firefox å·²å¯åŠ¨!")
        driver.get('https://www.google.com')
        
        print(f"ðŸ“º noVNC: http://localhost:7900/")
        print("ðŸ”„ æµè§ˆå™¨ä¿æŒè¿è¡Œä¸­...")
        print("=" * 60)
        
        # æˆåŠŸ,é‡ç½®è®¡æ•°
        retry_count = 0
        
        # ä¿æŒè¿è¡Œ
        while True:
            try:
                driver.current_url
                time.sleep(300)
            except:
                print("\nâš ï¸ è¿žæŽ¥æ–­å¼€")
                raise
                
    except KeyboardInterrupt:
        print("\næ”¶åˆ°åœæ­¢ä¿¡å·")
        try:
            driver.quit()
        except:
            pass
        sys.exit(0)
        
    except Exception as e:
        retry_count += 1
        print(f"âŒ é”™è¯¯: {str(e)[:150]}")
        
        try:
            driver.quit()
        except:
            pass
        
        if retry_count < max_retries:
            wait = retry_count * 10
            print(f"ç­‰å¾… {wait} ç§’åŽé‡è¯•...")
            time.sleep(wait)
        else:
            print(f"âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")
            sys.exit(1)
EOF

# 7. æ‰‹åŠ¨æµ‹è¯•
python3 /root/keep_browser_alive.py
```

è¿™æ¬¡æ”¹è¿›:
- âœ… **ä¸æŒ‚è½½æ•°æ®å·** - é¿å…æƒé™é—®é¢˜
- âœ… **å¥åº·æ£€æŸ¥** - ç¡®ä¿ Selenium çœŸæ­£å°±ç»ª
- âœ… **é¢å¤–ç­‰å¾…** - ç»™ Firefox å……åˆ†å¯åŠ¨æ—¶é—´
- âœ… **ä¸´æ—¶é…ç½®** - ä½¿ç”¨å®¹å™¨å†… /tmp,æ— æƒé™é—®é¢˜

## ðŸ“Š æ‰§è¡ŒåŽåº”è¯¥çœ‹åˆ°:
```
ç­‰å¾… Selenium Grid å°±ç»ª...
âœ“ Selenium Grid å°±ç»ª(ç­‰å¾…äº† X ç§’)
é¢å¤–ç­‰å¾… 15 ç§’ç¡®ä¿ Firefox å®Œå…¨å‡†å¤‡...

[å°è¯• 1/5] åˆ›å»º Firefox session...
âœ… Firefox å·²å¯åŠ¨!
ðŸ“º noVNC: http://localhost:7900/
