#!/bin/bash

# ==========================================
# Playwright + noVNC (å®‰å…¨éšè”½ + æŒä¹…åŒ–ç‰ˆ)
# ==========================================

# 1. æ¸…ç†æ—§ç¯å¢ƒ
if [ -d ~/playwright-pro ]; then
    echo "ğŸ§¹ æ£€æµ‹åˆ°æ—§ç›®å½•ï¼Œæ­£åœ¨æ¸…ç†..."
    cd ~/playwright-pro
    docker-compose down 2>/dev/null
    cd ~
fi

mkdir -p ~/playwright-pro && cd ~/playwright-pro

# åˆ›å»ºæœ¬åœ°æ•°æ®ç›®å½• (ç”¨äºæŒä¹…åŒ–)
mkdir -p user_data

# 2. ç¼–å†™ Dockerfile (ä¿æŒä¸å˜)
cat << 'EOF' > Dockerfile
FROM node:20-bullseye

# å®‰è£…åº•å±‚å›¾å½¢ä¾èµ–
RUN apt-get update && apt-get install -y \
    xvfb x11vnc net-tools python3 git \
    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
    libxkbcommon0 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libpangocairo-1.0-0 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY package.json .
RUN npm install
RUN npx playwright install --with-deps chromium

# å®‰è£… noVNC
RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC \
    && git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify

# ã€å®‰å…¨ä¿®æ”¹ã€‘
RUN echo '<html><head><title>403 Forbidden</title></head><body><h1>403 Forbidden</h1><p>Access Denied.</p></body></html>' > /opt/noVNC/index.html

COPY . .
RUN chmod +x entrypoint.sh

ENTRYPOINT ["/bin/bash", "/app/entrypoint.sh"]
EOF

# 3. ç¼–å†™ package.json (ä¿æŒä¸å˜)
cat << 'EOF' > package.json
{
  "name": "playwright-novnc",
  "version": "1.0.0",
  "dependencies": {
    "playwright": "latest"
  }
}
EOF

# 4. ç¼–å†™ å¯åŠ¨è„šæœ¬ entrypoint.sh (ä¿æŒä¸å˜)
cat << 'EOF' > entrypoint.sh
#!/bin/bash

check_service() {
    local service_name=$1
    local check_cmd=$2
    echo "â³ ç­‰å¾… $service_name å°±ç»ª..."
    for i in {1..30}; do
        if eval "$check_cmd"; then
            echo "âœ… $service_name å·²å¯åŠ¨"
            return 0
        fi
        sleep 0.5
    done
    echo "âŒ $service_name å¯åŠ¨è¶…æ—¶ï¼Œè„šæœ¬ç»ˆæ­¢"
    exit 1
}

echo "ğŸš€ [1/4] å¯åŠ¨ Xvfb..."
Xvfb :99 -screen 0 1280x1024x24 &
check_service "Xvfb" "xdpyinfo -display :99 >/dev/null 2>&1"

echo "ğŸš€ [2/4] å¯åŠ¨ x11vnc..."
x11vnc -display :99 -nopw -forever -shared -rfbport 5900 -bg
check_service "x11vnc" "netstat -tuln | grep -q ':5900 '"

echo "ğŸš€ [3/4] å¯åŠ¨ noVNC..."
/opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
check_service "noVNC" "netstat -tuln | grep -q ':6080 '"

echo "ğŸš€ [4/4] å¯åŠ¨ inject.js (æŒä¹…åŒ–æ¨¡å¼)..."
node inject.js &

echo "========================================"
echo "ğŸ‰ GUI ç¯å¢ƒå·²å°±ç»ª (æ•°æ®å·²æŒä¹…åŒ–)"
echo "========================================"

tail -f /dev/null
EOF

# 5. ç¼–å†™ docker-compose.yml (ğŸ”´ å·²ä¿®æ”¹ï¼šå¢åŠ  user_data æ˜ å°„)
cat << 'EOF' > docker-compose.yml
services:
  playwright-pro:
    build: .
    container_name: playwright_pro
    restart: always
    ports:
      - "6080:6080"
    environment:
      - DISPLAY=:99
      - TZ=Asia/Shanghai
    shm_size: '2gb'
    volumes:
      - ./:/app              # ä»£ç æ˜ å°„
      - /app/node_modules    # ä¿æŠ¤ node_modules
      - ./user_data:/app/user_data  # ğŸ”´ æ•°æ®æŒä¹…åŒ–æ˜ å°„
EOF

# 6. ç¼–å†™ ä¸šåŠ¡è„šæœ¬ inject.js (ğŸ”´ å·²ä¿®æ”¹ï¼šä½¿ç”¨ launchPersistentContext)
cat << 'EOF' > inject.js
const { chromium } = require('playwright');

(async () => {
  console.log('ğŸ”„ [inject.js] å¯åŠ¨ä¸­ (æŒä¹…åŒ–æ¨¡å¼)...');
  
  // å®šä¹‰æ•°æ®å­˜å‚¨è·¯å¾„ (å¯¹åº” docker-compose ä¸­çš„æ˜ å°„è·¯å¾„)
  const userDataDir = '/app/user_data';

  try {
    // ğŸ”´ æ”¹åŠ¨ç‚¹ï¼šä½¿ç”¨ launchPersistentContext æ›¿ä»£ launch
    const context = await chromium.launchPersistentContext(userDataDir, { 
      headless: false,
      viewport: { width: 1280, height: 1024 }, // æŒä¹…åŒ–æ¨¡å¼ä¸‹ viewport éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
      args: ['--no-sandbox', '--disable-setuid-sandbox', '--ignore-certificate-errors'] 
    });
    
    // æŒä¹…åŒ–æ¨¡å¼é»˜è®¤ä¼šæ‰“å¼€ä¸€ä¸ªé¡µé¢ï¼Œæˆ–è€…æˆ‘ä»¬è·å–ç°æœ‰çš„
    const page = context.pages().length > 0 ? context.pages()[0] : await context.newPage();

    console.log('ğŸŒ è®¿é—® Google...');
    await page.goto('https://www.google.com');
    console.log('âœ… é¡µé¢æ ‡é¢˜:', await page.title());
    
    let count = 0;
    setInterval(async () => {
        count++;
        console.log(`ğŸ’“ [inject.js] è¿è¡Œä¸­... (${count})`);
    }, 5000);

  } catch (e) {
    console.error('âŒ è¿è¡Œå‡ºé”™:', e);
  }
})();
EOF

# 7. å¯åŠ¨
chmod +x entrypoint.sh
echo "---------------------------------------------"
echo "âš™ï¸  æ­£åœ¨é‡æ–°æ„å»º (å·²å¯ç”¨æ•°æ®æŒä¹…åŒ–)..."
echo "---------------------------------------------"

if docker-compose up --build -d; then
    IP=$(curl -s ifconfig.me)
    echo ""
    echo "============================================="
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
    echo "ğŸ“‚ æ•°æ®å­˜å‚¨ç›®å½•: ~/playwright-pro/user_data"
    echo ""
    echo "â›”ï¸ ä¼ªè£…åœ°å€ (403): http://$IP:6080/"
    echo "ğŸ” çœŸå®åœ°å€ (VNC): http://$IP:6080/vnc.html"
    echo "============================================="
else
    echo "âŒ éƒ¨ç½²å¤±è´¥"
fi
