#!/bin/bash

# ====================================================
# Playwright å¤šç”¨æˆ·ç‰ˆ (éšåŒ¿å¢å¼º + è¿‡ Google æ£€æµ‹)
# ====================================================

BASE_DIR="$HOME/playwright"
mkdir -p "$BASE_DIR/base"
mkdir -p "$BASE_DIR/workspaces"

# ----------------------------------------------------
# 1. å‡çº§ Dockerfile (å¢åŠ å­—ä½“åº“ + éšåŒ¿æ’ä»¶)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/Dockerfile"
FROM node:20-bullseye

# 1. å®‰è£…ç³»ç»Ÿä¾èµ– + å¸¸ç”¨å­—ä½“ (è¿‡ Canvas æŒ‡çº¹æ£€æµ‹çš„å…³é”®)
# fonts-liberation, fonts-noto, ttf-wqy-zenhei (ä¸­æ–‡å­—ä½“)
RUN apt-get update && apt-get install -y \
    xvfb x11vnc net-tools python3 git \
    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
    libxkbcommon0 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libpangocairo-1.0-0 \
    fonts-liberation fonts-noto-cjk ttf-wqy-zenhei fonts-freefont-ttf \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY package.json .
# 2. å®‰è£… Playwright åŠ Stealth æ’ä»¶
RUN npm install
RUN npx playwright install --with-deps chromium

# 3. å®‰è£… noVNC
RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC \
    && git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
RUN echo '<html><head><title>403 Forbidden</title></head><body><h1>403 Forbidden</h1><p>Access Denied.</p></body></html>' > /opt/noVNC/index.html

COPY entrypoint.sh .
RUN chmod +x entrypoint.sh

ENTRYPOINT ["/bin/bash", "/app/entrypoint.sh"]
EOF

# ----------------------------------------------------
# 2. å‡çº§ package.json (å¼•å…¥ playwright-extra)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/package.json"
{
  "name": "playwright-stealth-base",
  "dependencies": {
    "playwright": "latest",
    "playwright-extra": "^4.3.6",
    "puppeteer-extra-plugin-stealth": "^2.11.2"
  }
}
EOF

# ----------------------------------------------------
# 3. entrypoint.sh (ä¿æŒä¸¥æ ¼çš„è¿æ¥æ£€æŸ¥é€»è¾‘)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/entrypoint.sh"
#!/bin/bash

check_service() {
    local service_name=$1
    local check_cmd=$2
    echo "â³ ç­‰å¾… $service_name å°±ç»ª..."
    for i in {1..30}; do
        if eval "$check_cmd"; then
            echo "âœ… $service_name å·²å¯åŠ¨"
            return 0
        fi
        sleep 0.5
    done
    echo "âŒ $service_name å¯åŠ¨è¶…æ—¶"
    exit 1
}

echo "ğŸš€ [1/4] å¯åŠ¨ Xvfb..."
Xvfb :99 -screen 0 1280x1024x24 &
check_service "Xvfb" "xdpyinfo -display :99 >/dev/null 2>&1"

echo "ğŸš€ [2/4] å¯åŠ¨ x11vnc..."
x11vnc -display :99 -nopw -forever -shared -rfbport 5900 -bg
check_service "x11vnc" "netstat -tuln | grep -q ':5900 '"

echo "ğŸš€ [3/4] å¯åŠ¨ noVNC..."
/opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
check_service "noVNC" "netstat -tuln | grep -q ':6080 '"

echo "ğŸš€ [4/4] å¯åŠ¨ Stealth è„šæœ¬..."
if [ -f "inject.js" ]; then
    node inject.js &
else
    echo "âš ï¸ æœªæ‰¾åˆ° inject.js"
fi

tail -f /dev/null
EOF

# ----------------------------------------------------
# 4. å‡çº§ manager.sh (æ³¨å…¥éšåŒ¿ä»£ç æ¨¡æ¿)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/manager.sh"
#!/bin/bash

BASE_DIR="$HOME/playwright"
WORKSPACES="$BASE_DIR/workspaces"
# ä¿®æ”¹é•œåƒåä»¥å¼ºåˆ¶æ›´æ–°
IMAGE_NAME="playwright-stealth-v2"
GREEN='\033[0;32m'
NC='\033[0m'

build_image() {
    if [[ "$(docker images -q $IMAGE_NAME 2> /dev/null)" == "" ]] || [[ "$1" == "force" ]]; then
        echo -e "${GREEN}âš™ï¸  æ­£åœ¨æ„å»ºéšåŒ¿ç‰ˆé•œåƒ (éœ€ä¸‹è½½å­—ä½“å’Œæ’ä»¶ï¼Œæ—¶é—´ç¨é•¿)...${NC}"
        cd "$BASE_DIR/base"
        docker build -t $IMAGE_NAME .
    fi
}

get_next_port() {
    local max_port=6080
    for file in "$WORKSPACES"/*/docker-compose.yml; do
        if [ -f "$file" ]; then
            curr=$(grep -oP '(?<=- ")\d+(?=:6080")' "$file" | head -n 1)
            if [[ "$curr" -gt "$max_port" ]]; then max_port=$curr; fi
        fi
    done
    echo $((max_port + 1))
}

generate_workspace() {
    local USER_NAME=$1
    local PORT=$2
    TARGET_DIR="$WORKSPACES/$USER_NAME"
    
    if [ -d "$TARGET_DIR" ]; then echo "ç”¨æˆ·å­˜åœ¨"; return; fi

    echo -e "${GREEN}ğŸ”¨ åˆ›å»ºéšåŒ¿ç”¨æˆ·: $USER_NAME ($PORT)${NC}"
    mkdir -p "$TARGET_DIR/user_data"

    cat << YML > "$TARGET_DIR/docker-compose.yml"
services:
  app:
    image: $IMAGE_NAME
    container_name: pw_${USER_NAME}
    restart: always
    ports:
      - "${PORT}:6080"
    environment:
      - DISPLAY=:99
      - TZ=Asia/Shanghai
    shm_size: '2gb'
    volumes:
      - ./inject.js:/app/inject.js
      - ./user_data:/app/user_data
YML

    # ==========================================
    # æ ¸å¿ƒä¿®æ”¹ï¼šinject.js å¼•å…¥ Stealth é€»è¾‘
    # ==========================================
    cat << JS > "$TARGET_DIR/inject.js"
// ä½¿ç”¨ playwright-extra åŒ…è£…å™¨
const { chromium } = require('playwright-extra');
const stealth = require('puppeteer-extra-plugin-stealth')();

// åŠ è½½éšåŒ¿æ’ä»¶
chromium.use(stealth);

(async () => {
  console.log('ğŸ•µï¸ [Stealth Mode] ç”¨æˆ·: $USER_NAME å¯åŠ¨ä¸­...');
  const userDataDir = '/app/user_data';
  
  try {
    const context = await chromium.launchPersistentContext(userDataDir, { 
      headless: false,
      viewport: { width: 1280, height: 1024 },
      // å…³é”®å‚æ•°ï¼šç¦ç”¨è‡ªåŠ¨åŒ–æ§åˆ¶ç‰¹å¾
      args: [
        '--disable-blink-features=AutomationControlled',
        '--no-sandbox',
        '--disable-setuid-sandbox'
      ],
      // æ¨¡æ‹ŸçœŸå® User-Agent (Win10 Chrome)
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    });
    
    const page = context.pages().length > 0 ? context.pages()[0] : await context.newPage();
    
    // æ³¨å…¥ webdriver å±æ€§ç§»é™¤ (åŒé‡ä¿é™©)
    await page.addInitScript(() => {
        Object.defineProperty(navigator, 'webdriver', {
            get: () => undefined,
        });
    });

    console.log('ğŸŒ æ­£åœ¨è®¿é—® Google æ£€æµ‹ç‚¹...');
    await page.goto('https://www.google.com');
    
    console.log('âœ… Title: ' + await page.title());
    
    // é˜²æ­¢è¿›ç¨‹é€€å‡º
    setInterval(() => {}, 10000); 

  } catch (e) { console.error(e); }
})();
JS

    cd "$TARGET_DIR" && docker-compose up -d >/dev/null 2>&1
    IP=$(curl -s ifconfig.me)
    echo -e "âœ… å¯åŠ¨: http://$IP:$PORT/vnc.html"
}

create_default() {
    build_image
    if [ ! -d "$WORKSPACES/default" ]; then generate_workspace "default" "6080"; fi
}
add_new_user() {
    build_image
    generate_workspace "$1" "$(get_next_port)"
}
delete_user() {
    TARGET_DIR="$WORKSPACES/$1"
    [ -d "$TARGET_DIR" ] && (cd "$TARGET_DIR" && docker-compose down >/dev/null 2>&1; cd .. && rm -rf "$TARGET_DIR"; echo "å·²åˆ é™¤")
}
list_users() {
    for dir in "$WORKSPACES"/*/; do [ -d "$dir" ] && echo "$(basename "$dir")"; done
}

case "$1" in
    init)  create_default ;;
    add)   add_new_user "$2" ;;
    del)   delete_user "$2" ;;
    list)  list_users ;;
    build) build_image force ;;
esac
EOF

chmod +x "$BASE_DIR/manager.sh"

# ====================================================
# 5. æ‰§è¡Œæ¸…ç†å¹¶åº”ç”¨æ–°é•œåƒ
# ====================================================

echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§å®¹å™¨ä»¥åº”ç”¨ Stealth è¡¥ä¸..."
if [ -d "$BASE_DIR/workspaces/default" ]; then
    cd "$BASE_DIR/workspaces/default" && docker-compose down 2>/dev/null
fi

echo "ğŸ”„ æ­£åœ¨æ„å»ºéšåŒ¿ç‰ˆç¯å¢ƒ (è¿™æ­¥ä¼šä¸‹è½½å­—ä½“å’Œæ’ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…)..."
"$BASE_DIR/manager.sh" build force
"$BASE_DIR/manager.sh" init

IP=$(curl -s ifconfig.me)
echo ""
echo "==========================================="
echo "ğŸ•µï¸  éšåŒ¿ç‰ˆ (Stealth) éƒ¨ç½²æˆåŠŸï¼"
echo "==========================================="
echo "1. é»˜è®¤è´¦æˆ· (6080) å·²åº”ç”¨åçˆ¬ç­–ç•¥ã€‚"
echo "   âœ http://$IP:6080/vnc.html"
echo ""
echo "2. éªŒè¯ä¼ªè£…æ•ˆæœï¼š"
echo "   è¯·åœ¨ VNC æµè§ˆå™¨ä¸­è®¿é—® https://bot.sannysoft.com/"
echo "   ä½ åº”è¯¥èƒ½çœ‹åˆ° WebDriver é¡¹ä¸º 'missing' (ç»¿è‰²)ã€‚"
echo "==========================================="
