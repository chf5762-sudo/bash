#!/bin/bash

# ====================================================
# Playwright ä¿®å¤ç‰ˆ V5 (ç»å¯¹è·¯å¾„ + Hot Reload çƒ­é‡è½½)
# ====================================================

BASE_DIR="$HOME/playwright"
mkdir -p "$BASE_DIR/base"
mkdir -p "$BASE_DIR/workspaces"

# ----------------------------------------------------
# 1. Dockerfile (æ–°å¢ nodemon)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/Dockerfile"
FROM node:20-bullseye

RUN apt-get update && apt-get install -y \
    xvfb x11vnc net-tools python3 git \
    libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
    libxkbcommon0 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libpangocairo-1.0-0 \
    fonts-liberation fonts-noto-cjk ttf-wqy-zenhei fonts-freefont-ttf \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY package.json .
RUN npm install
# ğŸ”¥ æ–°å¢ï¼šå®‰è£… nodemon ç”¨äºçƒ­é‡è½½
RUN npm install -g nodemon
RUN npx playwright install --with-deps chromium

RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC \
    && git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
RUN echo '<html><head><title>403 Forbidden</title></head><body><h1>403 Forbidden</h1><p>Access Denied.</p></body></html>' > /opt/noVNC/index.html

COPY entrypoint.sh .
RUN chmod +x entrypoint.sh

ENTRYPOINT ["/bin/bash", "/app/entrypoint.sh"]
EOF

# ----------------------------------------------------
# 2. package.json
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/package.json"
{
  "name": "playwright-stealth-base",
  "dependencies": {
    "playwright": "latest",
    "playwright-extra": "^4.3.6",
    "puppeteer-extra-plugin-stealth": "^2.11.2"
  }
}
EOF

# ----------------------------------------------------
# 3. entrypoint.sh (ğŸ”¥ æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨ nodemon)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/base/entrypoint.sh"
#!/bin/bash

check_service() {
    local service_name=$1
    local check_cmd=$2
    echo "â³ ç­‰å¾… $service_name å°±ç»ª..."
    for i in {1..30}; do
        if eval "$check_cmd"; then
            echo "âœ… $service_name å·²å¯åŠ¨"
            return 0
        fi
        sleep 0.5
    done
    echo "âŒ $service_name å¯åŠ¨è¶…æ—¶"
    exit 1
}

echo "ğŸš€ [1/5] é…ç½® VNC å¯†ç ..."
PASS_FILE="/app/vnc_pass"

if [ -n "$VNC_PASSWORD" ]; then
    echo "ğŸ” æ­£åœ¨ç”Ÿæˆå¯†ç æ–‡ä»¶..."
    rm -f "$PASS_FILE"
    x11vnc -storepasswd "$VNC_PASSWORD" "$PASS_FILE"
    chmod 600 "$PASS_FILE"
    AUTH_ARG="-rfbauth $PASS_FILE"
else
    echo "âš ï¸ æœªè®¾ç½®å¯†ç ï¼Œå¯ç”¨å…å¯†æ¨¡å¼"
    AUTH_ARG="-nopw"
fi

echo "ğŸš€ [2/5] å¯åŠ¨ Xvfb..."
Xvfb :99 -screen 0 1280x1024x24 &
check_service "Xvfb" "xdpyinfo -display :99 >/dev/null 2>&1"

echo "ğŸš€ [3/5] å¯åŠ¨ x11vnc..."
x11vnc -display :99 $AUTH_ARG -forever -shared -rfbport 5900 -bg
check_service "x11vnc" "netstat -tuln | grep -q ':5900 '"

echo "ğŸš€ [4/5] å¯åŠ¨ noVNC..."
/opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
check_service "noVNC" "netstat -tuln | grep -q ':6080 '"

echo "ğŸš€ [5/5] å¯åŠ¨ Stealth è„šæœ¬ (Hot Reload)..."
if [ -f "inject.js" ]; then
    # ğŸ”¥ æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨ nodemon -L (Legacy Watch) å¯åŠ¨
    # -L å¼ºåˆ¶è½®è¯¢ï¼Œè§£å†³ Docker æŒ‚è½½å·æ–‡ä»¶äº‹ä»¶ä¸è§¦å‘çš„é—®é¢˜
    echo "ğŸ‘€ æ­£åœ¨ç›‘å¬ inject.js å˜åŒ–..."
    nodemon -L inject.js &
else
    echo "âš ï¸ æœªæ‰¾åˆ° inject.js"
fi

tail -f /dev/null
EOF

# ----------------------------------------------------
# 4. manager.sh (ç”Ÿæˆå¸¦çƒ­é‡è½½å¤„ç†çš„ JS æ¨¡æ¿)
# ----------------------------------------------------
cat << 'EOF' > "$BASE_DIR/manager.sh"
#!/bin/bash

BASE_DIR="$HOME/playwright"
WORKSPACES="$BASE_DIR/workspaces"
IMAGE_NAME="playwright-hot-reload-v5" # æ›´æ–°é•œåƒå
GREEN='\033[0;32m'
NC='\033[0m'
DEFAULT_PASS="password"

build_image() {
    if [[ "$(docker images -q $IMAGE_NAME 2> /dev/null)" == "" ]] || [[ "$1" == "force" ]]; then
        echo -e "${GREEN}âš™ï¸  æ­£åœ¨æ„å»ºæ”¯æŒçƒ­é‡è½½çš„é•œåƒ...${NC}"
        cd "$BASE_DIR/base"
        docker build -t $IMAGE_NAME .
    fi
}

get_next_port() {
    local max_port=6080
    for file in "$WORKSPACES"/*/docker-compose.yml; do
        if [ -f "$file" ]; then
            curr=$(grep -oP '(?<=- ")\d+(?=:6080")' "$file" | head -n 1)
            if [[ "$curr" -gt "$max_port" ]]; then max_port=$curr; fi
        fi
    done
    echo $((max_port + 1))
}

generate_workspace() {
    local USER_NAME=$1
    local PORT=$2
    local PASS=$3

    TARGET_DIR="$WORKSPACES/$USER_NAME"
    if [ -d "$TARGET_DIR" ]; then echo "ç”¨æˆ·å·²å­˜åœ¨"; return; fi

    echo -e "${GREEN}ğŸ”¨ åˆ›å»ºç”¨æˆ·: $USER_NAME ($PORT) | å¯†ç : $PASS ${NC}"
    mkdir -p "$TARGET_DIR/user_data"

    cat << YML > "$TARGET_DIR/docker-compose.yml"
services:
  app:
    image: $IMAGE_NAME
    container_name: pw_${USER_NAME}
    restart: always
    ports:
      - "${PORT}:6080"
    environment:
      - DISPLAY=:99
      - TZ=Asia/Shanghai
      - VNC_PASSWORD=${PASS}
    shm_size: '2gb'
    volumes:
      - ./inject.js:/app/inject.js
      - ./user_data:/app/user_data
YML

    # ğŸ”¥ ä¼˜åŒ– JS æ¨¡æ¿ï¼šå¤„ç†çƒ­é‡è½½ä¿¡å·ï¼Œä¼˜é›…å…³é—­æµè§ˆå™¨
    cat << JS > "$TARGET_DIR/inject.js"
const { chromium } = require('playwright-extra');
const stealth = require('puppeteer-extra-plugin-stealth')();
chromium.use(stealth);

let context;

(async () => {
  console.log('ğŸ”„ [Hot Reload] è„šæœ¬å¯åŠ¨: $USER_NAME');
  const userDataDir = '/app/user_data';
  
  try {
    // å¯åŠ¨æµè§ˆå™¨
    context = await chromium.launchPersistentContext(userDataDir, { 
      headless: false,
      viewport: { width: 1280, height: 1024 },
      args: ['--disable-blink-features=AutomationControlled','--no-sandbox','--disable-setuid-sandbox'],
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    });

    const page = context.pages().length > 0 ? context.pages()[0] : await context.newPage();
    await page.addInitScript(() => { Object.defineProperty(navigator, 'webdriver', { get: () => undefined }); });
    
    // --- å¯ä»¥åœ¨æ­¤å¤„ä¿®æ”¹ç›®æ ‡ URL å¹¶ä¿å­˜ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡å¯åŠ è½½ ---
    await page.goto('https://www.google.com');
    
    console.log('âœ… é¡µé¢æ ‡é¢˜: ' + await page.title());
    
    // ä¿æŒè¿›ç¨‹æ´»è·ƒ
    setInterval(() => {}, 10000); 

  } catch (e) { 
    console.error('âŒ Error:', e); 
  }
})();

// ğŸ”¥ å¤„ç† nodemon é‡å¯ä¿¡å· (SIGUSR2)
// å¿…é¡»åœ¨é‡å¯å‰å…³é—­æµè§ˆå™¨ï¼Œå¦åˆ™ä¸‹æ¬¡å¯åŠ¨ä¼šæŠ¥ User Data Dir é”å®šé”™è¯¯
process.once('SIGUSR2', async () => {
  if (context) {
    console.log('ğŸ›‘ æ£€æµ‹åˆ°ä»£ç ä¿®æ”¹ï¼Œæ­£åœ¨å…³é—­æ—§æµè§ˆå™¨å®ä¾‹...');
    await context.close();
    context = null;
  }
  process.kill(process.pid, 'SIGUSR2');
});
JS

    cd "$TARGET_DIR" && docker-compose up -d >/dev/null 2>&1
    IP=$(curl -s ifconfig.me)
    echo -e "âœ… å¯åŠ¨: http://$IP:$PORT/vnc.html"
}

create_default() {
    build_image
    if [ ! -d "$WORKSPACES/default" ]; then
        generate_workspace "default" "6080" "$DEFAULT_PASS"
    fi
}
add_new_user() {
    build_image
    local NAME=$1
    local PASS=$2
    if [ -z "$PASS" ]; then PASS="$DEFAULT_PASS"; fi
    generate_workspace "$NAME" "$(get_next_port)" "$PASS"
}
delete_user() {
    TARGET_DIR="$WORKSPACES/$1"
    [ -d "$TARGET_DIR" ] && (cd "$TARGET_DIR" && docker-compose down >/dev/null 2>&1; cd .. && rm -rf "$TARGET_DIR"; echo "å·²åˆ é™¤")
}
list_users() {
    for dir in "$WORKSPACES"/*/; do [ -d "$dir" ] && echo "$(basename "$dir")"; done
}

case "$1" in
    init)  create_default ;;
    add)   add_new_user "$2" "$3" ;;
    del)   delete_user "$2" ;;
    list)  list_users ;;
    build) build_image force ;;
esac
EOF

chmod +x "$BASE_DIR/manager.sh"

# ====================================================
# 5. æ¸…ç†ä¸é‡å»º
# ====================================================

echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§å®¹å™¨ä»¥åº”ç”¨çƒ­é‡è½½è¡¥ä¸..."
if [ -d "$BASE_DIR/workspaces/default" ]; then
    cd "$BASE_DIR/workspaces/default" && docker-compose down 2>/dev/null
    cd "$BASE_DIR"
    rm -rf "$BASE_DIR/workspaces/default"
fi

echo "ğŸ”„ é‡æ–°æ„å»ºå¹¶å¯åŠ¨..."
"$BASE_DIR/manager.sh" build force
"$BASE_DIR/manager.sh" init

IP=$(curl -s ifconfig.me)
echo ""
echo "==========================================="
echo "âœ… çƒ­é‡è½½æ¨¡å¼å·²å°±ç»ªï¼"
echo "==========================================="
echo "ç°åœ¨ï¼Œå½“ä½ ä¿®æ”¹ $HOME/playwright/workspaces/default/inject.js æ—¶ï¼š"
echo "1. ä¿å­˜æ–‡ä»¶"
echo "2. å®¹å™¨å†…çš„è¿›ç¨‹ä¼šè‡ªåŠ¨é‡å¯"
echo "3. VNC ç•Œé¢ä¸­çš„æµè§ˆå™¨ä¼šè‡ªåŠ¨é‡æ–°æ‰“å¼€"
echo ""
echo "è®¿é—®åœ°å€: http://$IP:6080/vnc.html"
echo "å¯†ç : password"
echo "==========================================="
