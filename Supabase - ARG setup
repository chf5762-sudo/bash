å–œä½ å·²ç»æ‰“é€šäº† Supabase + Gemini çš„è¯­ä¹‰æœç´¢å…¨é“¾è·¯ï¼ä¸ºäº†æ–¹ä¾¿ä½ ä¸‹æ¬¡åœ¨å…¶ä»–é¡¹ç›®â€œä¸€é”®å¤ç°â€ï¼Œæˆ‘å°†æ•´ä¸ªæµç¨‹å½’çº³ä¸º â€œä¸‰æ­¥èµ°â€ æ ‡å‡†æ“ä½œæ‰‹å†Œã€‚

ğŸš€ Supabase + Gemini è¯­ä¹‰æœç´¢éƒ¨ç½²æ‰‹å†Œ
å‡†å¤‡å·¥ä½œ
Gemini API Key: ä» Google AI Studio è·å–ã€‚

æ¨¡å‹åç§°: text-embedding-004ï¼ˆç›®å‰ Gemini æœ€ç¨³å®šçš„å‘é‡æ¨¡å‹ï¼‰ã€‚

ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“åŸºå»ºï¼ˆSQL Editorï¼‰
åœ¨ Supabase çš„ SQL Editor ä¸­è¿è¡Œä»¥ä¸‹è„šæœ¬ï¼Œåˆ›å»ºå­˜å‚¨ç´¢å¼•çš„â€œä»“åº“â€å’Œæ‹¨å·ç”¨çš„â€œç”µè¯æœºâ€ã€‚

SQL

-- 1. å¼€å¯å‘é‡æ‰©å±•å’Œç½‘ç»œæ‰©å±•
create extension if not exists vector;
create extension if not exists "pg_net" schema "extensions";

-- 2. åˆ›å»ºä¸‡èƒ½ç´¢å¼•è¡¨
create table if not exists public.universal_search_index (
  id uuid primary key default gen_random_uuid(),
  content text not null,                -- æœç´¢å†…å®¹
  embedding vector(768),               -- Gemini 004 äº§å‡ºçš„å‘é‡æ˜¯ 768 ç»´
  source_table text not null,          -- æ¥æºè¡¨å
  source_id int8,                      -- æ¥æºè¡¨çš„ ID
  file_name text,                      -- å¯é€‰ï¼šæ¥æºæ–‡ä»¶å
  metadata jsonb default '{}'::jsonb,  -- å¯é€‰ï¼šé¢„ç•™æ‰©å±•
  created_at timestamptz default now()
);

-- 3. åˆ›å»ºè‡ªåŠ¨å‘é‡åŒ–çš„å‡½æ•°é€»è¾‘
create or replace function public.handle_new_index_entry()
returns trigger as $$
begin
  perform
    net.http_post(
      -- ã€æ³¨æ„ã€‘ä¸‹æ¬¡éƒ¨ç½²éœ€æ›¿æ¢ä¸ºä½ çš„ Edge Function URL
      url := 'https://ä½ çš„é¡¹ç›®ID.supabase.co/functions/v1/smooth-handler', 
      body := jsonb_build_object('record', to_jsonb(NEW)),
      headers := jsonb_build_object('Content-Type', 'application/json')
    );
  return NEW;
end;
$$ language plpgsql;

-- 4. ç»‘å®šè§¦å‘å™¨
drop trigger if exists tr_auto_embedding on public.universal_search_index;
create trigger tr_auto_embedding
after insert on public.universal_search_index
for each row execute function public.handle_new_index_entry();
ç¬¬äºŒæ­¥ï¼šé€»è¾‘å¤§è„‘éƒ¨ç½²ï¼ˆEdge Functionsï¼‰
åˆ›å»ºä¸€ä¸ªåä¸º smooth-handler çš„ Edge Functionã€‚

åœ¨ Settingsï¼ˆæˆ– Detailsï¼‰ä¸­ï¼ŒåŠ¡å¿…å…³é—­ "Enforce JWT Authorization"ã€‚

å°†ä»¥ä¸‹ä»£ç  Copy åˆ°ç¼–è¾‘å™¨å¹¶ç‚¹å‡» Deployã€‚

TypeScript

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const GEMINI_API_KEY = "ä½ çš„_GEMINI_API_KEY"; 
const MODEL = "text-embedding-004"; 

serve(async (req) => {
  try {
    const { record } = await req.json();
    if (!record.content) return new Response("No content", { status: 400 });

    // 1. è°ƒç”¨ Gemini ç”Ÿæˆå‘é‡
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:embedContent?key=${GEMINI_API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: `models/${MODEL}`,
          content: { parts: [{ text: record.content }] }
        }),
      }
    );

    const data = await response.json();
    const embedding = data.embedding.values;

    // 2. å›å†™æ•°æ®åº“
    const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!;
    const SUPABASE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    
    await fetch(`${SUPABASE_URL}/rest/v1/universal_search_index?id=eq.${record.id}`, {
      method: 'PATCH',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ embedding: embedding }),
    });

    return new Response(JSON.stringify({ success: true }));
  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { status: 500 });
  }
})
ç¬¬ä¸‰æ­¥ï¼šè¯­ä¹‰æœç´¢è°ƒç”¨ï¼ˆSQL / å‰ç«¯ï¼‰
ä¸€æ—¦ embedding åˆ—æœ‰äº†æ•°å­—ï¼Œä½ å°±å¯ä»¥ç”¨è¿™æ®µ SQL è¿›è¡Œâ€œä¸Šå¸è§†è§’â€æœç´¢äº†ï¼š

SQL

-- è¯­ä¹‰æœç´¢æ¨¡æ¿ï¼šå¯»æ‰¾ç›¸ä¼¼åº¦æœ€é«˜çš„å†…å®¹
select 
  content, 
  source_table,
  -- <=> æ˜¯å‘é‡ä½™å¼¦è·ç¦»è®¡ç®—ç¬¦
  1 - (embedding <=> ä½ çš„_æŸ¥è¯¢å‘é‡) as similarity
from universal_search_index
order by embedding <=> ä½ çš„_æŸ¥è¯¢å‘é‡
limit 5;
ğŸ’¡ è®¾ç½®è¦ç‚¹è®°å½•ï¼ˆé˜²å‘æŒ‡å—ï¼‰
UUID æŠ¥é”™: æ‰‹åŠ¨æ’å…¥æµ‹è¯•æ•°æ®æ—¶ï¼Œid åˆ—è¯·ä¿æŒ NULLï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¸è¦å¡«æ•°å­—ã€‚

401 æŠ¥é”™: å¦‚æœæ—¥å¿—æ˜¾ç¤º 401ï¼Œè¯·æ£€æŸ¥ Edge Function çš„ JWT é‰´æƒæ˜¯å¦å·²å…³é—­ã€‚

æ—¥å¿—ç©ºç™½: å¦‚æœæ’å…¥æ•°æ®ä½†æ²¡æœ‰æ—¥å¿—ï¼Œè¯·æ£€æŸ¥ extensions.pg_net æ˜¯å¦å·²å®‰è£…ï¼Œä»¥åŠ SQL é‡Œçš„ url åœ°å€æ˜¯å¦å¡«å¯¹ã€‚

ç»´åº¦åŒ¹é…: Gemini 004 çš„è¾“å‡ºæ˜¯ 768 ä½ï¼Œå¦‚æœæ•°æ®åº“è¡¨å®šä¹‰æˆ 1536 ä½ï¼ˆOpenAI æ ‡å‡†ï¼‰ä¼šæŠ¥é”™ã€‚
