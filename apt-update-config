# --- 配置与环境 ---
CONFIG_FILE="$HOME/.sinstall_config"
[ ! -f "$CONFIG_FILE" ] && echo "1" > "$CONFIG_FILE"

# --- 核心函数 ---
check_link() {
    curl -s --connect-timeout 2 "$1" > /dev/null && echo -e "$2: \e[32m[ 连通 ]\e[0m" || echo -e "$2: \e[31m[ 阻塞 ]\e[0m"
}

show_menu() {
    clear
    echo "=========================================="
    echo "      N1 全能管家 (网络穿透增强版)"
    echo "=========================================="
    echo " 1) 智能安装/更新 (apt)"
    echo " 2) 系统体检 (详细 IP/连通性/硬件)"
    echo " 3) 深度清理 (腾出磁盘空间)"
    echo " 4) 网络急救 (修复 DNS/路由/解锁)"
    echo " 5) Tailscale 穿透修复 (TUN/转发/防火墙)"
    echo " 6) 设置更新周期 ($(cat $CONFIG_FILE)个月)"
    echo " q) 退出"
    echo "------------------------------------------"
    printf "请选择 [1-6/q]: "
}

sys_check() {
    echo ">> [网络地址详情]"
    echo "内网 IPv4: $(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | xargs)"
    echo "内网 IPv6: $(ip -6 addr show | grep -oP '(?<=inet6\s)[a-f0-9:]+' | grep -v '^fe80' | xargs)"
    echo "虚拟网卡:  $(ip addr show | grep -E 'docker|br-|tailscale|tun' | awk -F': ' '{print $2}' | cut -d'@' -f1 | xargs)"
    echo "公网 IP:   $(curl -s4 --connect-timeout 2 ifconfig.me || echo "超时")"
    echo "------------------------------------------"
    echo ">> [连通性测试]"
    check_link "www.aliyun.com" "阿里巴巴"
    check_link "www.google.com" "Google  "
    check_link "gemini.google.com" "Gemini  "
    check_link "claude.ai" "Claude  "
    echo "------------------------------------------"
    echo ">> [硬件状态]"
    echo "CPU温度: $(cat /sys/class/thermal/thermal_zone0/temp | awk '{print $1/1000}')°C | 内存空闲: $(free -h | awk 'NR==2 {print $4}')"
    read -p "按回车返回..." temp
}

net_fix() {
    echo ">> 正在重置网络地图 (DNS)..."
    sudo chattr -i /etc/resolv.conf 2>/dev/null
    echo -e "nameserver 223.5.5.5\nnameserver 8.8.8.8" | sudo tee /etc/resolv.conf
    sudo systemctl restart NetworkManager
    echo ">> DNS 已恢复，请测试网络。"
    sleep 2
}

ts_fix() {
    echo ">> 正在修复 Tailscale 穿透环境..."
    # 1. 加载内核模块
    sudo modprobe tun
    # 2. 开启内核转发
    echo "net.ipv4.ip_forward = 1" | sudo tee /etc/sysctl.conf > /dev/null
    sudo sysctl -p
    # 3. 强开防火墙
    sudo iptables -I INPUT -i tailscale0 -j ACCEPT
    sudo iptables -I FORWARD -i tailscale0 -j ACCEPT
    # 4. 彻底重置登录状态
    sudo tailscale up --accept-dns=true --accept-routes=true --reset
    echo ">> 修复完成，请在手机/电脑端尝试 Ping N1。"
    sleep 2
}

# --- 主循环 ---
while true; do
    show_menu; read opt
    case $opt in
        1) read -p "包名: " p; sudo apt install -y "$p" ;;
        2) sys_check ;;
        3) sudo apt clean && sudo apt autoremove -y ;;
        4) net_fix ;;
        5) ts_fix ;;
        6) read -p "周期(1/3/6): " f; echo "$f" > "$CONFIG_FILE" ;;
        q) exit 0 ;;
    esac
done
EOF
