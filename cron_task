#!/bin/bash

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}     定时任务发布工具${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

# 输入任务名称
read -p "请输入任务名称: " task_name
if [ -z "$task_name" ]; then
    echo -e "${RED}错误: 任务名称不能为空${NC}"
    exit 1
fi

# 检查文件是否已存在
if [ -f "${task_name}.sh" ]; then
    read -p "任务 ${task_name}.sh 已存在，是否覆盖? (y/n): " overwrite
    if [ "$overwrite" != "y" ] && [ "$overwrite" != "Y" ]; then
        echo -e "${YELLOW}已取消${NC}"
        exit 0
    fi
fi

# 输入延迟秒数
read -p "请输入延迟秒数: " delay_seconds
if ! [[ "$delay_seconds" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}错误: 延迟秒数必须是正整数${NC}"
    exit 1
fi

# 输入脚本内容
echo ""
echo -e "${YELLOW}请粘贴脚本内容 (输入完成后按 Ctrl+D):${NC}"
echo "---"
script_content=$(cat)

if [ -z "$script_content" ]; then
    echo -e "${RED}错误: 脚本内容不能为空${NC}"
    exit 1
fi

# 生成脚本文件
script_file="${task_name}.sh"
log_file="${task_name}.log"

echo "#!/bin/bash" > "$script_file"
echo "" >> "$script_file"
echo "$script_content" >> "$script_file"

# 赋予执行权限
chmod +x "$script_file"

# 计算执行时间
execute_time=$(date -d "+${delay_seconds} seconds" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || date -v+${delay_seconds}S "+%Y-%m-%d %H:%M:%S" 2>/dev/null)

# 后台执行定时任务
nohup bash -c "sleep ${delay_seconds} && ./${script_file}" > "$log_file" 2>&1 &
task_pid=$!

# 记录任务信息
task_list_file=".task_list"
current_time=$(date "+%Y-%m-%d %H:%M:%S")
echo "${current_time} | PID: ${task_pid} | 任务: ${task_name} | 延迟: ${delay_seconds}s | 执行时间: ${execute_time} | 脚本: ${script_file}" >> "$task_list_file"

# 显示成功信息
echo ""
echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}✓ 任务创建成功!${NC}"
echo -e "${GREEN}======================================${NC}"
echo -e "任务名称:   ${BLUE}${task_name}${NC}"
echo -e "进程 PID:   ${BLUE}${task_pid}${NC}"
echo -e "脚本文件:   ${BLUE}${script_file}${NC}"
echo -e "日志文件:   ${BLUE}${log_file}${NC}"
echo -e "延迟时间:   ${BLUE}${delay_seconds} 秒${NC}"
echo -e "执行时间:   ${BLUE}${execute_time}${NC}"
echo ""
echo -e "${YELLOW}提示:${NC}"
echo -e "  - 查看任务列表: ${BLUE}cat .task_list${NC}"
echo -e "  - 查看日志: ${BLUE}tail -f ${log_file}${NC}"
echo -e "  - 取消任务: ${BLUE}kill ${task_pid}${NC}"
echo ""
