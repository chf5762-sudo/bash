cat << 'EOF' > update_kkfileview.sh
#!/bin/bash

# 1. å®šä¹‰å˜é‡
BASE_DIR="/opt/kkfileview"
CONF_DIR="$BASE_DIR/config"
LOG_DIR="$BASE_DIR/log"
OLD_CONTAINER="kkfileview"

echo "ğŸš€ å¼€å§‹æ›´æ–° kkFileView é…ç½®å¹¶è¿ç§»è‡³ Docker Compose..."

# 2. åˆ›å»ºæŒä¹…åŒ–ç›®å½•
mkdir -p $CONF_DIR $LOG_DIR

# 3. å¤‡ä»½åŸå§‹é…ç½® (å¦‚æœå®¹å™¨å­˜åœ¨)
if [ "$(docker ps -q -f name=$OLD_CONTAINER)" ]; then
    echo "ğŸ“¦ æ­£åœ¨ä»æ—§å®¹å™¨å¤‡ä»½é…ç½®æ–‡ä»¶..."
    docker cp $OLD_CONTAINER:/opt/kkFileView-4.4.0-beta/config/application.properties $CONF_DIR/
else
    echo "âš ï¸ æœªå‘ç°è¿è¡Œä¸­çš„æ—§å®¹å™¨ï¼Œè¯·ç¡®ä¿ /opt/kkfileview/config/application.properties å·²å­˜åœ¨ã€‚"
fi

# 4. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
echo "ğŸ—‘ï¸ æ¸…ç†æ—§å®¹å™¨..."
docker stop $OLD_CONTAINER 2>/dev/null
docker rm $OLD_CONTAINER 2>/dev/null

# 5. ç”Ÿæˆ docker-compose.yml
echo "ğŸ“ ç”Ÿæˆ docker-compose.yml..."
cat << 'COMPOSE' > docker-compose.yml
version: '3.8'
services:
  kkfileview:
    image: yimik/kkfileview:latest
    container_name: kkfileview
    restart: always
    ports:
      - "8012:8012"
    volumes:
      - /opt/kkfileview/config:/opt/kkFileView-4.4.0-beta/config
      - /opt/kkfileview/log:/opt/kkFileView-4.4.0-beta/log
    environment:
      - KK_TRUST_HOST=*.beundredig.eu.org
      - LC_ALL=en_US.UTF-8
      - LANG=en_US.UTF-8
    command: >
      sh -c 'java -Dtrust.host="*.beundredig.eu.org" 
      -Dfile.encoding=UTF-8 
      -Dspring.config.location=/opt/kkFileView-4.4.0-beta/config/application.properties 
      -jar /opt/kkFileView-4.4.0-beta/bin/kkFileView-4.4.0-beta.jar 
      --trust.host="*.beundredig.eu.org"'
COMPOSE

# 6. å¯åŠ¨æ–°å®¹å™¨
echo "ğŸ—ï¸ æ­£åœ¨é€šè¿‡ Docker Compose å¯åŠ¨..."
docker compose up -d

echo "âœ… æ‰§è¡Œå®Œæ¯•ï¼"
echo "ğŸŒ ä¿¡ä»»åŸŸåå·²è®¾ç½®ä¸º: *.beundredig.eu.org"
echo "ğŸ“‚ é…ç½®æ–‡ä»¶ä½ç½®: /opt/kkfileview/config/application.properties"
EOF

# èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œ
chmod +x update_kkfileview.sh
./update_kkfileview.sh