#!/bin/bash

#==============================================================================
# OpenClaw 一键安装脚本
# 支持架构: ARM64, AMD64 (x86_64)
# 支持系统: Ubuntu, Debian
#==============================================================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 日志函数
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 分隔线
print_separator() {
    echo -e "${BLUE}================================================================${NC}"
}

# 检测系统架构
check_architecture() {
    log_info "检测系统架构..."
    ARCH=$(uname -m)
    case $ARCH in
        x86_64|amd64)
            ARCH_TYPE="AMD64"
            ;;
        aarch64|arm64)
            ARCH_TYPE="ARM64"
            ;;
        armv7l)
            ARCH_TYPE="ARMv7"
            log_warning "检测到 ARMv7 架构，可能不完全兼容"
            ;;
        *)
            log_error "不支持的架构: $ARCH"
            exit 1
            ;;
    esac
    log_success "系统架构: $ARCH_TYPE ($ARCH)"
}

# 检测操作系统
check_os() {
    log_info "检测操作系统..."
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
        log_success "操作系统: $NAME $VERSION"
    else
        log_error "无法检测操作系统"
        exit 1
    fi
    
    # 检查是否为支持的系统
    case $OS in
        ubuntu|debian)
            log_success "系统检测通过"
            ;;
        centos|rhel|fedora)
            log_warning "检测到 $OS，脚本主要针对 Ubuntu/Debian 优化"
            read -p "是否继续安装？(y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
            ;;
        *)
            log_error "不支持的操作系统: $OS"
            exit 1
            ;;
    esac
}

# 检测系统资源
check_resources() {
    log_info "检测系统资源..."
    
    # 检测内存
    TOTAL_MEM=$(free -m | awk 'NR==2{print $2}')
    log_info "总内存: ${TOTAL_MEM}MB"
    
    if [ $TOTAL_MEM -lt 512 ]; then
        log_error "内存不足 512MB，建议至少 1GB 内存"
        exit 1
    elif [ $TOTAL_MEM -lt 1024 ]; then
        log_warning "内存较小 (${TOTAL_MEM}MB)，建议配置 SWAP"
        NEED_SWAP=true
    else
        log_success "内存充足: ${TOTAL_MEM}MB"
        NEED_SWAP=false
    fi
    
    # 检测磁盘空间
    AVAILABLE_SPACE=$(df -BG / | awk 'NR==2{print $4}' | sed 's/G//')
    log_info "可用磁盘空间: ${AVAILABLE_SPACE}GB"
    
    if [ $AVAILABLE_SPACE -lt 2 ]; then
        log_error "磁盘空间不足 2GB"
        exit 1
    else
        log_success "磁盘空间充足: ${AVAILABLE_SPACE}GB"
    fi
}

# 检测 Node.js
check_nodejs() {
    log_info "检测 Node.js..."
    
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v | cut -d'v' -f2)
        NODE_MAJOR=$(echo $NODE_VERSION | cut -d'.' -f1)
        
        log_info "当前 Node.js 版本: v$NODE_VERSION"
        
        if [ $NODE_MAJOR -ge 22 ]; then
            log_success "Node.js 版本符合要求 (>= 22)"
            INSTALL_NODE=false
        else
            log_warning "Node.js 版本过低，需要升级到 v22+"
            INSTALL_NODE=true
        fi
    else
        log_warning "未检测到 Node.js"
        INSTALL_NODE=true
    fi
}

# 安装 Node.js 22
install_nodejs() {
    if [ "$INSTALL_NODE" = false ]; then
        return
    fi
    
    print_separator
    log_info "开始安装 Node.js 22..."
    
    # 更新包列表
    log_info "更新包列表..."
    apt-get update -qq
    
    # 安装依赖
    log_info "安装必要依赖..."
    apt-get install -y -qq curl gnupg2 ca-certificates lsb-release
    
    # 添加 NodeSource 仓库
    log_info "添加 NodeSource 仓库..."
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    
    # 安装 Node.js
    log_info "安装 Node.js..."
    apt-get install -y -qq nodejs
    
    # 验证安装
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v)
        log_success "Node.js 安装成功: $NODE_VERSION"
    else
        log_error "Node.js 安装失败"
        exit 1
    fi
}

# 配置 SWAP
setup_swap() {
    if [ "$NEED_SWAP" = false ]; then
        return
    fi
    
    print_separator
    log_info "配置 SWAP 内存..."
    
    # 检查是否已有 swap
    if swapon --show | grep -q '/swapfile'; then
        log_warning "SWAP 已存在，跳过配置"
        return
    fi
    
    SWAP_SIZE="2G"
    
    log_info "创建 ${SWAP_SIZE} SWAP 文件..."
    
    # 尝试使用 fallocate，失败则用 dd
    if ! fallocate -l $SWAP_SIZE /swapfile 2>/dev/null; then
        log_warning "fallocate 失败，使用 dd 创建..."
        dd if=/dev/zero of=/swapfile bs=1M count=2048 status=progress
    fi
    
    chmod 600 /swapfile
    mkswap /swapfile > /dev/null
    swapon /swapfile
    
    # 持久化配置
    if ! grep -q '/swapfile' /etc/fstab; then
        echo '/swapfile none swap sw 0 0' >> /etc/fstab
    fi
    
    log_success "SWAP 配置完成"
    free -h | grep -i swap
}

# 安装 OpenClaw
install_openclaw() {
    print_separator
    log_info "开始安装 OpenClaw..."
    
    # 检查是否已安装
    if command -v openclaw &> /dev/null; then
        CURRENT_VERSION=$(openclaw --version 2>/dev/null || echo "未知")
        log_warning "OpenClaw 已安装 (版本: $CURRENT_VERSION)"
        read -p "是否重新安装/更新？(y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "跳过安装"
            return
        fi
    fi
    
    log_info "通过 npm 安装 OpenClaw..."
    
    # 安装 OpenClaw
    if npm install -g openclaw@latest 2>&1 | tee /tmp/openclaw-install.log; then
        log_success "OpenClaw 安装完成"
    else
        log_error "OpenClaw 安装失败"
        log_info "查看日志: /tmp/openclaw-install.log"
        exit 1
    fi
}

# 验证安装
verify_installation() {
    print_separator
    log_info "验证安装..."
    
    # 检查 openclaw 命令
    if ! command -v openclaw &> /dev/null; then
        log_error "openclaw 命令未找到"
        exit 1
    fi
    
    # 获取版本信息
    OPENCLAW_VERSION=$(openclaw --version 2>/dev/null || echo "无法获取版本")
    OPENCLAW_PATH=$(which openclaw)
    
    log_success "OpenClaw 命令可用"
    log_info "安装路径: $OPENCLAW_PATH"
    log_info "版本信息: $OPENCLAW_VERSION"
    
    # 检查依赖
    log_info "检查依赖..."
    if npm list -g openclaw --depth=0 &> /dev/null; then
        log_success "依赖检查通过"
    else
        log_warning "部分依赖可能缺失，但不影响基本功能"
    fi
}

# 显示后续步骤
show_next_steps() {
    print_separator
    log_success "OpenClaw 安装完成！"
    print_separator
    
    echo -e "\n${GREEN}后续步骤：${NC}\n"
    echo -e "1. 运行配置向导:"
    echo -e "   ${YELLOW}openclaw onboard --install-daemon${NC}\n"
    
    echo -e "2. 手动启动 Gateway:"
    echo -e "   ${YELLOW}openclaw gateway --port 18789 --verbose${NC}\n"
    
    echo -e "3. 查看帮助:"
    echo -e "   ${YELLOW}openclaw --help${NC}\n"
    
    echo -e "${BLUE}准备工作：${NC}"
    echo -e "- Anthropic API Key: https://console.anthropic.com/"
    echo -e "- OpenAI API Key: https://platform.openai.com/\n"
    
    print_separator
}

# 主函数
main() {
    clear
    print_separator
    echo -e "${GREEN}OpenClaw 一键安装脚本${NC}"
    echo -e "支持架构: ARM64, AMD64"
    echo -e "支持系统: Ubuntu, Debian"
    print_separator
    echo
    
    # 检查是否为 root
    if [ "$EUID" -ne 0 ]; then
        log_error "请使用 root 权限运行此脚本"
        echo "使用: sudo bash $0"
        exit 1
    fi
    
    # 环境检测
    check_architecture
    check_os
    check_resources
    check_nodejs
    
    echo
    print_separator
    log_info "即将执行以下操作："
    echo -e "  - 安装/升级 Node.js 22: $([ "$INSTALL_NODE" = true ] && echo "${GREEN}是${NC}" || echo "${YELLOW}跳过${NC}")"
    echo -e "  - 配置 SWAP 内存: $([ "$NEED_SWAP" = true ] && echo "${GREEN}是${NC}" || echo "${YELLOW}跳过${NC}")"
    echo -e "  - 安装 OpenClaw: ${GREEN}是${NC}"
    print_separator
    
    read -p "是否继续？(y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "安装已取消"
        exit 0
    fi
    
    # 执行安装
    install_nodejs
    setup_swap
    install_openclaw
    verify_installation
    show_next_steps
}

# 捕获错误
trap 'log_error "安装过程中出现错误，请检查日志"; exit 1' ERR

# 运行主函数
main

