#!/bin/bash

# 定义要操作的设备和挂载点
DISK="/dev/sdb"
MOUNT_POINT="/mnt/data"
FSTAB_ENTRY=""

echo "🚀 开始配置磁盘 $DISK 为一个整体 ext4 文件系统并挂载到 $MOUNT_POINT"
echo "------------------------------------------------------------------"

# 1. 确认磁盘是否存在
if [ ! -b "$DISK" ]; then
    echo "❌ 错误：设备 $DISK 不存在。请检查设备名称是否正确。"
    exit 1
fi

echo "✅ 确认设备 $DISK 存在。"

# 2. 格式化磁盘
echo "⚠️ 警告：即将格式化 $DISK，这将删除所有数据！"
read -p "你确定要继续吗？(输入 'yes' 继续): " confirm
if [ "$confirm" != "yes" ]; then
    echo "操作已取消。"
    exit 0
fi

echo "⚙️ 正在格式化 $DISK 为 ext4 文件系统..."
sudo mkfs -t ext4 -F "$DISK"
if [ $? -ne 0 ]; then
    echo "❌ 错误：格式化 $DISK 失败。"
    exit 1
fi
echo "✅ 格式化 $DISK 完成。"

# 3. 创建挂载点
echo "⚙️ 正在创建挂载点 $MOUNT_POINT..."
sudo mkdir -p "$MOUNT_POINT"
if [ $? -ne 0 ]; then
    echo "❌ 错误：创建挂载点 $MOUNT_POINT 失败。"
    exit 1
fi
echo "✅ 挂载点 $MOUNT_POINT 创建成功。"

# 4. 获取磁盘的 UUID
echo "⚙️ 正在获取 $DISK 的 UUID..."
UUID=$(sudo blkid -s UUID -o value "$DISK")
if [ -z "$UUID" ]; then
    echo "❌ 错误：无法获取 $DISK 的 UUID。"
    exit 1
fi
echo "✅ $DISK 的 UUID 是: $UUID"

# 5. 挂载磁盘
echo "⚙️ 正在挂载 $DISK 到 $MOUNT_POINT..."
sudo mount "$DISK" "$MOUNT_POINT"
if [ $? -ne 0 ]; then
    echo "❌ 错误：挂载 $DISK 失败。请检查日志。"
    exit 1
fi
echo "✅ 挂载成功。当前的挂载信息如下："
df -h "$MOUNT_POINT"

# 6. 配置开机自动挂载 (添加到 /etc/fstab)
FSTAB_ENTRY="UUID=$UUID $MOUNT_POINT ext4 defaults 0 0"

echo "⚙️ 正在配置开机自动挂载到 /etc/fstab..."
# 检查是否已存在相同的UUID或挂载点条目，避免重复添加
if grep -q "UUID=$UUID" /etc/fstab || grep -q "$MOUNT_POINT" /etc/fstab; then
    echo "ℹ️ 注意：$DISK (UUID=$UUID) 或挂载点 $MOUNT_POINT 的条目已存在于 /etc/fstab 中。跳过添加。"
else
    echo "$FSTAB_ENTRY" | sudo tee -a /etc/fstab > /dev/null
    if [ $? -ne 0 ]; then
        echo "❌ 错误：添加 fstab 条目失败。"
        exit 1
    fi
    echo "✅ /etc/fstab 配置成功，已添加以下行："
    echo "   $FSTAB_ENTRY"
fi

# 7. 验证 fstab 配置（可选）
echo "⚙️ 正在尝试卸载并重新挂载所有 fstab 中的设备以验证配置..."
sudo umount "$MOUNT_POINT" 2>/dev/null # 尝试卸载，如果没挂载会报错，但我们不关心
sudo mount -a
if [ $? -ne 0 ]; then
    echo "❌ 错误：fstab 配置验证失败。请手动检查 /etc/fstab。"
    exit 1
fi
echo "✅ fstab 配置验证成功。磁盘已重新挂载。"
df -h "$MOUNT_POINT"

echo "🎉 磁盘 $DISK 已成功配置为 ext4 文件系统，挂载到 $MOUNT_POINT，并已设置开机自动挂载。"
echo "现在你可以开始在 $MOUNT_POINT 目录下存储数据了。"
