#!/bin/bash

# 阿里云盘同步 + WebDAV 服务一键安装脚本
# 使用方法: chmod +x install.sh && ./install.sh

set -e

echo "=========================================="
echo "阿里云盘同步 + WebDAV 服务安装脚本"
echo "=========================================="
echo ""

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 配置变量
ALIYUNPAN_VERSION="v0.3.3"
INSTALL_DIR="/usr/local/bin"
SYNC_LOCAL_DIR="/root/AliyunDisk"
WEBDAV_PORT=8080
WEBDAV_USER="admin"

# 检查是否为 root 用户
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}请使用 root 用户或 sudo 运行此脚本${NC}"
    exit 1
fi

# 获取用户输入
echo -e "${YELLOW}请输入配置信息:${NC}"
echo ""

read -p "请输入要同步的阿里云盘文件夹路径 (例如: /我的文件 或 / 表示根目录): " CLOUD_DIR
read -p "请输入本地同步目录 [默认: /root/AliyunDisk]: " INPUT_LOCAL_DIR
SYNC_LOCAL_DIR=${INPUT_LOCAL_DIR:-$SYNC_LOCAL_DIR}

read -p "请输入 WebDAV 端口 [默认: 8080]: " INPUT_PORT
WEBDAV_PORT=${INPUT_PORT:-$WEBDAV_PORT}

read -p "请输入 WebDAV 用户名 [默认: admin]: " INPUT_USER
WEBDAV_USER=${INPUT_USER:-$WEBDAV_USER}

read -sp "请输入 WebDAV 密码: " WEBDAV_PASSWORD
echo ""

if [ -z "$WEBDAV_PASSWORD" ]; then
    echo -e "${RED}密码不能为空!${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}配置信息确认:${NC}"
echo "云盘文件夹: $CLOUD_DIR"
echo "本地目录: $SYNC_LOCAL_DIR"
echo "WebDAV 端口: $WEBDAV_PORT"
echo "WebDAV 用户名: $WEBDAV_USER"
echo ""
read -p "确认以上配置? (y/n): " CONFIRM

if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    echo "安装已取消"
    exit 0
fi

echo ""
echo -e "${GREEN}开始安装...${NC}"
echo ""

# 1. 安装依赖
echo -e "${YELLOW}[1/7] 安装必要依赖...${NC}"
apt-get update
apt-get install -y wget unzip curl

# 2. 下载并安装 aliyunpan
echo -e "${YELLOW}[2/7] 下载 aliyunpan ${ALIYUNPAN_VERSION}...${NC}"
cd /tmp
wget -q --show-progress https://github.com/tickstep/aliyunpan/releases/download/${ALIYUNPAN_VERSION}/aliyunpan-${ALIYUNPAN_VERSION}-linux-amd64.zip

echo -e "${YELLOW}解压并安装...${NC}"
unzip -q aliyunpan-${ALIYUNPAN_VERSION}-linux-amd64.zip
chmod +x aliyunpan-${ALIYUNPAN_VERSION}-linux-amd64/aliyunpan
mv aliyunpan-${ALIYUNPAN_VERSION}-linux-amd64/aliyunpan ${INSTALL_DIR}/
rm -rf aliyunpan-${ALIYUNPAN_VERSION}-linux-amd64*

# 3. 创建本地目录
echo -e "${YELLOW}[3/7] 创建本地同步目录...${NC}"
mkdir -p ${SYNC_LOCAL_DIR}

# 4. 登录阿里云盘
echo -e "${YELLOW}[4/7] 登录阿里云盘...${NC}"
echo -e "${GREEN}请使用阿里云盘 App 扫描下方二维码登录:${NC}"
echo ""
aliyunpan login

# 验证登录
if ! aliyunpan who > /dev/null 2>&1; then
    echo -e "${RED}登录失败,请重新运行脚本${NC}"
    exit 1
fi

echo -e "${GREEN}登录成功!${NC}"
echo ""

# 5. 创建同步服务
echo -e "${YELLOW}[5/7] 创建同步服务...${NC}"
cat > /etc/systemd/system/aliyunpan-sync.service <<EOF
[Unit]
Description=Aliyun Pan Sync Service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=${INSTALL_DIR}/aliyunpan sync start -ldir ${SYNC_LOCAL_DIR} -pdir "${CLOUD_DIR}" -mode download
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 6. 创建 WebDAV 服务
echo -e "${YELLOW}[6/7] 创建 WebDAV 服务...${NC}"

# 安装 rclone 的 WebDAV 服务器 (使用系统 rclone)
if ! command -v rclone &> /dev/null; then
    echo "安装 rclone..."
    curl https://rclone.org/install.sh | bash
fi

# 创建 rclone WebDAV 服务
cat > /etc/systemd/system/rclone-webdav.service <<EOF
[Unit]
Description=Rclone WebDAV Server
After=network-online.target aliyunpan-sync.service
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/rclone serve webdav ${SYNC_LOCAL_DIR} \\
    --addr 0.0.0.0:${WEBDAV_PORT} \\
    --user ${WEBDAV_USER} \\
    --pass ${WEBDAV_PASSWORD} \\
    --vfs-cache-mode full
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 7. 启用并启动服务
echo -e "${YELLOW}[7/7] 启动服务...${NC}"
systemctl daemon-reload

# 启动同步服务
systemctl enable aliyunpan-sync
systemctl start aliyunpan-sync

# 启动 WebDAV 服务
systemctl enable rclone-webdav
systemctl start rclone-webdav

# 等待服务启动
sleep 3

# 检查服务状态
echo ""
echo -e "${GREEN}=========================================="
echo "安装完成!"
echo "==========================================${NC}"
echo ""

# 同步服务状态
if systemctl is-active --quiet aliyunpan-sync; then
    echo -e "${GREEN}✓ 阿里云盘同步服务: 运行中${NC}"
else
    echo -e "${RED}✗ 阿里云盘同步服务: 启动失败${NC}"
fi

# WebDAV 服务状态
if systemctl is-active --quiet rclone-webdav; then
    echo -e "${GREEN}✓ WebDAV 服务: 运行中${NC}"
else
    echo -e "${RED}✗ WebDAV 服务: 启动失败${NC}"
fi

echo ""
echo -e "${YELLOW}WebDAV 连接信息:${NC}"
echo "地址: http://$(curl -s ifconfig.me):${WEBDAV_PORT}"
echo "内网地址: http://$(hostname -I | awk '{print $1}'):${WEBDAV_PORT}"
echo "用户名: ${WEBDAV_USER}"
echo "密码: ${WEBDAV_PASSWORD}"
echo ""
echo -e "${YELLOW}常用命令:${NC}"
echo "查看同步状态: systemctl status aliyunpan-sync"
echo "查看同步日志: journalctl -u aliyunpan-sync -f"
echo "查看 WebDAV 状态: systemctl status rclone-webdav"
echo "查看 WebDAV 日志: journalctl -u rclone-webdav -f"
echo "重启同步服务: systemctl restart aliyunpan-sync"
echo "重启 WebDAV 服务: systemctl restart rclone-webdav"
echo "查看云盘文件: aliyunpan ls /"
echo "查看已登录账号: aliyunpan who"
echo ""
echo -e "${GREEN}本地同步目录: ${SYNC_LOCAL_DIR}${NC}"
echo -e "${GREEN}云盘同步路径: ${CLOUD_DIR}${NC}"
echo ""
echo -e "${YELLOW}提示: 首次同步可能需要一些时间,请耐心等待${NC}"
echo ""
