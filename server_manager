#!/bin/bash
#!/bin/bash

# ä¸€ã€ç¯å¢ƒåˆ›å»ºï¼ˆåœ¨ USB ä¸Šçš„ç®€å•æ–¹æ¡ˆï¼‰
#python3 -m venv /root/ai_env  # åˆ›å»ºåä¸º ai_env çš„è™šæ‹Ÿç¯å¢ƒåˆ° USB å­˜å‚¨ã€‚

# äºŒã€è‡ªå·±ä½¿ç”¨
#source /root/ai_env/bin/activate  # æ¿€æ´»è¯¥è™šæ‹Ÿç¯å¢ƒï¼Œå¼€å§‹ä½¿ç”¨ USB ä¸Šçš„ç¯å¢ƒã€‚
#pip install requests numpy          # å®‰è£…æ‰€éœ€çš„ Python åº“åˆ°è™šæ‹Ÿç¯å¢ƒä¸­ã€‚
#python your_script.py               # è¿è¡Œæ‚¨çš„é¡¹ç›®è„šæœ¬ã€‚
#deactivate                          # é€€å‡ºè™šæ‹Ÿç¯å¢ƒï¼Œå›åˆ°ç³»ç»Ÿå…¨å±€ç¯å¢ƒã€‚

# ä¸‰ã€å…±äº«ç»™å…¶ä»–äºº
#pip freeze > requirements.txt       # å¯¼å‡ºå·²å®‰è£…åº“çš„åˆ—è¡¨ï¼Œç”¨äºå…±äº«ã€‚
# (å°† requirements.txt æ–‡ä»¶å…±äº«ç»™ä»–äºº)
# (ä»–äººåœ¨è‡ªå·±çš„ç¯å¢ƒä¸­)
# source /path/to/their/env/bin/activate  # ä»–äººå…ˆæ¿€æ´»è‡ªå·±çš„æ–°ç¯å¢ƒ
#pip install -r requirements.txt     # å®‰è£…ä»–äººå…±äº«çš„ä¾èµ–åˆ—è¡¨ä¸­çš„æ‰€æœ‰åº“ã€‚
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é€šç”¨æœåŠ¡ç®¡ç†å·¥å…· v2.0 - å¢å¼ºç‰ˆ
# æ”¯æŒ: Node.jsã€Pythonã€Goã€äºŒè¿›åˆ¶ã€Shell ç­‰æ‰€æœ‰å¯æ‰§è¡Œç¨‹åº
# æ–°å¢: ç¯å¢ƒå˜é‡é…ç½®ã€èµ„æºé™åˆ¶ã€é…ç½®éªŒè¯ã€è·¯å¾„æ£€æŸ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SYSTEMD_DIR="/etc/systemd/system"
VERSION="2.0"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é…ç½®åŒºåŸŸ - åœ¨è¿™é‡Œæ·»åŠ ä½ çš„æ‰€æœ‰æœåŠ¡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

declare -A SERVICES

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# é…ç½®æ ¼å¼è¯´æ˜ï¼š
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 
# åŸºç¡€æ ¼å¼ï¼ˆ5ä¸ªå­—æ®µï¼Œä¸v1.0å®Œå…¨å…¼å®¹ï¼‰ï¼š
# SERVICES[æœåŠ¡å]="æè¿°|å·¥ä½œç›®å½•|å¯åŠ¨å‘½ä»¤|ç”¨æˆ·|é‡å¯å»¶è¿Ÿ"
#
# å®Œæ•´æ ¼å¼ï¼ˆ8ä¸ªå­—æ®µï¼Œæ”¯æŒé«˜çº§åŠŸèƒ½ï¼‰ï¼š
# SERVICES[æœåŠ¡å]="æè¿°|å·¥ä½œç›®å½•|å¯åŠ¨å‘½ä»¤|ç”¨æˆ·|é‡å¯å»¶è¿Ÿ|ç¯å¢ƒå˜é‡|èµ„æºé™åˆ¶|é¢å¤–é€‰é¡¹"
#
# å­—æ®µè¯´æ˜ï¼š
# 1. æè¿°       - æœåŠ¡æè¿°ï¼ˆå¿…å¡«ï¼‰
# 2. å·¥ä½œç›®å½•   - ç¨‹åºå·¥ä½œç›®å½•ï¼ˆå¿…å¡«ï¼‰
# 3. å¯åŠ¨å‘½ä»¤   - å®Œæ•´å¯åŠ¨å‘½ä»¤ï¼ˆå¿…å¡«ï¼‰
# 4. ç”¨æˆ·       - è¿è¡Œç”¨æˆ·ï¼ˆå¿…å¡«ï¼‰
# 5. é‡å¯å»¶è¿Ÿ   - å´©æºƒåé‡å¯ç­‰å¾…ç§’æ•°ï¼ˆå¿…å¡«ï¼‰
# 6. ç¯å¢ƒå˜é‡   - KEY1=VALUE1,KEY2=VALUE2ï¼ˆå¯é€‰ï¼Œç•™ç©ºç”¨é»˜è®¤ï¼‰
# 7. èµ„æºé™åˆ¶   - cpu=50%,memory=1G,tasks=100ï¼ˆå¯é€‰ï¼‰
# 8. é¢å¤–é€‰é¡¹   - type=forking,pidfile=/pathï¼ˆå¯é€‰ï¼‰
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¤ºä¾‹é…ç½® - å„ç§æœåŠ¡ç±»å‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ç¤ºä¾‹ 1: Node.js æœåŠ¡ï¼ˆåŸºç¡€æ ¼å¼ï¼‰
SERVICES[smart-monitor]="æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ|/root/camera-system|node server.js|root|10"

# ç¤ºä¾‹ 2: Node.js æœåŠ¡ï¼ˆå¸¦ç¯å¢ƒå˜é‡ï¼‰
#SERVICES[node-api]="Node APIæœåŠ¡|/root/api-server|node server.js|root|5|NODE_ENV=production,PORT=3000,DB_HOST=localhost"

# ç¤ºä¾‹ 3: Python æœåŠ¡ï¼ˆå¸¦èµ„æºé™åˆ¶ï¼‰
#SERVICES[python-app]="Pythonåº”ç”¨|/root/python-app|python3 app.py|root|10|PYTHONUNBUFFERED=1,ENV=prod|memory=512M,cpu=50%"

# ç¤ºä¾‹ 4: Go äºŒè¿›åˆ¶ç¨‹åºï¼ˆå®Œæ•´é…ç½®ï¼‰
#SERVICES[go-service]="GoæœåŠ¡|/opt/go-app|./main --config config.yaml|root|15|GIN_MODE=release,LOG_LEVEL=info|cpu=2,memory=1G"

# ç¤ºä¾‹ 5: Shell è„šæœ¬
#SERVICES[backup-script]="å¤‡ä»½è„šæœ¬|/root/scripts|bash backup.sh|root|30|BACKUP_DIR=/data/backup,RETENTION=7"

# ç¤ºä¾‹ 6: Java åº”ç”¨ï¼ˆå¸¦å†…å­˜é™åˆ¶ï¼‰
#SERVICES[java-app]="Javaåº”ç”¨|/opt/java-app|java -jar -Xmx512m app.jar|root|20|JAVA_HOME=/usr/lib/jvm/java-11|memory=1G"

# ç¤ºä¾‹ 7: ç³»ç»ŸäºŒè¿›åˆ¶ç¨‹åº
#SERVICES[custom-daemon]="è‡ªå®šä¹‰å®ˆæŠ¤è¿›ç¨‹|/usr/local/bin|./daemon --daemon|root|10||memory=256M"

# ç¤ºä¾‹ 8: PHP-FPM ç±»å‹æœåŠ¡
# SERVICES[php-worker]="PHP Worker|/var/www/worker|php worker.php|www-data|10|PHP_ENV=production"

# ç¤ºä¾‹ 9: Ruby åº”ç”¨
# SERVICES[ruby-app]="Rubyåº”ç”¨|/opt/ruby-app|bundle exec ruby app.rb|ruby|10|RACK_ENV=production,PORT=4567"

# ç¤ºä¾‹ 10: Rust äºŒè¿›åˆ¶
# SERVICES[rust-service]="RustæœåŠ¡|/opt/rust-app|./target/release/app|root|10|RUST_LOG=info|cpu=1,memory=256M"

# ç¤ºä¾‹ 11: Docker å®¹å™¨ï¼ˆå¦‚æœéœ€è¦ç”¨systemdç®¡ç†å®¹å™¨ï¼‰
# SERVICES[redis-docker]="Rediså®¹å™¨|/opt/redis|docker start -a redis-container|root|5||memory=256M|type=forking"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é…ç½®ç»“æŸ - ä¸‹é¢æ˜¯ç¨‹åºé€»è¾‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# æ‰“å°å‡½æ•°
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }
print_error() { echo -e "${RED}âŒ $1${NC}"; }
print_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
print_title() { echo -e "${CYAN}$1${NC}"; }
print_highlight() { echo -e "${MAGENTA}$1${NC}"; }

# ç»˜åˆ¶åˆ†éš”çº¿
draw_line() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    print_title "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    print_title "â•‘         é€šç”¨æœåŠ¡ç®¡ç†å·¥å…· v${VERSION}                         â•‘"
    print_title "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo -e "  ${CYAN}[1]${NC} ğŸ“¦ å®‰è£…æ‰€æœ‰æœåŠ¡"
    echo -e "  ${CYAN}[2]${NC} ğŸ—‘ï¸  ç§»é™¤æ‰€æœ‰æœåŠ¡"
    echo -e "  ${CYAN}[3]${NC} ğŸ“‹ æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo -e "  ${CYAN}[4]${NC} ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡"
    echo -e "  ${CYAN}[5]${NC} â–¶ï¸  å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    echo -e "  ${CYAN}[6]${NC} â¸ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo -e "  ${CYAN}[7]${NC} ğŸ“Š æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
    echo -e "  ${CYAN}[8]${NC} âš™ï¸  ç®¡ç†å•ä¸ªæœåŠ¡"
    echo -e "  ${CYAN}[9]${NC} ğŸ“ ç¼–è¾‘é…ç½®"
    echo -e "  ${CYAN}[10]${NC} ğŸ” éªŒè¯æ‰€æœ‰é…ç½®"
    echo -e "  ${CYAN}[11]${NC} ğŸ“ˆ èµ„æºä½¿ç”¨ç»Ÿè®¡"
    echo -e "  ${CYAN}[0]${NC} ğŸšª é€€å‡º"
    echo ""
    draw_line
    echo -n "è¯·é€‰æ‹©æ“ä½œ [0-11]: "
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
user_exists() {
    id "$1" >/dev/null 2>&1
}

# è§£æé…ç½®å­—æ®µ
parse_service_config() {
    local config=$1
    local field_count=$(echo "$config" | awk -F'|' '{print NF}')
    
    # å…¼å®¹æ—§æ ¼å¼ï¼ˆ5ä¸ªå­—æ®µï¼‰å’Œæ–°æ ¼å¼ï¼ˆ8ä¸ªå­—æ®µï¼‰
    if [ "$field_count" -ge 5 ]; then
        IFS='|' read -r description work_dir start_command user restart_sec env_vars resource_limits extra_options <<< "$config"
        echo "$description|$work_dir|$start_command|$user|$restart_sec|${env_vars:-}|${resource_limits:-}|${extra_options:-}"
    else
        print_error "é…ç½®æ ¼å¼é”™è¯¯ï¼Œè‡³å°‘éœ€è¦5ä¸ªå­—æ®µ"
        return 1
    fi
}

# æ™ºèƒ½æ£€æµ‹å‘½ä»¤ç±»å‹å¹¶æ·»åŠ é»˜è®¤ç¯å¢ƒå˜é‡
get_default_env_vars() {
    local command=$1
    local custom_env=$2
    local env_list=""
    
    # æ ¹æ®å‘½ä»¤ç±»å‹æ·»åŠ é»˜è®¤ç¯å¢ƒå˜é‡
    if [[ $command == *"npm"* ]] || [[ $command == *"node"* ]]; then
        env_list="NODE_ENV=production"
    elif [[ $command == *"python"* ]]; then
        env_list="PYTHONUNBUFFERED=1"
    elif [[ $command == *"go"* ]]; then
        env_list="GOGC=100"
    fi
    
    # åˆå¹¶è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
    if [ -n "$custom_env" ]; then
        if [ -n "$env_list" ]; then
            env_list="${env_list},${custom_env}"
        else
            env_list="$custom_env"
        fi
    fi
    
    echo "$env_list"
}

# ç”Ÿæˆç¯å¢ƒå˜é‡é…ç½®
generate_env_vars() {
    local env_vars=$1
    local output=""
    
    if [ -n "$env_vars" ]; then
        IFS=',' read -ra ENV_ARRAY <<< "$env_vars"
        for env in "${ENV_ARRAY[@]}"; do
            output="${output}Environment=${env}
"
        done
    fi
    
    # æ€»æ˜¯æ·»åŠ  PATH
    output="${output}Environment=PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin
"
    
    echo "$output"
}

# ç”Ÿæˆèµ„æºé™åˆ¶é…ç½®
generate_resource_limits() {
    local limits=$1
    local output=""
    
    if [ -n "$limits" ]; then
        IFS=',' read -ra LIMIT_ARRAY <<< "$limits"
        for limit in "${LIMIT_ARRAY[@]}"; do
            IFS='=' read -r key value <<< "$limit"
            case $key in
                cpu)
                    if [[ $value == *"%" ]]; then
                        output="${output}CPUQuota=${value}
"
                    else
                        # æ ¸å¿ƒæ•°è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                        percent=$((value * 100))
                        output="${output}CPUQuota=${percent}%
"
                    fi
                    ;;
                memory)
                    output="${output}MemoryLimit=${value}
"
                    ;;
                tasks)
                    output="${output}TasksMax=${value}
"
                    ;;
            esac
        done
    fi
    
    echo "$output"
}

# ç”Ÿæˆ systemd æœåŠ¡æ–‡ä»¶
generate_service() {
    local name=$1
    local description=$2
    local work_dir=$3
    local start_command=$4
    local user=$5
    local restart_sec=$6
    local env_vars=$7
    local resource_limits=$8
    local extra_options=$9
    
    # è·å–å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®
    local full_env_vars=$(get_default_env_vars "$start_command" "$env_vars")
    local env_config=$(generate_env_vars "$full_env_vars")
    local resource_config=$(generate_resource_limits "$resource_limits")
    
    # è§£æé¢å¤–é€‰é¡¹
    local service_type="simple"
    local pid_file=""
    
    if [ -n "$extra_options" ]; then
        IFS=',' read -ra OPTION_ARRAY <<< "$extra_options"
        for option in "${OPTION_ARRAY[@]}"; do
            IFS='=' read -r key value <<< "$option"
            case $key in
                type) service_type="$value" ;;
                pidfile) pid_file="$value" ;;
            esac
        done
    fi
    
    # ç”ŸæˆæœåŠ¡æ–‡ä»¶
    cat > "$SYSTEMD_DIR/${name}.service" << EOF
[Unit]
Description=${description}
After=network.target
StartLimitIntervalSec=60
StartLimitBurst=5

[Service]
Type=${service_type}
User=${user}
WorkingDirectory=${work_dir}
ExecStart=${start_command}
Restart=always
RestartSec=${restart_sec}
StandardOutput=journal
StandardError=journal
${env_config}${resource_config}EOF

    # æ·»åŠ  PID æ–‡ä»¶ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    if [ -n "$pid_file" ]; then
        echo "PIDFile=${pid_file}" >> "$SYSTEMD_DIR/${name}.service"
    fi
    
    # æ·»åŠ å°¾éƒ¨
    cat >> "$SYSTEMD_DIR/${name}.service" << EOF

[Install]
WantedBy=multi-user.target
EOF
}

# éªŒè¯å•ä¸ªæœåŠ¡é…ç½®
validate_service() {
    local name=$1
    local config=$2
    local errors=0
    
    IFS='|' read -r description work_dir start_command user restart_sec env_vars resource_limits extra_options <<< "$(parse_service_config "$config")"
    
    echo -e "${CYAN}æ£€æŸ¥æœåŠ¡: ${name}${NC}"
    
    # æ£€æŸ¥å·¥ä½œç›®å½•
    if [ ! -d "$work_dir" ]; then
        print_error "å·¥ä½œç›®å½•ä¸å­˜åœ¨: $work_dir"
        ((errors++))
    else
        print_success "å·¥ä½œç›®å½•å­˜åœ¨: $work_dir"
    fi
    
    # æ£€æŸ¥å¯åŠ¨å‘½ä»¤
    local cmd_first_word=$(echo "$start_command" | awk '{print $1}')
    
    # å¤„ç†ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
    if [[ $cmd_first_word == ./* ]] || [[ $cmd_first_word == /* ]]; then
        # è„šæœ¬æˆ–äºŒè¿›åˆ¶æ–‡ä»¶
        local full_path="$work_dir/$cmd_first_word"
        if [[ $cmd_first_word == /* ]]; then
            full_path="$cmd_first_word"
        fi
        
        if [ ! -f "$full_path" ]; then
            print_error "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $full_path"
            ((errors++))
        elif [ ! -x "$full_path" ]; then
            print_warning "æ–‡ä»¶å­˜åœ¨ä½†ä¸å¯æ‰§è¡Œ: $full_path"
            print_info "å»ºè®®æ‰§è¡Œ: chmod +x $full_path"
            ((errors++))
        else
            print_success "å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: $full_path"
        fi
    else
        # ç³»ç»Ÿå‘½ä»¤
        if ! command_exists "$cmd_first_word"; then
            print_error "å‘½ä»¤æœªæ‰¾åˆ°: $cmd_first_word"
            print_info "è¯·å®‰è£…ç›¸åº”è½¯ä»¶åŒ…"
            ((errors++))
        else
            print_success "å‘½ä»¤å¯ç”¨: $cmd_first_word"
        fi
    fi
    
    # æ£€æŸ¥ç”¨æˆ·
    if ! user_exists "$user"; then
        print_error "ç”¨æˆ·ä¸å­˜åœ¨: $user"
        ((errors++))
    else
        print_success "ç”¨æˆ·å­˜åœ¨: $user"
    fi
    
    # æ£€æŸ¥é‡å¯å»¶è¿Ÿ
    if ! [[ "$restart_sec" =~ ^[0-9]+$ ]]; then
        print_error "é‡å¯å»¶è¿Ÿå¿…é¡»æ˜¯æ•°å­—: $restart_sec"
        ((errors++))
    else
        print_success "é‡å¯å»¶è¿Ÿæœ‰æ•ˆ: ${restart_sec}ç§’"
    fi
    
    # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
    if [ -n "$env_vars" ]; then
        print_info "ç¯å¢ƒå˜é‡: $env_vars"
    fi
    
    if [ -n "$resource_limits" ]; then
        print_info "èµ„æºé™åˆ¶: $resource_limits"
    fi
    
    echo ""
    return $errors
}

# éªŒè¯æ‰€æœ‰æœåŠ¡é…ç½®
validate_all_configs() {
    clear
    print_title "ğŸ” éªŒè¯æ‰€æœ‰æœåŠ¡é…ç½®"
    draw_line
    echo ""
    
    if [ ${#SERVICES[@]} -eq 0 ]; then
        print_warning "é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æœåŠ¡ï¼"
        echo ""
        read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
        return
    fi
    
    local total_errors=0
    local service_count=0
    
    for service_name in "${!SERVICES[@]}"; do
        ((service_count++))
        validate_service "$service_name" "${SERVICES[$service_name]}"
        if [ $? -gt 0 ]; then
            ((total_errors++))
        fi
    done
    
    draw_line
    echo ""
    
    if [ $total_errors -eq 0 ]; then
        print_success "æ‰€æœ‰ $service_count ä¸ªæœåŠ¡é…ç½®éªŒè¯é€šè¿‡ï¼âœ¨"
    else
        print_error "å‘ç° $total_errors ä¸ªæœåŠ¡é…ç½®æœ‰é—®é¢˜"
        print_warning "è¯·ä¿®å¤ä¸Šè¿°é”™è¯¯åå†å®‰è£…æœåŠ¡"
    fi
    
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# å®‰è£…æ‰€æœ‰æœåŠ¡
install_all_services() {
    clear
    print_title "ğŸ“¦ å®‰è£…æ‰€æœ‰æœåŠ¡"
    draw_line
    echo ""
    
    if [ ${#SERVICES[@]} -eq 0 ]; then
        print_warning "é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æœåŠ¡ï¼è¯·å…ˆç¼–è¾‘è„šæœ¬æ·»åŠ æœåŠ¡ã€‚"
        echo ""
        read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
        return
    fi
    
    print_info "å¼€å§‹å®‰è£… ${#SERVICES[@]} ä¸ªæœåŠ¡..."
    echo ""
    
    for service_name in "${!SERVICES[@]}"; do
        local config_parsed=$(parse_service_config "${SERVICES[$service_name]}")
        IFS='|' read -r description work_dir start_command user restart_sec env_vars resource_limits extra_options <<< "$config_parsed"
        
        print_highlight "â”â”â” å®‰è£…: $service_name â”â”â”"
        print_info "æè¿°: $description"
        print_info "ç›®å½•: $work_dir"
        print_info "å‘½ä»¤: $start_command"
        
        # ç”ŸæˆæœåŠ¡æ–‡ä»¶
        generate_service "$service_name" "$description" "$work_dir" "$start_command" "$user" "$restart_sec" "$env_vars" "$resource_limits" "$extra_options"
        
        # é‡è½½é…ç½®
        systemctl daemon-reload
        
        # å¯ç”¨æœåŠ¡
        systemctl enable "${service_name}.service" &>/dev/null
        
        # å¯åŠ¨æœåŠ¡
        systemctl start "${service_name}.service"
        
        # æ£€æŸ¥çŠ¶æ€
        sleep 1
        if systemctl is-active --quiet "${service_name}.service"; then
            print_success "$service_name å¯åŠ¨æˆåŠŸ âœ“"
        else
            print_error "$service_name å¯åŠ¨å¤±è´¥ âœ—"
            print_warning "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: journalctl -u ${service_name}.service -n 20"
        fi
        echo ""
    done
    
    draw_line
    print_success "æ‰€æœ‰æœåŠ¡å®‰è£…å®Œæˆï¼"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# ç§»é™¤æ‰€æœ‰æœåŠ¡
remove_all_services() {
    clear
    print_title "ğŸ—‘ï¸  ç§»é™¤æ‰€æœ‰æœåŠ¡"
    draw_line
    echo ""
    
    print_warning "æ­¤æ“ä½œå°†ç§»é™¤æ‰€æœ‰å·²é…ç½®çš„æœåŠ¡ï¼"
    echo ""
    read -p "ç¡®è®¤è¦ç§»é™¤æ‰€æœ‰æœåŠ¡å—ï¼Ÿ(y/N): " confirm
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        print_info "å·²å–æ¶ˆæ“ä½œ"
        sleep 1
        return
    fi
    
    echo ""
    
    for service_name in "${!SERVICES[@]}"; do
        print_info "ç§»é™¤æœåŠ¡: $service_name"
        
        systemctl stop "${service_name}.service" &>/dev/null
        systemctl disable "${service_name}.service" &>/dev/null
        rm -f "$SYSTEMD_DIR/${service_name}.service"
        
        print_success "$service_name å·²ç§»é™¤"
    done
    
    systemctl daemon-reload
    
    echo ""
    print_success "æ‰€æœ‰æœåŠ¡ç§»é™¤å®Œæˆï¼"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
view_services_status() {
    clear
    print_title "ğŸ“‹ æœåŠ¡çŠ¶æ€"
    draw_line
    echo ""
    
    printf "%-25s %-15s %-40s\n" "æœåŠ¡åç§°" "çŠ¶æ€" "æè¿°"
    draw_line
    
    for service_name in "${!SERVICES[@]}"; do
        local config_parsed=$(parse_service_config "${SERVICES[$service_name]}")
        IFS='|' read -r description _ _ _ _ _ _ _ <<< "$config_parsed"
        
        if systemctl is-active --quiet "${service_name}.service"; then
            status="${GREEN}â— è¿è¡Œä¸­${NC}"
        elif systemctl is-enabled --quiet "${service_name}.service" 2>/dev/null; then
            status="${YELLOW}â—‹ å·²åœæ­¢${NC}"
        else
            status="${RED}â—‹ æœªå®‰è£…${NC}"
        fi
        
        printf "%-25s %-24b %-40s\n" "$service_name" "$status" "$description"
    done
    
    draw_line
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# é‡å¯æ‰€æœ‰æœåŠ¡
restart_all_services() {
    clear
    print_title "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡"
    draw_line
    echo ""
    
    for service_name in "${!SERVICES[@]}"; do
        if systemctl is-enabled --quiet "${service_name}.service" 2>/dev/null; then
            print_info "é‡å¯æœåŠ¡: $service_name"
            systemctl restart "${service_name}.service"
            
            sleep 1
            if systemctl is-active --quiet "${service_name}.service"; then
                print_success "$service_name é‡å¯æˆåŠŸ"
            else
                print_error "$service_name é‡å¯å¤±è´¥"
            fi
        else
            print_warning "$service_name æœªå®‰è£…ï¼Œè·³è¿‡"
        fi
    done
    
    echo ""
    print_success "æ‰€æœ‰æœåŠ¡é‡å¯å®Œæˆï¼"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start_all_services() {
    clear
    print_title "â–¶ï¸  å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    draw_line
    echo ""
    
    for service_name in "${!SERVICES[@]}"; do
        if systemctl is-enabled --quiet "${service_name}.service" 2>/dev/null; then
            print_info "å¯åŠ¨æœåŠ¡: $service_name"
            systemctl start "${service_name}.service"
            
            sleep 1
            if systemctl is-active --quiet "${service_name}.service"; then
                print_success "$service_name å¯åŠ¨æˆåŠŸ"
            else
                print_error "$service_name å¯åŠ¨å¤±è´¥"
            fi
        else
            print_warning "$service_name æœªå®‰è£…ï¼Œè·³è¿‡"
        fi
    done
    
    echo ""
    print_success "æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop_all_services() {
    clear
    print_title "â¸ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡"
    draw_line
    echo ""
    
    for service_name in "${!SERVICES[@]}"; do
        if systemctl is-active --quiet "${service_name}.service"; then
            print_info "åœæ­¢æœåŠ¡: $service_name"
            systemctl stop "${service_name}.service"
            print_success "$service_name å·²åœæ­¢"
        else
            print_warning "$service_name æœªè¿è¡Œï¼Œè·³è¿‡"
        fi
    done
    
    echo ""
    print_success "æ‰€æœ‰æœåŠ¡åœæ­¢å®Œæˆï¼"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
view_service_logs() {
    clear
    print_title "ğŸ“Š æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
    draw_line
    echo ""
    
    local i=1
    local service_array=()
    
    for service_name in "${!SERVICES[@]}"; do
        service_array+=("$service_name")
        local config_parsed=$(parse_service_config "${SERVICES[$service_name]}")
        IFS='|' read -r description _ _ _ _ _ _ _ <<< "$config_parsed"
        echo -e "  ${CYAN}[$i]${NC} $service_name - $description"
        ((i++))
    done
    
    echo -e "  ${CYAN}[0]${NC} è¿”å›ä¸»èœå•"
    echo ""
    draw_line
    echo -n "é€‰æ‹©è¦æŸ¥çœ‹æ—¥å¿—çš„æœåŠ¡ [0-$((${#service_array[@]}))]: "
    read choice
    
    if [[ $choice -eq 0 ]]; then
        return
    fi
    
    if [[ $choice -gt 0 && $choice -le ${#service_array[@]} ]]; then
        local selected_service="${service_array[$((choice-1))]}"
        clear
        print_title "ğŸ“Š $selected_service å®æ—¶æ—¥å¿— (Ctrl+C é€€å‡º)"
        draw_line
        echo ""
        journalctl -u "${selected_service}.service" -f
    else
        print_error "æ— æ•ˆçš„é€‰æ‹©"
        sleep 1
    fi
}

# ç®¡ç†å•ä¸ªæœåŠ¡
manage_single_service() {
    clear
    print_title "âš™ï¸  ç®¡ç†å•ä¸ªæœåŠ¡"
    draw_line
    echo ""
    
    local i=1
    local service_array=()
    
    for service_name in "${!SERVICES[@]}"; do
        service_array+=("$service_name")
        local config_parsed=$(parse_service_config "${SERVICES[$service_name]}")
        IFS='|' read -r description _ _ _ _ _ _ _ <<< "$config_parsed"
        
        if systemctl is-active --quiet "${service_name}.service"; then
            status="${GREEN}è¿è¡Œä¸­${NC}"
        else
            status="${RED}å·²åœæ­¢${NC}"
        fi
        
        printf "  ${CYAN}[%d]${NC} %-25s - %b - %s\n" "$i" "$service_name" "$status" "$description"
        ((i++))
    done
    
    echo -e "  ${CYAN}[0]${NC} è¿”å›ä¸»èœå•"
    echo ""
    draw_line
    echo -n "é€‰æ‹©æœåŠ¡ [0-$((${#service_array[@]}))]: "
    read choice
    
    if [[ $choice -eq 0 ]]; then
        return
    fi
    
    if [[ $choice -gt 0 && $choice -le ${#service_array[@]} ]]; then
        local selected_service="${service_array[$((choice-1))]}"
        manage_service_menu "$selected_service"
    else
        print_error "æ— æ•ˆçš„é€‰æ‹©"
        sleep 1
    fi
}

# å•ä¸ªæœåŠ¡ç®¡ç†èœå•
manage_service_menu() {
    local service_name=$1
    
    while true; do
        clear
        print_title "âš™ï¸  ç®¡ç†æœåŠ¡: $service_name"
        draw_line
        echo ""
        
        if systemctl is-active --quiet "${service_name}.service"; then
            echo -e "  å½“å‰çŠ¶æ€: ${GREEN}â— è¿è¡Œä¸­${NC}"
        else
            echo -e "  å½“å‰çŠ¶æ€: ${RED}â—‹ å·²åœæ­¢${NC}"
        fi
        
        echo ""
        echo -e "  ${CYAN}[1]${NC} å¯åŠ¨æœåŠ¡"
        echo -e "  ${CYAN}[2]${NC} åœæ­¢æœåŠ¡"
        echo -e "  ${CYAN}[3]${NC} é‡å¯æœåŠ¡"
        echo -e "  ${CYAN}[4]${NC} æŸ¥çœ‹çŠ¶æ€"
        echo -e "  ${CYAN}[5]${NC} æŸ¥çœ‹æ—¥å¿— (æœ€è¿‘50è¡Œ)"
        echo -e "  ${CYAN}[6]${NC} å®æ—¶æ—¥å¿—"
        echo -e "  ${CYAN}[7]${NC} æŸ¥çœ‹æœåŠ¡é…ç½®"
        echo -e "  ${CYAN}[0]${NC} è¿”å›ä¸Šçº§èœå•"
        echo ""
        draw_line
        echo -n "è¯·é€‰æ‹©æ“ä½œ [0-7]: "
        read sub_choice
        
        case $sub_choice in
            1)
                systemctl start "${service_name}.service"
                print_success "å·²å¯åŠ¨ $service_name"
                sleep 1
                ;;
            2)
                systemctl stop "${service_name}.service"
                print_success "å·²åœæ­¢ $service_name"
                sleep 1
                ;;
            3)
                systemctl restart "${service_name}.service"
                print_success "å·²é‡å¯ $service_name"
                sleep 1
                ;;
            4)
                echo ""
                systemctl status "${service_name}.service"
                echo ""
                read -p "æŒ‰ Enter é”®ç»§ç»­..."
                ;;
            5)
                clear
                journalctl -u "${service_name}.service" -n 50 --no-pager
                echo ""
                read -p "æŒ‰ Enter é”®ç»§ç»­..."
                ;;
            6)
                clear
                print_title "ğŸ“Š $service_name å®æ—¶æ—¥å¿— (Ctrl+C é€€å‡º)"
                draw_line
                echo ""
                journalctl -u "${service_name}.service" -f
                ;;
            7)
                clear
                print_title "ğŸ“„ $service_name æœåŠ¡é…ç½®"
                draw_line
                echo ""
                if [ -f "$SYSTEMD_DIR/${service_name}.service" ]; then
                    cat "$SYSTEMD_DIR/${service_name}.service"
                else
                    print_error "æœåŠ¡é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
                fi
                echo ""
                read -p "æŒ‰ Enter é”®ç»§ç»­..."
                ;;
            0)
                return
                ;;
            *)
                print_error "æ— æ•ˆçš„é€‰æ‹©"
                sleep 1
                ;;
        esac
    done
}

# èµ„æºä½¿ç”¨ç»Ÿè®¡
view_resource_usage() {
    clear
    print_title "ğŸ“ˆ æœåŠ¡èµ„æºä½¿ç”¨ç»Ÿè®¡"
    draw_line
    echo ""
    
    if ! command_exists systemd-cgtop; then
        print_error "systemd-cgtop å‘½ä»¤ä¸å¯ç”¨"
        echo ""
        read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
        return
    fi
    
    print_info "æ­£åœ¨æ”¶é›†èµ„æºä½¿ç”¨æ•°æ®..."
    echo ""
    
    printf "%-25s %-10s %-10s %-10s %s\n" "æœåŠ¡åç§°" "çŠ¶æ€" "CPU" "å†…å­˜" "ä»»åŠ¡æ•°"
    draw_line
    
    for service_name in "${!SERVICES[@]}"; do
        if systemctl is-active --quiet "${service_name}.service"; then
            # è·å– CPU ä½¿ç”¨ç‡
            local cpu_usage=$(systemctl show "${service_name}.service" --property=CPUUsageNSec | cut -d= -f2)
            
            # è·å–å†…å­˜ä½¿ç”¨
            local memory_usage=$(systemctl show "${service_name}.service" --property=MemoryCurrent | cut -d= -f2)
            
            # è·å–ä»»åŠ¡æ•°
            local tasks=$(systemctl show "${service_name}.service" --property=TasksCurrent | cut -d= -f2)
            
            # æ ¼å¼åŒ–å†…å­˜æ˜¾ç¤º
            if [ "$memory_usage" != "[not set]" ] && [ -n "$memory_usage" ] && [ "$memory_usage" != "0" ]; then
                memory_mb=$((memory_usage / 1024 / 1024))
                memory_display="${memory_mb}MB"
            else
                memory_display="N/A"
            fi
            
            # æ ¼å¼åŒ–ä»»åŠ¡æ•°
            if [ "$tasks" == "[not set]" ] || [ -z "$tasks" ]; then
                tasks="N/A"
            fi
            
            printf "%-25s %-10s %-10s %-10s %s\n" \
                "$service_name" \
                "è¿è¡Œä¸­" \
                "N/A" \
                "$memory_display" \
                "$tasks"
        else
            printf "%-25s %-10s %-10s %-10s %s\n" \
                "$service_name" \
                "å·²åœæ­¢" \
                "-" \
                "-" \
                "-"
        fi
    done
    
    draw_line
    echo ""
    print_info "æç¤º: ä½¿ç”¨ 'systemd-cgtop' å‘½ä»¤å¯æŸ¥çœ‹æ›´è¯¦ç»†çš„å®æ—¶èµ„æºç»Ÿè®¡"
    echo ""
    read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
}

# ç¼–è¾‘é…ç½®
edit_config() {
    clear
    print_title "ğŸ“ ç¼–è¾‘é…ç½®"
    draw_line
    echo ""
    print_info "å³å°†æ‰“å¼€é…ç½®ç¼–è¾‘..."
    echo ""
    print_warning "è¯·ç¼–è¾‘è„šæœ¬ä¸­çš„ SERVICES é…ç½®åŒºåŸŸ"
    print_warning "æ ¼å¼: SERVICES[åç§°]=\"æè¿°|å·¥ä½œç›®å½•|å¯åŠ¨å‘½ä»¤|ç”¨æˆ·|é‡å¯å»¶è¿Ÿ|ç¯å¢ƒå˜é‡|èµ„æºé™åˆ¶|é€‰é¡¹\""
    echo ""
    print_info "é…ç½®ç¤ºä¾‹ï¼š"
    echo ""
    echo "  # åŸºç¡€æ ¼å¼ï¼ˆ5ä¸ªå­—æ®µï¼‰"
    echo "  SERVICES[app1]=\"åº”ç”¨1|/root/app1|npm start|root|10\""
    echo ""
    echo "  # å¸¦ç¯å¢ƒå˜é‡ï¼ˆ6ä¸ªå­—æ®µï¼‰"
    echo "  SERVICES[app2]=\"åº”ç”¨2|/root/app2|node app.js|root|10|PORT=3000,ENV=prod\""
    echo ""
    echo "  # å¸¦èµ„æºé™åˆ¶ï¼ˆ7ä¸ªå­—æ®µï¼‰"
    echo "  SERVICES[app3]=\"åº”ç”¨3|/root/app3|python3 app.py|root|10|ENV=prod|memory=1G,cpu=50%\""
    echo ""
    read -p "æŒ‰ Enter é”®ç”¨ç¼–è¾‘å™¨æ‰“å¼€æ­¤è„šæœ¬ï¼Œæˆ– Ctrl+C å–æ¶ˆ..."
    
    # å°è¯•ä½¿ç”¨æœ€é€‚åˆçš„ç¼–è¾‘å™¨
    if command_exists nano; then
        nano "$0"
    elif command_exists vi; then
        vi "$0"
    elif command_exists vim; then
        vim "$0"
    else
        print_error "æœªæ‰¾åˆ°å¯ç”¨çš„ç¼–è¾‘å™¨ (nano/vi/vim)"
        echo ""
        read -p "æŒ‰ Enter é”®è¿”å›ä¸»èœå•..."
        return
    fi
    
    print_success "é…ç½®å·²æ›´æ–°ï¼è¯·é‡æ–°è¿è¡Œè„šæœ¬ä½¿é…ç½®ç”Ÿæ•ˆã€‚"
    echo ""
    read -p "æŒ‰ Enter é”®é€€å‡º..."
    exit 0
}

# ä¸»å¾ªç¯
main() {
    # æ£€æŸ¥æƒé™
    if [ "$EUID" -ne 0 ]; then
        print_error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬: sudo $0"
        exit 1
    fi
    
    # æ£€æŸ¥ systemd
    if ! command_exists systemctl; then
        print_error "æ­¤è„šæœ¬éœ€è¦ systemd æ”¯æŒ"
        exit 1
    fi
    
    while true; do
        show_menu
        read choice
        
        case $choice in
            1) install_all_services ;;
            2) remove_all_services ;;
            3) view_services_status ;;
            4) restart_all_services ;;
            5) start_all_services ;;
            6) stop_all_services ;;
            7) view_service_logs ;;
            8) manage_single_service ;;
            9) edit_config ;;
            10) validate_all_configs ;;
            11) view_resource_usage ;;
            0) 
                clear
                print_success "æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼ğŸ‘‹"
                exit 0
                ;;
            *)
                print_error "æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥"
                sleep 1
                ;;
        esac
    done
}

# è¿è¡Œä¸»ç¨‹åº
main
