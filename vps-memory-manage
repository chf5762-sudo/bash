#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 权限检查
if [ "$EUID" -ne 0 ]; then 
  echo -e "${RED}错误：请使用 root 权限运行此脚本。${NC}"
  exit 1
fi

echo -e "${BLUE}================================================${NC}"
echo -e "${GREEN}         Docker 内存限额管理工具               ${NC}"
echo -e "${BLUE}================================================${NC}"

# 获取运行中的容器列表
mapfile -t containers < <(docker ps --format "{{.Names}}")

if [ ${#containers[@]} -eq 0 ]; then
    echo -e "${RED}未发现运行中的 Docker 容器。${NC}"
    exit 1
fi

# 列出容器
echo -e "序号\t容器名称"
for i in "${!containers[@]}"; do
    echo -e "$((i+1))\t${containers[$i]}"
done
echo -e "------------------------------------------------"

echo -n "请选择要操作的容器序号: "
read choice
container_name=${containers[$((choice-1))]}

if [ -z "$container_name" ]; then
    echo -e "${RED}选择无效。${NC}"
    exit 1
fi

echo -e "\n${YELLOW}当前选定: $container_name${NC}"
echo -e "1) 设置内存限额 (最高 1000M)"
echo -e "2) 解除限额 (恢复系统默认)"
echo -n "请选择操作 [1-2]: "
read mode

case $mode in
    1)
        echo -n "请输入限制额度 (例如 500M, 800M, 1000M): "
        read mem_val
        
        # 简单校验：提取数字部分
        num_val=$(echo $mem_val | grep -oE '[0-9]+')
        
        if [ "$num_val" -gt 1000 ]; then
            echo -e "${RED}警告：输入值超过 1000M，为了系统安全，已自动调整为 1000M。${NC}"
            mem_val="1000M"
        fi

        echo -e "${YELLOW}正在应用限制 $mem_val 并重启容器...${NC}"
        # --memory-swap -1 表示不限制虚拟内存，只限制物理内存，防止直接崩溃
        docker update --memory "$mem_val" --memory-swap -1 "$container_name"
        docker restart "$container_name"
        echo -e "${GREEN}成功！$container_name 现在限额为 $mem_val。${NC}"
        ;;
    2)
        echo -e "${YELLOW}正在解除 $container_name 的所有内存限制...${NC}"
        # 设置为 0 或不指定通常恢复默认，update 命令中使用足够大的值或特定参数重置
        # 这里的标准做法是取消限制（设置一个极大的值或重置内存配置）
        docker update --memory 0 --memory-swap 0 "$container_name" 2>/dev/null || \
        docker update --memory 512g --memory-swap -1 "$container_name"
        
        docker restart "$container_name"
        echo -e "${GREEN}解除成功！容器已恢复无限制模式。${NC}"
        ;;
    *)
        echo -e "${RED}无效选项。${NC}"
        ;;
esac

echo -e "\n${BLUE}当前容器状态 (docker stats):${NC}"
docker stats "$container_name" --no-stream
