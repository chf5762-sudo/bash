#!/bin/bash

# X Server 一键修复脚本
# 解决 "Cannot run in framebuffer mode" 错误

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  X Server 一键修复工具${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}✗ 需要 root 权限${NC}"
    echo "请使用: sudo $0"
    exit 1
fi

echo -e "${CYAN}[1/6] 停止所有 X 进程${NC}"
pkill -9 X 2>/dev/null
pkill -9 xinit 2>/dev/null
sleep 1
echo -e "${GREEN}✓ 完成${NC}"
echo ""

echo -e "${CYAN}[2/6] 清理锁文件${NC}"
rm -f /tmp/.X0-lock
rm -f /tmp/.X11-unix/X0
echo -e "${GREEN}✓ 完成${NC}"
echo ""

echo -e "${CYAN}[3/6] 检测显示设备${NC}"
DRM_EXISTS=0
FB_EXISTS=0

if [ -e "/dev/dri/card0" ]; then
    echo -e "${GREEN}✓ 检测到 DRM 设备: /dev/dri/card0${NC}"
    DRM_EXISTS=1
fi

if [ -e "/dev/fb0" ]; then
    echo -e "${GREEN}✓ 检测到 Framebuffer: /dev/fb0${NC}"
    FB_NAME=$(cat /sys/class/graphics/fb0/name 2>/dev/null)
    echo "  驱动名称: $FB_NAME"
    FB_EXISTS=1
fi

if [ $DRM_EXISTS -eq 0 ] && [ $FB_EXISTS -eq 0 ]; then
    echo -e "${RED}✗ 错误：没有检测到任何显示设备！${NC}"
    echo ""
    echo "可能原因："
    echo "  1. 显卡驱动未安装"
    echo "  2. HDMI 未连接"
    echo "  3. 硬件不支持"
    exit 1
fi
echo ""

echo -e "${CYAN}[4/6] 安装必要驱动${NC}"
apt-get install -y \
    xserver-xorg-video-modesetting \
    xserver-xorg-video-fbdev \
    xserver-xorg-video-fbturbo \
    -qq 2>/dev/null

if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ 驱动安装/更新完成${NC}"
else
    echo -e "${YELLOW}⚠ 驱动可能已安装${NC}"
fi
echo ""

echo -e "${CYAN}[5/6] 创建配置文件${NC}"

# 创建配置目录
mkdir -p /etc/X11/xorg.conf.d

# 清理旧配置
rm -f /etc/X11/xorg.conf.d/20-*.conf 2>/dev/null
rm -f /etc/X11/xorg.conf.d/99-*.conf 2>/dev/null

CONFIG_TYPE=""

if [ $DRM_EXISTS -eq 1 ]; then
    # 使用 DRM 模式（推荐）
    echo "创建 DRM 配置..."
    cat > /etc/X11/xorg.conf.d/20-graphics.conf << 'EOF'
Section "Device"
    Identifier "Primary"
    Driver "modesetting"
    Option "kmsdev" "/dev/dri/card0"
    Option "SWcursor" "true"
    Option "AccelMethod" "none"
EndSection

Section "Screen"
    Identifier "Screen0"
    Device "Primary"
EndSection
EOF
    CONFIG_TYPE="DRM (modesetting)"
    
elif [ $FB_EXISTS -eq 1 ]; then
    # 使用 Framebuffer 模式
    echo "创建 Framebuffer 配置..."
    cat > /etc/X11/xorg.conf.d/20-graphics.conf << 'EOF'
Section "Device"
    Identifier "Primary"
    Driver "fbdev"
    Option "fbdev" "/dev/fb0"
    Option "ShadowFB" "false"
EndSection

Section "Screen"
    Identifier "Screen0"
    Device "Primary"
EndSection
EOF
    CONFIG_TYPE="Framebuffer (fbdev)"
fi

# 设置正确权限
chmod 644 /etc/X11/xorg.conf.d/20-graphics.conf

echo -e "${GREEN}✓ 配置文件已创建${NC}"
echo "  类型: $CONFIG_TYPE"
echo "  位置: /etc/X11/xorg.conf.d/20-graphics.conf"
echo ""

echo -e "${CYAN}配置文件内容：${NC}"
echo "----------------------------------------"
cat /etc/X11/xorg.conf.d/20-graphics.conf
echo "----------------------------------------"
echo ""

echo -e "${CYAN}[6/6] 验证配置${NC}"

# 验证配置文件
if [ -f /etc/X11/xorg.conf.d/20-graphics.conf ]; then
    FILE_SIZE=$(stat -c%s /etc/X11/xorg.conf.d/20-graphics.conf)
    if [ $FILE_SIZE -gt 50 ]; then
        echo -e "${GREEN}✓ 配置文件验证通过 (大小: $FILE_SIZE 字节)${NC}"
    else
        echo -e "${RED}✗ 配置文件异常 (大小过小)${NC}"
        exit 1
    fi
else
    echo -e "${RED}✗ 配置文件创建失败${NC}"
    exit 1
fi
echo ""

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  修复完成！${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

echo -e "${YELLOW}硬件状态：${NC}"
[ $DRM_EXISTS -eq 1 ] && echo -e "  ${GREEN}✓${NC} DRM 设备可用"
[ $FB_EXISTS -eq 1 ] && echo -e "  ${GREEN}✓${NC} Framebuffer 可用"
echo ""

echo -e "${YELLOW}配置状态：${NC}"
echo "  驱动类型: $CONFIG_TYPE"
echo "  配置文件: /etc/X11/xorg.conf.d/20-graphics.conf"
echo ""

echo -e "${YELLOW}下一步操作：${NC}"
echo ""
echo -e "${GREEN}方法 1: 直接启动图形界面（测试）${NC}"
echo "  startx"
echo ""
echo -e "${GREEN}方法 2: 使用快捷命令${NC}"
echo "  start-gui"
echo ""
echo -e "${GREEN}方法 3: 设置开机自动启动图形界面${NC}"
echo "  sudo systemctl set-default graphical.target"
echo "  sudo reboot"
echo ""

echo -e "${CYAN}日志位置：${NC}"
echo "  X Server 日志: /var/log/Xorg.0.log"
echo "  查看错误: grep EE /var/log/Xorg.0.log"
echo ""

read -p "是否立即启动图形界面测试? (y/n): " test_start

if [ "$test_start" = "y" ] || [ "$test_start" = "Y" ]; then
    echo ""
    echo -e "${GREEN}正在启动图形界面...${NC}"
    echo -e "${YELLOW}(如果黑屏超过 30 秒，按 Ctrl+Alt+F2 返回终端)${NC}"
    echo ""
    sleep 2
    startx
else
    echo ""
    echo -e "${GREEN}修复完成！${NC}"
    echo "准备好后运行: ${CYAN}startx${NC}"
    echo ""
fi
